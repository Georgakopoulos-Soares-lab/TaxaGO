<!DOCTYPE html>
<html>
<head>
    <title>TaxaGO - Analysis Results</title>
    <style>
        :root {
            --primary-color: #4f46e5;
            --primary-hover: #4338ca;
            --background-color: #f8fafc;
            --card-background: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-tertiary: #94a3b8;  
            --border-color: #e2e8f0;
            --success-color: #10b981;
            --error-color: #ef4444;
        }

        iframe.plot-frame {
            transition: opacity 0.25s ease-in-out;
        }

        html {
            overflow-y: scroll;
            scrollbar-gutter: stable both-edges;
        }

        body {
            margin: 0;
            padding: 20px;
            font-family: system-ui, -apple-system, sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            min-width: 320px;
            overflow-x: hidden;
            width: 100vw;
            box-sizing: border-box;
            padding-right: calc(100vw - 100%);
        }

        ::-webkit-scrollbar {
            width: 10px;
            background-color: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background-color: rgba(100, 116, 139, 0.2);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background-color: rgba(100, 116, 139, 0.3);
        }

        * {
            scrollbar-width: thin;
            scrollbar-color: rgba(100, 116, 139, 0.2) transparent;
        }

        .main-container {
            width: 100%;
            max-width: 90%;
            margin: 0 auto;
            padding: 1rem;
            box-sizing: border-box;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 65% 35%;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .results-table-container {
            width: 100%;
            margin-bottom: 2rem;
            background: var(--card-background);
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        .results-table-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 12px -1px rgb(0 0 0 / 0.15);
        }

        .table-scroll-container {
            overflow: auto;
            position: relative;
            max-height: 500px;
            width: 100%;
            overflow-x: overlay;
            overflow-y: overlay;
            scrollbar-gutter: stable;
            margin-top: 0;
        }

        .plot-container {
            background: var(--card-background);
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            height: 600px;
            display: flex;
            flex-direction: column;
        }

        .plot-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 12px -1px rgb(0 0 0 / 0.15);
        }

        .title {
            text-align: center;
            color: var(--text-primary);
            font-size: 2.25rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .subtitle {
            text-align: center;
            color: var(--text-secondary);
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 2.5rem;
        }

        .change-results-button {
            display: block;
            margin: 0 auto 2.5rem auto;
            padding: 0.75rem 1.5rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
            text-decoration: none;
        }

        .change-results-button:hover {
            background-color: var(--primary-hover);
        }

        .results-table {
            width: 100%;
            border-spacing: 0;
            border-collapse: collapse;
            table-layout: fixed;
        }

        .results-table th,
        .results-table td {
            padding: 0.625rem 0.75rem;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: normal;
            min-width: 120px;
            word-wrap: break-word;
            max-height: none;
            vertical-align: middle;
            line-height: 1.4;
        }

        .results-table th[data-type="id"],
        .results-table td[data-type="id"] {
            width: 150px;
            white-space: nowrap;
            text-overflow: clip;
            overflow: visible;
        }

        .results-table th[data-type="name"],
        .results-table td[data-type="name"] {
            width: 200px;
        }

        .results-table th[data-type="numeric"],
        .results-table td[data-type="numeric"] {
            width: 120px;
            white-space: nowrap;
        }

        .results-table th[data-type="description"],
        .results-table td[data-type="description"] {
            width: 300px;
        }

        .results-table th {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .results-table thead {
            position: sticky;
            top: 0;
            background-color: var(--card-background);
            z-index: 10;
        }

        .results-table th:first-child,
        .results-table td:first-child {
            position: sticky;
            left: 0;
            background-color: var(--card-background);
            z-index: 5;
            box-shadow: 2px 0 4px -2px rgba(0, 0, 0, 0.1);
        }

        .results-table thead th:first-child {
            position: sticky;
            left: 0;
            z-index: 15;
            background-color: var(--card-background);
            box-shadow: 
                2px 0 4px -2px rgba(0, 0, 0, 0.1),
                0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        .results-table thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: var(--card-background);
            box-shadow: 0 1px 2px -1px rgba(0, 0, 0, 0.1);
        }

        .results-table tr:hover td:first-child {
            background-color: var(--background-color);
        }

        .table-container {
            max-height: calc(90vh - 150px);
            overflow-y: auto;
            margin-top: 1rem;
        }

        .results-table th {
            padding: 0.5rem 0.5rem;
            font-size: 0.875rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
            vertical-align: middle;
            height: 2.5rem;
            line-height: 1.2;
        }

        .results-table td {
            padding: 0.625rem 0.75rem;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-secondary);
            text-align: center;  
        }

        .results-table tr {
            transition: background-color 0.2s ease;
        }

        .results-table tr:hover {
            background-color: var(--background-color);
        }

        .go-term {
            color: var(--primary-color);
        }

        .scientific {
            color: var(--text-secondary);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        body.modal-open {
            overflow: hidden !important;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        .modal-content {
            background: var(--card-background);
            margin: auto;
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 1400px;
            position: relative;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
            max-height: 90vh;
            overflow-y: hidden; 
            box-sizing: border-box;
        }

        .modal.active {
            display: flex;
            opacity: 1;
        }

        .close-modal {
            position: absolute;
            right: 1.5rem;
            top: 1.5rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.2s ease;
        }

        .close-modal:hover {
            color: var(--text-primary);
        }

        .show-all-button {
            display: block;
            width: 100%;
            padding: 1rem;
            margin-top: 1rem;
            background: var(--background-color);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .show-all-button:hover {
            background: var(--card-background);
            color: var(--text-primary);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .sortable-header {
            cursor: pointer;
            position: relative;
            padding-right: 1.5rem;
            user-select: none;
            white-space: nowrap;
            text-align: center;
        }

        .sort-arrow {
            position: absolute;
            right: 0.25rem;
            top: 50%;
            transform: translateY(-50%);
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            opacity: 0.3;
            transition: opacity 0.2s ease;
            width: 8px;
            height: 16px;
            pointer-events: none;
        }

        .sort-arrow.active {
            opacity: 1;
            color: var(--primary-color);
        }

        .sort-arrow::before,
        .sort-arrow::after {
            content: '';
            position: absolute;
            display: block;
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            pointer-events: none;
        }

        .sort-arrow::before {
            top: 0;
            border-bottom: 4px solid currentColor;
        }

        .sort-arrow::after {
            bottom: 0;
            border-top: 4px solid currentColor;
        }

        .sort-arrow.asc::before {
            border-bottom-color: var(--primary-color);
            opacity: 1;
        }

        .sort-arrow.asc::after {
            opacity: 0.3;
        }

        .sort-arrow.desc::before {
            opacity: 0.3;
        }

        .sort-arrow.desc::after {
            border-top-color: var(--primary-color);
            opacity: 1;
        }

        .go-term-link {
            color: var(--primary-color);
            text-decoration: none;
            transition: color 0.2s ease;
            position: relative;
            text-align: left;
            display: inline-block;
        }

        .go-term-link:hover {
            color: var(--primary-hover);
        }

        .go-term-link::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 1px;
            bottom: -1px;
            left: 0;
            background-color: var(--primary-hover);
            transform: scaleX(0);
            transform-origin: bottom right;
            transition: transform 0.3s ease;
        }

        .go-term-link:hover::after {
            transform: scaleX(1);
            transform-origin: bottom left;
        }

        .function-buttons-container {
            margin-bottom: 2rem;
        }

        .primary-actions {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            justify-content: center;
        }

        .secondary-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
        }

        .primary-button {
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            min-width: 180px;
            justify-content: center;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .primary-button:disabled {
            background-color: rgb(79 70 229 / 0.5) !important;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .primary-button:not(:disabled) {
            background-color: var(--primary-color);
        }

        .primary-button:not(:disabled):hover {
            background-color: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 8px -1px rgb(79 70 229 / 0.3);
        }

        .primary-button:not(:disabled):active {
            transform: translateY(0);
        }

        .primary-button .spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 1.5rem;
            height: 1.5rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
            display: none;
        }

        .primary-button.loading .spinner {
            display: block;
        }

        .primary-button.loading .btn-text {
            visibility: hidden;
        }

        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        .download-button {
            background-color: var(--primary-color);
        }

        .download-button:hover {
            background-color: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 8px -1px rgb(79 70 229 / 0.3);
        }

        .download-button:active {
            transform: translateY(0);
        }

        .secondary-button {
            background-color: var(--background-color);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            padding: 0.75rem 1.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 150px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .secondary-button:hover {
            background-color: var(--card-background);
            color: var(--text-primary);
            border-color: var(--text-secondary);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .secondary-button:active {
            transform: translateY(0);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            background-color: var(--card-background);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .radio-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s ease;
        }

        .radio-label:hover {
            background-color: var(--background-color);
        }

        .radio-label input[type="radio"] {
            width: 1rem;
            height: 1rem;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            appearance: none;
            -webkit-appearance: none;
            outline: none;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
        }

        .radio-label input[type="radio"]:checked {
            border-color: var(--primary-color);
            background-color: var(--primary-color);
        }

        .radio-label input[type="radio"]:checked::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 0.375rem;
            height: 0.375rem;
            background-color: white;
            border-radius: 50%;
        }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 0.375rem;
            background: var(--border-color);
            border-radius: 0.25rem;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.2);
        }

        .analysis-parameters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            padding: 1.25rem;
            background: var(--background-color);
            border-radius: 0.75rem;
            margin-bottom: 2rem;
        }

        .parameter-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .parameter-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .parameter-value {
            font-size: 0.875rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .tab-container {
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
        }

        .tab-button {
            padding: 0.75rem 1.5rem;
            border: none;
            background: none;
            cursor: pointer;
            color: var(--text-secondary);
            font-weight: 500;
            position: relative;
            transition: all 0.2s ease;
        }

        .tab-button.active {
            color: var(--primary-color);
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: var(--primary-color);
        }

        .tab-button:hover:not(.active) {
            color: var(--text-primary);
        }

        @media (max-width: 768px) {
            .primary-actions, .secondary-actions {
                flex-direction: column;
                align-items: stretch;
            }
            
            .primary-button, .secondary-button {
                width: 100%;
            }
        }

        .content-grid {
            display: grid;
            grid-template-columns: 65% 35%;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .plot-frame {
            width: 100%;
            height: 100%;
            min-height: 400px;
            border: none;
            border-radius: 0.5rem;
            background: var(--background-color);
        }

        .plot-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
            text-align: center;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--background-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }
            100% {
                background-position: 1000px 0;
            }
        }

        .loading-skeleton {
            background: linear-gradient(90deg, 
                var(--background-color) 25%, 
                var(--card-background) 50%, 
                var(--background-color) 75%);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite linear;
        }

        .loading-row td {
            height: 24px;
            border-radius: 4px;
        }

        .modal-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
        }

        .modal-spinner {
            width: 3rem;
            height: 3rem;
            border: 3px solid var(--border-color);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s linear infinite;
        }

        .species-checkbox {
            position: relative;
            margin-right: 0.75rem;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 0.25rem;
            border: 2px solid var(--border-color);
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            transition: all 0.2s ease;
        }

        .species-checkbox:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .species-checkbox:checked::after {
            content: '\2713';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 0.875rem;
            line-height: 1;
            font-weight: bold;
        }

        .format-checkbox {
            position: relative;
            margin-right: 0.75rem;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 0.25rem;
            border: 2px solid var(--border-color);
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            transition: all 0.2s ease;
        }

        .format-checkbox:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .format-checkbox:checked::after {
            content: '\2713';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 0.875rem;
            line-height: 1;
            font-weight: bold;
        }

        .species-selection-checkbox {
            position: relative;
            margin-right: 0.75rem;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 0.25rem;
            border: 2px solid var(--border-color);
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            transition: all 0.2s ease;
        }

        .species-selection-checkbox:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .species-selection-checkbox:checked::after {
            content: '\2713';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 0.875rem;
            line-height: 1;
            font-weight: bold;
        }

        .modal .tab-content {
            display: none;
        }

        .modal .tab-content.active {
            display: block;
        }

        .modal .table-container {
            max-height: calc(90vh - 400px);
            overflow-y: auto;
            border-radius: 0.5rem;
            background: var(--card-background);
            margin-top: 1rem;
        }

        .modal .results-table thead {
            position: sticky;
            top: 0;
            background: var(--card-background);
            z-index: 10;
        }

        .modal .results-table td {
            vertical-align: top;
            padding: 1rem;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .modal .results-table td:last-child {
            max-width: none;
            white-space: normal;
            word-wrap: break-word;
        }

        .modal .results-table .go-term-link {
            display: inline-block;
            margin-right: 0.25rem;
        }

        .plots-grid {
            width: 100%;
            display: grid;
            grid-template-columns: 34% 63%;
            gap: 1.5rem;
            padding: 0;
            box-sizing: border-box;
        }

        @media (max-width: 1790px) {
            .plots-grid {
                grid-template-columns: 34% 63%;
                transform: scale(0.9);
                transform-origin: top left;
                width: 111%;
            }
        }

        @media (max-width: 1400px) {
            .plots-grid {
                transform: scale(0.8);
                width: 125%;
            }
        }

        @media (max-width: 1200px) {
            .plots-grid {
                grid-template-columns: 1fr;
                transform: none;
                width: 100%;
                gap: 2rem;
            }

            .secondary-plots {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
                gap: 1.5rem;
            }

            .main-plot {
                min-height: 800px;
            }

            .secondary-plot {
                min-height: 400px;
            }
        }

        .main-plot {
            min-height: 1000px;
            background: var(--card-background);
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            padding: 0;
            box-sizing: border-box;
            overflow-x: hidden;
            position: relative;
        }

        .secondary-plots {
            display: flex;
            flex-direction: column;
            gap: 36px;
        }
        
        .secondary-plot {
            flex: 1;
            min-height: 450px;
            background: var(--card-background);
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            padding: 0;
            box-sizing: border-box;
            overflow-x: hidden;
            position: relative;
        }

        .plot-frame {
            width: 100%;
            height: 100%;
            min-height: 400px;
            border: none;
            border-radius: 0.5rem;
            background: var(--background-color);
        }

        .plots-container {
            width: 100%;
            margin-bottom: 2rem;
            background: var(--card-background);
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        .plots-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 12px -1px rgb(0 0 0 / 0.15);
        }

        .plot-tab-content {
            display: none;
        }

        .plot-tab-content.active {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            padding: 1rem;
        }

        .secondary-plots {
            display: flex;
            gap: 1.5rem;
        }

        .main-plot iframe,
        .secondary-plot iframe,
        .secondary-plot img {
            width: 100%;
            height: 100%;
            min-height: 400px;
            border: none;
            background: white;
            display: block;
        }

        .no-plot-message {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            background-color: var(--background-color);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 1rem;
            text-align: center;
            padding: 1rem;
            box-sizing: border-box;
        }

        .no-plots-message {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 1500px;
            width: 100%;
            background-color: var(--background-color);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 1.2rem;
            text-align: center;
            padding: 2rem;
            box-sizing: border-box;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .plot-loading {
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            background-color: var(--background-color);
            color: var(--text-secondary);
            font-size: 1rem;
            z-index: 5;
        }

        .main-plot, .secondary-plot {
            position: relative;
        }

        .plot-frame {
            position: relative;
            z-index: 10;
        }

        @media (max-width: 1024px) {
            .plots-grid {
                grid-template-columns: 1fr;
                gap: 2rem;
            }

            .main-plot,
            .secondary-plots {
                grid-column: 1;
                width: 100%;
            }

            .secondary-plots {
                flex-direction: column;
            }

            .secondary-plot {
                width: 100%;
            }
        }

        .tab-content {
            min-height: 500px;
            width: 100%;
            position: relative;
        }

        .tab-pane {
            position: absolute;
            width: 100%;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }

        .tab-pane.active {
            opacity: 1;
            visibility: visible;
            position: relative;
        }

        .results-table th {
            padding: 0.5rem 0.5rem;
            font-size: 0.875rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
            vertical-align: middle;
            height: 2.5rem;
            line-height: 1.2;
        }

        .sortable-header {
            position: relative;
        }

        .sortable-header[data-full-title]:hover::after {
            content: attr(data-full-title);
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--text-primary);
            color: white;
            padding: 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 20;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            pointer-events: none;
        }

        .selected-terms-container {
            background-color: var(--background-color);
            border-radius: 0.75rem;
            padding: 1rem;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }

        .selected-terms-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .selected-term {
            transition: all 0.2s ease;
        }

        .selected-term:hover {
            transform: translateY(-2px);
        }

        .remove-term:hover {
            color: var(--error-color) !important;
        }

        .term-selection-controls {
            margin-top: 1rem;
        }

        #manual-go-entry {
            background-color: var(--background-color);
            border-radius: 0.75rem;
            padding: 1rem;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        #ancestor-analysis-modal .modal-content {
            max-width: 800px;
            width: 80%;
            height: 80vh;
            min-height: 600px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #ancestor-analysis-modal .modal-header {
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        #ancestor-analysis-modal .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 0 1.5rem 1.5rem 1.5rem;
        }

        #ancestor-analysis-modal .modal-body .form-section:first-child {
            margin-top: 1.5rem;
        }

        #ancestor-analysis-modal .form-section {
            margin-bottom: 2rem;
        }

        #ancestor-analysis-modal .form-group {
            margin-bottom: 1.5rem;
        }

        #ancestor-analysis-modal .form-label {
            display: block;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
        }

        #ancestor-analysis-modal .radio-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            background-color: var(--background-color);
            border-radius: 0.75rem;
            padding: 1rem;
            border: 1px solid var(--border-color);
        }

        #ancestor-analysis-modal .radio-label {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease;
            cursor: pointer;
        }

        #ancestor-analysis-modal .radio-label:hover {
            background-color: var(--card-background);
        }

        #ancestor-analysis-modal .checkbox-label {
            padding: 0.75rem;
            background-color: var(--background-color);
            border-radius: 0.5rem;
            transition: background-color 0.2s ease;
            cursor: pointer;
        }

        #ancestor-analysis-modal .checkbox-label:hover {
            background-color: var(--card-background);
        }

        .selected-terms-container {
            background-color: var(--background-color);
            border-radius: 0.75rem;
            padding: 1rem;
            height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }

        .selected-terms-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .selected-term {
            transition: all 0.2s ease;
        }

        .selected-term:hover {
            transform: translateY(-2px);
        }

        .remove-term:hover {
            color: var(--error-color) !important;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #ancestor-analysis-results {
            margin-top: 2rem;
            animation: fadeIn 0.5s ease forwards;
        }

        #ancestor-graph-container {
            height: auto;
            background: var(--background-color);
            border-radius: 0.5rem;
            overflow: visible;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        #ancestor-graph-container:hover {
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        #ancestor-table-container {
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            transition: all 0.3s ease;
        }

        #ancestor-table-container:hover {
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        @media (max-width: 768px) {
            #ancestor-analysis-modal .modal-content {
                width: 95%;
                height: 90vh;
                padding: 1.5rem;
            }

            .term-selection-controls div {
                flex-direction: column;
            }

            #manual-go-entry div {
                flex-direction: column;
            }

            #ancestor-analysis-modal .checkbox-label {
                width: 100%;
            }
        }

        #diagram-fullscreen-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 2rem;
            box-sizing: border-box;
        }
        
        #fullscreen-diagram-content {
            width: 95%;
            height: 90%;
            background-color: white;
            border-radius: 0.5rem;
            padding: 1rem;
            overflow: auto;
            position: relative;
        }
        
        #fullscreen-diagram-content svg {
            cursor: grab;
        }

        #fullscreen-diagram-content svg:active {
            cursor: grabbing;
        }
        
        .fullscreen-controls {
            width: 95%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .fullscreen-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 0.25rem;
            padding: 0.5rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            transition: background-color 0.2s;
        }
        
        .fullscreen-button:hover {
            background-color: var(--primary-hover);
        }
        
        .fullscreen-button svg {
            width: 16px;
            height: 16px;
        }
        
        .close-fullscreen-button {
            background-color: white;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .close-fullscreen-button:hover {
            background-color: var(--background-color);
        }

        #semantic-similarity-modal .modal-content {
            max-width: 800px;
            width: 80%;
            height: 80vh;
            min-height: 600px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #semantic-similarity-modal .modal-header {
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        #semantic-similarity-modal .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 0 1.5rem 1.5rem 1.5rem;
        }

        #semantic-similarity-modal .modal-body .form-section:first-child {
            margin-top: 1.5rem;
        }

        #semantic-similarity-modal .form-section {
            margin-bottom: 2rem;
        }

        #semantic-similarity-modal .form-group {
            margin-bottom: 1.5rem;
        }

        .radio-container {
            display: flex;
            flex-direction: column;
            padding: 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            margin-bottom: 0.5rem;
            border: 1px solid var(--border-color);
        }

        .radio-container:hover {
            background-color: var(--background-color-hover);
        }

        .radio-container input[type="radio"] {
            margin-right: 0.5rem;
        }

        .radio-label {
            font-weight: 500;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
        }

        .radio-description {
            font-size: 0.875rem;
            color: var(--text-tertiary);
            margin-top: 0.25rem;
            margin-left: 1.5rem;
        }

        .method-selection-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .method-option {
            position: relative;
            cursor: pointer;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            background-color: var(--background-color);
            transition: all 0.2s ease;
            overflow: hidden;
        }

        .method-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-color-light);
        }

        .method-option input[type="radio"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .method-content {
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .method-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .method-description {
            font-size: 0.85rem;
            color: var(--text-tertiary);
        }

        .method-option input[type="radio"]:checked + .method-content {
            background-color: var(--primary-color-light);
            border-color: var(--primary-color);
        }

        .method-option input[type="radio"]:checked + .method-content .method-name {
            color: var(--primary-color);
        }

        .method-option input[type="radio"]:focus + .method-content {
            box-shadow: 0 0 0 2px var(--primary-color-light);
        }

        .similarity-table-container {
            max-height: 500px;
            min-height: 300px;
            overflow: auto;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            position: relative;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
        }

        .similarity-table th, 
        .similarity-table td {
            padding: 0.75rem;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }

        .similarity-table th {
            position: sticky;
            top: 0;
            background-color: var(--card-background);
            z-index: 1;
        }

        .similarity-table th:first-child {
            text-align: left;
            position: sticky;
            left: 0;
            z-index: 2;
        }

        .similarity-table td:first-child {
            position: sticky;
            left: 0;
            background-color: var(--card-background);
            font-weight: 500;
            z-index: 1;
        }

        .similarity-table th:first-child {
            z-index: 3;
            background-color: var(--card-background);
        }

        .corner-header {
            position: sticky;
            top: 0;
            left: 0;
            z-index: 3;
            background-color: var(--card-background);
            text-align: left;
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        .zoom-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .zoom-button {
            background-color: var(--background-color);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        
        .zoom-button:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .info-tooltip {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .info-tooltip .tooltip-text {
            visibility: hidden;
            width: 250px;
            background-color: var(--text-primary);
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 8px 12px;
            position: absolute;
            z-index: 100;
            top: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.875rem;
            font-weight: normal;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            pointer-events: none;
        }
        
        .info-tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            bottom: 100%; 
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: transparent transparent var(--text-primary) transparent; 
        }
        
        .info-tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        .info-button {
            background-color: var(--background-color);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .info-button:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        #similarity-fullscreen-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 1rem;
            box-sizing: border-box;
        }
        
        #fullscreen-similarity-content {
            width: 98%;
            height: 95%;
            background-color: white;
            border-radius: 0.5rem;
            padding: 0 !important;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        #fullscreen-similarity-content .similarity-table-container {
            flex: 1;
            overflow: auto;
            max-height: 100%;
            margin: 0 !important;
            padding: 0 !important;
            width: 100% !important;
        }
        
        #fullscreen-similarity-content .similarity-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0 !important;
            border-spacing: 0 !important;
        }
        
        #fullscreen-similarity-content .similarity-table thead th {
            position: sticky !important;
            top: 0 !important;
            background-color: var(--card-background);
            z-index: 10 !important;
            box-shadow: 0 1px 0 var(--border-color);
            padding: 1rem 1.5rem !important;
            font-size: 1rem !important;
            white-space: nowrap !important;
            min-width: 150px !important;
        }
        
        #fullscreen-similarity-content .similarity-table tbody td:first-child {
            position: sticky !important;
            left: 0 !important;
            background-color: var(--card-background);
            z-index: 5 !important;
            box-shadow: 1px 0 0 var(--border-color);
            padding: 1rem 1.5rem !important;
            font-size: 1rem !important;
            white-space: nowrap !important;
            min-width: 150px !important;
        }
        
        #fullscreen-similarity-content .similarity-table thead th:first-child,
        #fullscreen-similarity-content .similarity-table thead th.corner-header {
            position: sticky !important;
            left: 0 !important;
            top: 0 !important;
            z-index: 20 !important;
            background-color: var(--card-background);
            box-shadow: 1px 1px 0 var(--border-color);
            padding: 1rem 1.5rem !important;
            min-width: 150px !important;
        }

        #fullscreen-similarity-content .similarity-table tbody td {
            padding: 1rem 1.5rem !important;
            min-width: 150px !important;
            text-align: center !important;
        }
                
        .fullscreen-controls {
            width: 98%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .fullscreen-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 0.25rem;
            padding: 0.5rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            transition: background-color 0.2s;
        }
        
        .fullscreen-button:hover {
            background-color: var(--primary-hover);
        }
        
        .fullscreen-button svg {
            width: 16px;
            height: 16px;
        }
        
        .close-fullscreen-button {
            background-color: white;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .close-fullscreen-button:hover {
            background-color: var(--background-color);
        }

        .main-container .results-table thead {
            position: sticky;
            top: 0;
            background-color: var(--card-background);
            z-index: 10;
        }

        .main-container .results-table th:first-child,
        .main-container .results-table td:first-child {
            position: sticky;
            left: 0;
            background-color: var(--card-background);
            z-index: 5;
            box-shadow: 2px 0 4px -2px rgba(0, 0, 0, 0.1);
        }

        .main-container .results-table thead th:first-child {
            position: sticky;
            left: 0;
            z-index: 15;
            background-color: var(--card-background);
            box-shadow: 
                2px 0 4px -2px rgba(0, 0, 0, 0.1),
                0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        .main-container .results-table thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: var(--card-background);
            box-shadow: 0 1px 2px -1px rgba(0, 0, 0, 0.1);
        }

        .secondary-plots {
            display: flex;
            gap: 1.5rem;
        }

        .main-plot iframe,
        .secondary-plot iframe,
        .secondary-plot img {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
            display: block;
        }

        .no-plot-message {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            background-color: var(--background-color);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 1rem;
            text-align: center;
            padding: 1rem;
            box-sizing: border-box;
        }

        .no-plots-message {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 1500px;
            width: 100%;
            background-color: var(--background-color);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 1.2rem;
            text-align: center;
            padding: 2rem;
            box-sizing: border-box;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .plot-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1rem;
            color: var(--text-secondary);
            z-index: 1;
        }
        
        .no-plot-message, .no-plots-message {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            font-size: 1.125rem;
            color: var(--text-secondary);
            text-align: center;
            padding: 2rem;
        }

        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal-backdrop.active {
            display: block;
            opacity: 1;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1001;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.active {
            display: flex;
            opacity: 1;
        }

        .loading-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .loading-container.active {
            display: flex;
            opacity: 1;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({
            startOnLoad: false,
            theme: 'default',
            flowchart: {
                useMaxWidth: false,
                htmlLabels: true,
                curve: 'basis'
            },
            securityLevel: 'loose',
            htmlLabels: true,
            er: { useMaxWidth: false },
            sequence: { useMaxWidth: false },
            gantt: { useMaxWidth: false },
            journey: { useMaxWidth: false },
            pie: { useMaxWidth: false }
        });

        document.addEventListener('DOMContentLoaded', function() {
            setupCloseFullscreenButton();
        });
        
        function setupCloseFullscreenButton() {
            const closeFullscreenButton = document.getElementById('close-similarity-fullscreen');
            if (closeFullscreenButton) {
                const newCloseButton = closeFullscreenButton.cloneNode(true);
                closeFullscreenButton.parentNode.replaceChild(newCloseButton, closeFullscreenButton);
                
                newCloseButton.addEventListener('click', toggleSimilarityFullscreen);
            }
        }

        function toggleDiagramFullscreen() {
            const diagramContainer = document.getElementById('diagram-fullscreen-container');
            
            if (diagramContainer.style.display === 'flex') {
                diagramContainer.style.display = 'none';
                document.body.style.overflow = 'auto';
                
                const container = document.querySelector('#fullscreen-diagram-content > div');
                if (container) {
                    container.removeEventListener('mousedown', handleMouseDown);
                    container.removeEventListener('mousemove', handleMouseMove);
                    container.removeEventListener('mouseup', handleMouseUp);
                    container.removeEventListener('mouseleave', handleMouseUp);
                    container.removeEventListener('wheel', handleWheel);
                }
                
                const svgElement = document.querySelector('#fullscreen-diagram-content svg');
                if (svgElement) {
                    svgElement.removeEventListener('click', handleSvgClick);
                }
            } else {
                try {
                    fetch('/ancestor-mermaid')
                        .then(response => response.text())
                        .then(mermaidCode => {
                            document.getElementById('fullscreen-diagram-content').innerHTML = 
                                `<div style="width: 100%; height: 100%; overflow: hidden; position: relative;">
                                    <div class="zoom-container" style="position: absolute; transform-origin: 0 0;">
                                        <pre class="mermaid" style="overflow: visible; max-width: none; width: auto;">${mermaidCode}</pre>
                                    </div>
                                    <div class="zoom-controls" style="position: absolute; top: 20px; right: 20px; display: flex; gap: 0.5rem; background: rgba(255,255,255,0.9); padding: 0.5rem; border-radius: 0.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                        <div class="info-tooltip">
                                            <button class="info-button">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 16px; height: 16px;">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                                Info
                                            </button>
                                            <span class="tooltip-text">Click on any term box in the graph to open its QuickGO page in a new tab.</span>
                                        </div>
                                        <button class="zoom-button" onclick="zoomDiagram(0.8)" style="padding: 0.5rem; border-radius: 0.25rem; border: 1px solid #ccc; background: white; cursor: pointer;">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <circle cx="11" cy="11" r="8"/>
                                                <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                                                <line x1="8" y1="11" x2="14" y2="11"/>
                                            </svg>
                                        </button>
                                        <button class="zoom-button" onclick="zoomDiagram(1)" style="padding: 0.5rem; border-radius: 0.25rem; border: 1px solid #ccc; background: white; cursor: pointer;">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                            </svg>
                                        </button>
                                        <button class="zoom-button" onclick="zoomDiagram(1.2)" style="padding: 0.5rem; border-radius: 0.25rem; border: 1px solid #ccc; background: white; cursor: pointer;">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <circle cx="11" cy="11" r="8"/>
                                                <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                                                <line x1="11" y1="8" x2="11" y2="14"/>
                                                <line x1="8" y1="11" x2="14" y2="11"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>`;
                            
                            mermaid.run({
                                nodes: document.querySelectorAll('#fullscreen-diagram-content .mermaid')
                            }).then(() => {
                                const svgElement = document.querySelector('#fullscreen-diagram-content svg');
                                if (svgElement) {
                                    svgElement.style.maxWidth = 'none';
                                    svgElement.style.width = '100%';
                                    svgElement.style.height = 'auto';
                                    
                                    svgElement.addEventListener('click', handleSvgClick, true);
                                }
                                
                                const container = document.querySelector('#fullscreen-diagram-content > div');
                                const zoomContainer = document.querySelector('.zoom-container');
                                window.originalWidth = zoomContainer.offsetWidth;
                                window.originalHeight = zoomContainer.offsetHeight;
                                window.currentScale = 1;
                                window.currentX = 0;
                                window.currentY = 0;
                                
                                centerDiagram();
                                
                                container.addEventListener('mousedown', handleMouseDown);
                                container.addEventListener('mousemove', handleMouseMove);
                                container.addEventListener('mouseup', handleMouseUp);
                                container.addEventListener('mouseleave', handleMouseUp);
                                container.addEventListener('wheel', handleWheel, { passive: false });
                                
                                document.querySelectorAll('#fullscreen-diagram-content a').forEach(link => {
                                    link.setAttribute('target', '_blank');
                                    link.setAttribute('rel', 'noopener noreferrer');
                                });
                            })
                            .catch(error => {
                                console.error('Error rendering fullscreen diagram:', error);
                                document.getElementById('fullscreen-diagram-content').innerHTML = 
                                    `<div style="padding: 2rem; color: var(--error-color); background: white; border-radius: 0.5rem;">
                                        Error rendering diagram in fullscreen. The diagram may be too complex.
                                        <div style="margin-top: 1rem;">
                                            <a href="/ancestor-graph" target="_blank" rel="noopener noreferrer" style="color: var(--primary-color);">View as PDF instead</a>
                                        </div>
                                    </div>`;
                            });
                        })
                        .catch(error => {
                            console.error('Error fetching mermaid code for fullscreen:', error);
                            document.getElementById('fullscreen-diagram-content').innerHTML = 
                                `<div style="padding: 2rem; color: var(--error-color); background: white; border-radius: 0.5rem;">
                                    Error loading diagram for fullscreen view. Please try again.
                                </div>`;
                        });
                } catch (error) {
                    console.error('Error in fullscreen toggle:', error);
                }
                
                diagramContainer.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        }
        
        function setLinksToOpenInNewTab() {
            document.querySelectorAll('#mermaid-diagram a, .mermaid a').forEach(link => {
                link.setAttribute('target', '_blank');
                link.setAttribute('rel', 'noopener noreferrer');
            });
        }

        function zoomDiagram(scale) {
            const zoomContainer = document.querySelector('.zoom-container');
            if (!zoomContainer) return;

            const container = document.querySelector('#fullscreen-diagram-content > div');
            const oldScale = window.currentScale || 1;

            if (scale === 1) {
                window.currentScale = 1;
                centerDiagram();
            } else {
                const zoomFactor = scale > 1 ? 1.5 : 0.667;
                window.currentScale = oldScale * zoomFactor;
                window.currentScale = Math.min(Math.max(window.currentScale, 0.1), 10);

                const containerRect = container.getBoundingClientRect();
                const centerX = containerRect.width / 2;
                const centerY = containerRect.height / 2;

                const scaleChange = window.currentScale / oldScale;
                const dx = centerX - (centerX - window.currentX) * scaleChange;
                const dy = centerY - (centerY - window.currentY) * scaleChange;

                window.currentX = dx;
                window.currentY = dy;

                updateTransform();
            }
        }

        function handleWheel(e) {
            if (!e.ctrlKey) return;
            e.preventDefault();
            
            const zoomFactor = e.deltaY < 0 ? 1.1 : 0.9;
            zoomDiagram(zoomFactor);
        }

        function zoomFullscreenDiagram(scale) {
            const svgElement = document.querySelector('#fullscreen-diagram-content svg');
            if (svgElement) {
                const currentTransform = svgElement.getAttribute('transform') || '';
                const currentScaleMatch = currentTransform.match(/scale\(([^)]+)\)/);
                
                let currentScale = 1;
                if (currentScaleMatch && currentScaleMatch[1]) {
                    currentScale = parseFloat(currentScaleMatch[1]);
                }
                
                const newScale = scale === 1 ? 1 : currentScale * scale;
                
                if (newScale === 1) {
                    svgElement.removeAttribute('transform');
                } else {
                    const bbox = svgElement.getBBox();
                    const cx = bbox.x + bbox.width/2;
                    const cy = bbox.y + bbox.height/2;
                    svgElement.setAttribute('transform', `scale(${newScale})`);
                }
                
                const fullscreenContainer = document.querySelector('#fullscreen-diagram-content > div');
                if (fullscreenContainer) {
                    fullscreenContainer.style.minWidth = `${svgElement.getBBox().width * newScale}px`;
                    fullscreenContainer.style.minHeight = `${svgElement.getBBox().height * newScale}px`;
                }
            }
        }

        function centerDiagram() {
            const container = document.querySelector('#fullscreen-diagram-content > div');
            const zoomContainer = document.querySelector('.zoom-container');
            if (!container || !zoomContainer) return;

            const scale = window.currentScale || 1;
            const containerWidth = container.offsetWidth;
            const containerHeight = container.offsetHeight;
            const diagramWidth = window.originalWidth * scale;
            const diagramHeight = window.originalHeight * scale;

            window.currentX = (containerWidth - diagramWidth) / 2;
            window.currentY = (containerHeight - diagramHeight) / 2;
            updateTransform();
        }

        function updateTransform() {
            const zoomContainer = document.querySelector('.zoom-container');
            if (!zoomContainer) return;

            const scale = window.currentScale || 1;
            zoomContainer.style.transform = `translate(${window.currentX}px, ${window.currentY}px) scale(${scale})`;
        }

        let isDragging = false;
        let startX, startY;
        let hasMoved = false;
        let clickStartTime = 0;

        function handleMouseDown(e) {
            clickStartTime = Date.now();
            hasMoved = false;
            isDragging = true;
            
            const container = document.querySelector('#fullscreen-diagram-content > div');
            startX = e.clientX - window.currentX;
            startY = e.clientY - window.currentY;
            container.style.cursor = 'grabbing';
            
            e.preventDefault();
            
        }

        function handleMouseMove(e) {
            if (!isDragging) return;
            
            const dx = e.clientX - (startX + window.currentX);
            const dy = e.clientY - (startY + window.currentY);
            
            if (Math.abs(dx) > 5 || Math.abs(dy) > 5) {
                hasMoved = true;
            }
            
            window.currentX = e.clientX - startX;
            window.currentY = e.clientY - startY;
            updateTransform();
            
            e.preventDefault();
        }

        function handleMouseUp(e) {
            if (isDragging) {
                isDragging = false;
                const container = document.querySelector('#fullscreen-diagram-content > div');
                if (container) {
                    container.style.cursor = 'grab';
                }

                if (!hasMoved && (Date.now() - clickStartTime < 300)) {
                } else {
                    e.preventDefault();
                    e.stopPropagation();
                }
            }
        }

        function handleSvgClick(e) {
            if (hasMoved) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
        }

        function toggleSimilarityFullscreen() {
            const similarityContainer = document.getElementById('similarity-fullscreen-container');
            
            if (similarityContainer.style.display === 'flex') {
                similarityContainer.style.display = 'none';
                document.body.style.overflow = 'auto';
            } else {
                try {
                    const tableContainer = document.querySelector('.similarity-table-container');
                    if (!tableContainer) {
                        console.error('Similarity table container not found');
                        return;
                    }
                    
                    const tableHTML = tableContainer.querySelector('.similarity-table').outerHTML;

                    const fullscreenContent = document.getElementById('fullscreen-similarity-content');
                    fullscreenContent.innerHTML = '';
                    
                    const newTableContainer = document.createElement('div');
                    newTableContainer.className = 'similarity-table-container';
                    newTableContainer.innerHTML = tableHTML;
                    
                    const cornerHeader = newTableContainer.querySelector('.similarity-table thead th:first-child');
                    if (cornerHeader && !cornerHeader.classList.contains('corner-header')) {
                        cornerHeader.classList.add('corner-header');
                    }
                    
                    fullscreenContent.appendChild(newTableContainer);
                    
                    const downloadButton = document.getElementById('download-similarity-csv');
                    if (downloadButton) {
                        const newDownloadButton = downloadButton.cloneNode(true);
                        downloadButton.parentNode.replaceChild(newDownloadButton, downloadButton);
                        
                        newDownloadButton.addEventListener('click', function() {
                            const currentTable = document.querySelector('#fullscreen-similarity-content .similarity-table');
                            if (currentTable) {
                                downloadSimilarityCSVFromTable(currentTable);
                            } else {
                                console.error('Table not found in fullscreen view');
                            }
                        });
                    }
                    
                    setupCloseFullscreenButton();
                    
                    similarityContainer.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                } catch (error) {
                    console.error('Error in similarity fullscreen toggle:', error);
                }
            }
        }
        
        function downloadSimilarityCSV() {
            const currentTable = document.querySelector('#fullscreen-similarity-content .similarity-table');
            if (currentTable) {
                downloadSimilarityCSVFromTable(currentTable);
            } else {
                console.error('Table not found in fullscreen view for CSV download');
                const mainTable = document.querySelector('.similarity-table');
                if (mainTable) {
                    downloadSimilarityCSVFromTable(mainTable);
                } else {
                    console.error('No similarity table found for CSV download');
                }
            }
        }
        
        function downloadSimilarityCSVFromTable(table) {
            try {
                if (!table) {
                    console.error('Table not found');
                    return;
                }
                
                const rows = Array.from(table.querySelectorAll('tr'));
                let csvContent = "data:text/csv;charset=utf-8,";
                
                rows.forEach(row => {
                    const cells = Array.from(row.querySelectorAll('th, td'));
                    const rowData = cells.map(cell => {
                        let content = cell.textContent.trim();
                        if (content.includes(',') || content.includes('"')) {
                            content = '"' + content.replace(/"/g, '""') + '"';
                        }
                        return content;
                    });
                    csvContent += rowData.join(',') + '\r\n';
                });
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement('a');
                link.setAttribute('href', encodedUri);
                link.setAttribute('download', 'semantic_similarity.csv');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                console.error('Error downloading CSV:', error);
            }
        }

        function setupIframeErrorHandling() {
            document.querySelectorAll('iframe.plot-frame').forEach(iframe => {
                const newIframe = iframe.cloneNode(true);
                iframe.parentNode.replaceChild(newIframe, iframe);
                
                const loadTimeout = setTimeout(() => {
                    const loadingEl = newIframe.parentElement.querySelector('.plot-loading');
                    if (loadingEl) {
                        loadingEl.textContent = 'Plot is taking longer than expected to load...';
                    }
                }, 10000);
                
                newIframe.addEventListener('load', function() {
                    clearTimeout(loadTimeout);
                    
                    const loadingEl = this.parentElement.querySelector('.plot-loading');
                    if (loadingEl) {
                        loadingEl.style.display = 'none';
                    }
                    
                    try {
                        if (this.contentDocument && 
                            (this.contentDocument.title.includes('Error: Plot Not Found') || 
                             this.contentDocument.body.textContent.includes('Plot Not Found') ||
                             this.contentDocument.body.classList.contains('plot-error-page'))) {

                            const id = this.id || '';
                            let namespace = 'Unknown';
                            let plotType = 'plot';
                            
                            if (id.startsWith('bp')) {
                                namespace = 'Biological Process';
                            } else if (id.startsWith('mf')) {
                                namespace = 'Molecular Function';
                            } else if (id.startsWith('cc')) {
                                namespace = 'Cellular Component';
                            }
                            
                            if (id.includes('plot1')) {
                                plotType = 'bar plot';
                            } else if (id.includes('plot2')) {
                                plotType = 'bubble plot';
                            } else if (id.includes('plot3')) {
                                plotType = 'network plot';
                            }
                            
                            
                            this.parentElement.innerHTML = `<div class="no-plot-message">No ${plotType} available for ${namespace}</div>`;
                        }
                    } catch (e) {
                        console.log('Cannot check iframe content:', e);
                    }
                });
                
                newIframe.addEventListener('error', function() {
                    clearTimeout(loadTimeout);
                    
                    const id = this.id || '';
                    let namespace = 'Unknown';
                    let plotType = 'plot';
                    
                    if (id.startsWith('bp')) {
                        namespace = 'Biological Process';
                    } else if (id.startsWith('mf')) {
                        namespace = 'Molecular Function';
                    } else if (id.startsWith('cc')) {
                        namespace = 'Cellular Component';
                    }
                    
                    if (id.includes('plot1')) {
                        plotType = 'bar plot';
                    } else if (id.includes('plot2')) {
                        plotType = 'bubble plot';
                    } else if (id.includes('plot3')) {
                        plotType = 'network plot';
                    }
                    
                    this.parentElement.innerHTML = `<div class="no-plot-message">No ${plotType} available for ${namespace}</div>`;
                });
            });
            
            document.querySelectorAll('img.plot-frame').forEach(img => {
                img.addEventListener('load', function() {
                    const loadingEl = this.parentElement.querySelector('.plot-loading');
                    if (loadingEl) {
                        loadingEl.style.display = 'none';
                    }
                });
            });
        }

        function showLoading() {
            const loadingContainer = document.getElementById('global-loading-container');
            loadingContainer.classList.add('active');
        }

        function hideLoading() {
            const loadingContainer = document.getElementById('global-loading-container');
            loadingContainer.classList.remove('active');
        }

        function showModal(modalId) {
            const backdrop = document.getElementById('modal-backdrop');
            const modal = document.getElementById(modalId);
            backdrop.classList.add('active');
            modal.classList.add('active');
            document.body.classList.add('modal-open');
        }

        function hideModal(modalId) {
            const backdrop = document.getElementById('modal-backdrop');
            const modal = document.getElementById(modalId);
            backdrop.classList.remove('active');
            modal.classList.remove('active');
            document.body.classList.remove('modal-open');
        }

        async function loadResults() {
            try {
                const tbody = document.getElementById('results-body');
                const thead = document.querySelector('.results-table thead tr');
                
                showLoading();
                
                tbody.innerHTML = Array(5).fill(0).map(() => `
                    <tr class="loading-row">
                        ${Array(9).fill('<td class="loading-skeleton">&nbsp;</td>').join('')}
                    </tr>
                `).join('');

                const response = await fetch('/get_results');
                if (!response.ok) {
                    throw new Error('Results not found');
                }
                
                const data = await response.text();
                if (!data) {
                    throw new Error('No results data available');
                }
                
                const lines = data.split('\n');
                tbody.innerHTML = '';
                
                thead.innerHTML = '';
                
                if (lines.length > 0) {
                    const headerLine = lines[0].trim();
                    const headers = headerLine.split('\t');
                    
                    headers.forEach((header, index) => {
                        const th = document.createElement('th');
                        th.className = 'sortable-header';
                        th.setAttribute('data-column', index);
                        
                        if (header.includes('GO') && header.includes('ID')) {
                            th.setAttribute('data-type', 'id');
                        } else if (header.includes('Name') || header.includes('Namespace')) {
                            th.setAttribute('data-type', 'name');
                        } else {
                            th.setAttribute('data-type', 'numeric');
                        }
                        
                        if (header.length > 15) {
                            th.setAttribute('data-full-title', header);
                        }
                        
                        th.textContent = header;
                        const sortArrow = document.createElement('span');
                        sortArrow.className = 'sort-arrow';
                        th.appendChild(sortArrow);
                        
                        thead.appendChild(th);
                    });
                }
                
                allResults = [];

                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    const columns = line.split('\t');
                    if (columns.length >= 3) {
                        allResults.push(columns);
                    }
                }

                if (allResults.length === 0) {
                    throw new Error('No valid results found');
                }

                allResults = sortResultsByOddsRatioAndPValue(allResults);

                for (let i = 0; i < Math.min(10, allResults.length); i++) {
                    tbody.appendChild(createTableRow(allResults[i]));
                }

                initializeTableSorting(document.querySelector('.results-table-container .results-table'));
                
                initializeTabSwitching();
            } catch (error) {
                console.error('Error loading results:', error);
                const tbody = document.getElementById('results-body');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            No results available. Please run an analysis first.
                        </td>
                    </tr>
                `;
            } finally {
                hideLoading();
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('modal-backdrop').addEventListener('click', function() {
                const activeModal = document.querySelector('.modal.active');
                if (activeModal) {
                    hideModal(activeModal.id);
                }
            });

            document.querySelectorAll('.close-modal').forEach(button => {
                button.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    if (modal) {
                        hideModal(modal.id);
                    }
                });
            });

            document.querySelectorAll('.modal-content').forEach(content => {
                content.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            });
        });

        document.addEventListener('DOMContentLoaded', function() {
            const downloadButton = document.querySelector('.download-button');
            if (downloadButton) {
                console.log('[TaxaGO] Download button found, attaching event listener');
                downloadButton.addEventListener('click', () => {
                    console.log('[TaxaGO] Download button clicked, creating modal');
                    const modal = document.createElement('div');
                    modal.className = 'modal active';
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width: 500px; padding: 2rem;">
                            <span class="close-modal">&times;</span>
                            <div class="title" style="font-size: 1.5rem; margin-bottom: 1.5rem;">
                                Download Results
                            </div>
                            <p style="color: var(--text-secondary); font-size: 1rem; margin-bottom: 2rem;">
                                Select in what form/s you want to save the results
                            </p>
                            <div style="display: flex; flex-direction: column; gap: 1.25rem; margin-bottom: 2rem;">
                                <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.75rem; background: var(--background-color); border-radius: 0.5rem; transition: all 0.2s ease;">
                                    <input type="checkbox" class="format-checkbox" value="csv" style="width: 1.25rem; height: 1.25rem; cursor: pointer;">
                                    <span style="color: var(--text-primary); font-size: 1rem;">CSV</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.75rem; background: var(--background-color); border-radius: 0.5rem; transition: all 0.2s ease;">
                                    <input type="checkbox" class="format-checkbox" value="tsv" style="width: 1.25rem; height: 1.25rem; cursor: pointer;">
                                    <span style="color: var(--text-primary); font-size: 1rem;">TSV</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.75rem; background: var(--background-color); border-radius: 0.5rem; transition: all 0.2s ease;">
                                    <input type="checkbox" class="format-checkbox" value="json" style="width: 1.25rem; height: 1.25rem; cursor: pointer;">
                                    <span style="color: var(--text-primary); font-size: 1rem;">JSON</span>
                                </label>
                            </div>
                            <button class="primary-button download-save-btn" 
                                    style="background-color: var(--primary-color); width: 100%; padding: 1rem; border-radius: 0.5rem; color: white; font-weight: 600; transition: all 0.2s ease;">
                                Save
                            </button>
                        </div>
                    `;
                    const labels = modal.querySelectorAll('label');
                    labels.forEach(label => {
                        label.addEventListener('mouseover', () => {
                            label.style.background = 'var(--card-background)';
                        });
                        label.addEventListener('mouseout', () => {
                            label.style.background = 'var(--background-color)';
                        });
                    });
                    document.body.appendChild(modal);
                    toggleModalState(true);
                    const saveButton = modal.querySelector('.download-save-btn');
                    saveButton.addEventListener('click', async () => {
                        console.log('[TaxaGO] Save button clicked');
                        const selectedFormats = Array.from(modal.querySelectorAll('.format-checkbox:checked'))
                            .map(checkbox => checkbox.value);
                        console.log('[TaxaGO] Selected formats:', selectedFormats);
                        if (selectedFormats.length === 0) {
                            alert('Please select at least one format');
                            return;
                        }
                        try {
                            saveButton.classList.add('loading');
                            async function downloadWithDelay(formats) {
                                for (const format of formats) {
                                    const link = document.createElement('a');
                                    link.style.display = 'none';
                                    document.body.appendChild(link);
                                    const response = await fetch(`/download/${format}`);
                                    if (!response.ok) {
                                        throw new Error(`Download failed for ${format}`);
                                    }
                                    let filename = `results.${format}`;
                                    const contentDisposition = response.headers.get('Content-Disposition');
                                    if (contentDisposition) {
                                        const filenameMatch = contentDisposition.match(/filename="(.+?)"/);
                                        if (filenameMatch && filenameMatch[1]) {
                                            filename = filenameMatch[1];
                                        }
                                    }
                                    const blob = await response.blob();
                                    const url = window.URL.createObjectURL(blob);
                                    link.href = url;
                                    link.download = filename;
                                    link.click();
                                    window.URL.revokeObjectURL(url);
                                    document.body.removeChild(link);
                                    console.log(`[TaxaGO] Downloaded ${filename}`);
                                    await new Promise(res => setTimeout(res, 500));
                                }
                            }
                            await downloadWithDelay(selectedFormats);
                            document.body.removeChild(modal);
                            toggleModalState(false);
                        } catch (error) {
                            console.error('Error downloading files:', error);
                            alert('Error downloading files. Please try again.');
                        } finally {
                            saveButton.classList.remove('loading');
                        }
                    });
                    const closeButton = modal.querySelector('.close-modal');
                    closeButton.addEventListener('click', () => {
                        document.body.removeChild(modal);
                        toggleModalState(false);
                    });
                    modal.addEventListener('click', (event) => {
                        if (event.target === modal) {
                            document.body.removeChild(modal);
                            toggleModalState(false);
                        }
                    });
                });
            } else {
                console.error('[TaxaGO] Download button not found');
            }
        });
    </script>
</head>
<body>
    <div id="modal-backdrop" class="modal-backdrop"></div>
    <div id="global-loading-container" class="loading-container">
        <div class="loading-text">Processing your request...</div>
    </div>

    <div id="diagram-fullscreen-container">
        <div class="fullscreen-controls">
            <div style="display: flex; gap: 0.5rem;">
                <a href="/ancestor-graph" download="ancestor_graph.pdf" class="fullscreen-button" style="background-color: var(--success-color);">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Download PDF
                </a>
            </div>
            <button class="fullscreen-button close-fullscreen-button" onclick="toggleDiagramFullscreen()">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
                Close Fullscreen
            </button>
        </div>
        <div id="fullscreen-diagram-content"></div>
    </div>

    <div id="similarity-fullscreen-container">
        <div class="fullscreen-controls">
            <div style="display: flex; gap: 0.5rem;">
                <button class="fullscreen-button" id="download-similarity-csv" style="background-color: var(--success-color);">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Download CSV
                </button>
            </div>
            <button class="fullscreen-button close-fullscreen-button" id="close-similarity-fullscreen">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
                Close Fullscreen
            </button>
        </div>
        <div id="fullscreen-similarity-content"></div>
    </div>
    
    <div class="main-container">
        <h1 class="title">TaxaGO Results</h1>

        <div class="function-buttons-container">
            <div class="primary-actions">
                <button class="primary-button download-button">Download Results</button>
                <button class="primary-button" style="background-color: var(--text-secondary)" onclick="clearDataAndRedirect()">New Analysis</button>
                <button class="primary-button" style="background-color: var(--text-tertiary)" onclick="window.location.href='/loading?subsequent=true&odds_ratio_threshold=1.0&n_protein_threshold=1'">Change Results</button>
            </div>
            <div class="secondary-actions">
                <button class="secondary-button">Ancestor Analysis</button>
                <button class="secondary-button">Semantic Similarity</button>
            </div>
        </div>

        <div class="results-table-container">
            <div class="table-scroll-container">
                <table class="results-table">
                    <thead>
                        <tr>
                        </tr>
                    </thead>
                    <tbody id="results-body">
                    </tbody>
                </table>
            </div>

            <button id="show-all-button" class="show-all-button">
                Show All Results
            </button>
        </div>

        <div class="plots-container">
            <div class="tab-container" style="margin-bottom: 1.5rem;">
                <div style="display: flex; gap: 1rem;">
                    <button class="tab-button active" data-plot-tab="biological-process-plots">
                        Biological Process
                    </button>
                    <button class="tab-button" data-plot-tab="molecular-function-plots">
                        Molecular Function
                    </button>
                    <button class="tab-button" data-plot-tab="cellular-component-plots">
                        Cellular Component
                    </button>
                </div>
            </div>

            <div class="plot-tab-content active" id="biological-process-plots">
                <div class="plots-grid">
                    <div class="main-plot">
                        <div class="plot-loading">Loading plot...</div>
                        <iframe id="bp-plot1" class="plot-frame" src="/plots/bp_bar.html" style="width: 100%; height: 100%; border: none;"></iframe>
                    </div>
                    
                    <div class="secondary-plots">
                        <div class="secondary-plot">
                            <div class="plot-loading">Loading plot...</div>
                            <iframe id="bp-plot2" class="plot-frame" src="/plots/bp_bubble.html" style="width: 100%; height: 100%; border: none;"></iframe>
                        </div>
                        <div class="secondary-plot">
                            <div class="plot-loading">Loading plot...</div>
                            <iframe id="bp-plot3" class="plot-frame" src="/plots/bp_network.html" style="width: 100%; height: 100%; border: none;"></iframe>
                        </div>
                    </div>
                </div>
            </div>

            <div class="plot-tab-content" id="molecular-function-plots">
                <div class="plots-grid">
                    <div class="main-plot">
                        <div class="plot-loading">Loading plot...</div>
                        <iframe id="mf-plot1" class="plot-frame" src="/plots/mf_bar.html" style="width: 100%; height: 100%; border: none;"></iframe>
                    </div>
                    
                    <div class="secondary-plots">
                        <div class="secondary-plot">
                            <div class="plot-loading">Loading plot...</div>
                            <iframe id="mf-plot2" class="plot-frame" src="/plots/mf_bubble.html" style="width: 100%; height: 100%; border: none;"></iframe>
                        </div>
                        <div class="secondary-plot">
                            <div class="plot-loading">Loading plot...</div>
                            <iframe id="mf-plot3" class="plot-frame" src="/plots/mf_network.html" style="width: 100%; height: 100%; border: none;"></iframe>
                        </div>
                    </div>
                </div>
            </div>

            <div class="plot-tab-content" id="cellular-component-plots">
                <div class="plots-grid">
                    <div class="main-plot">
                        <div class="plot-loading">Loading plot...</div>
                        <iframe id="cc-plot1" class="plot-frame" src="/plots/cc_bar.html" style="width: 100%; height: 100%; border: none;"></iframe>
                    </div>
                    
                    <div class="secondary-plots">
                        <div class="secondary-plot">
                            <div class="plot-loading">Loading plot...</div>
                            <iframe id="cc-plot2" class="plot-frame" src="/plots/cc_bubble.html" style="width: 100%; height: 100%; border: none;"></iframe>
                        </div>
                        <div class="secondary-plot">
                            <div class="plot-loading">Loading plot...</div>
                            <iframe id="cc-plot3" class="plot-frame" src="/plots/cc_network.html" style="width: 100%; height: 100%; border: none;"></iframe>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const plotTabButtons = document.querySelectorAll('[data-plot-tab]');
                const plotTabContents = document.querySelectorAll('.plot-tab-content');

                function checkPlotExists(url, callback) {
                    fetch(url, { method: 'HEAD' })
                        .then(response => {
                            callback(response.ok);
                        })
                        .catch(() => {
                            callback(false);
                        });
                }

                function setupIframeErrorHandling() {
                    document.querySelectorAll('iframe.plot-frame').forEach(iframe => {
                        const newIframe = iframe.cloneNode(true);
                        iframe.parentNode.replaceChild(newIframe, iframe);
                        
                        const loadTimeout = setTimeout(() => {
                            const loadingEl = newIframe.parentElement.querySelector('.plot-loading');
                            if (loadingEl) {
                                loadingEl.textContent = 'Plot is taking longer than expected to load...';
                            }
                        }, 10000);
                        
                        newIframe.addEventListener('load', function() {
                            clearTimeout(loadTimeout);
                            
                            const loadingEl = this.parentElement.querySelector('.plot-loading');
                            if (loadingEl) {
                                loadingEl.style.display = 'none';
                            }
                            
                            try {
                                if (this.contentDocument && 
                                    (this.contentDocument.title.includes('Error: Plot Not Found') || 
                                     this.contentDocument.body.textContent.includes('Plot Not Found') ||
                                     this.contentDocument.body.classList.contains('plot-error-page'))) {
                                    
                                    const id = this.id || '';
                                    let namespace = 'Unknown';
                                    let plotType = 'plot';
                                    
                                    if (id.startsWith('bp')) {
                                        namespace = 'Biological Process';
                                    } else if (id.startsWith('mf')) {
                                        namespace = 'Molecular Function';
                                    } else if (id.startsWith('cc')) {
                                        namespace = 'Cellular Component';
                                    }
                                    
                                    if (id.includes('plot1')) {
                                        plotType = 'bar plot';
                                    } else if (id.includes('plot2')) {
                                        plotType = 'bubble plot';
                                    } else if (id.includes('plot3')) {
                                        plotType = 'network plot';
                                    }
                                    
                                    this.parentElement.innerHTML = `<div class="no-plot-message">No ${plotType} available for ${namespace}</div>`;
                                }
                            } catch (e) {
                                console.log('Cannot check iframe content:', e);
                            }
                        });
                        
                        newIframe.addEventListener('error', function() {
                            clearTimeout(loadTimeout);
                            
                            const id = this.id || '';
                            let namespace = 'Unknown';
                            let plotType = 'plot';
                            
                            if (id.startsWith('bp')) {
                                namespace = 'Biological Process';
                            } else if (id.startsWith('mf')) {
                                namespace = 'Molecular Function';
                            } else if (id.startsWith('cc')) {
                                namespace = 'Cellular Component';
                            }
                            
                            if (id.includes('plot1')) {
                                plotType = 'bar plot';
                            } else if (id.includes('plot2')) {
                                plotType = 'bubble plot';
                            } else if (id.includes('plot3')) {
                                plotType = 'network plot';
                            }
                            
                            this.parentElement.innerHTML = `<div class="no-plot-message">No ${plotType} available for ${namespace}</div>`;
                        });
                    });
                    
                    document.querySelectorAll('img.plot-frame').forEach(img => {
                        img.addEventListener('load', function() {
                            const loadingEl = this.parentElement.querySelector('.plot-loading');
                            if (loadingEl) {
                                loadingEl.style.display = 'none';
                            }
                        });
                    });
                }

                function checkNamespacePlots(namespace) {
                    let barExists = false;
                    let bubbleExists = false;
                    let networkExists = false;
                    
                    checkPlotExists(`/plots/${namespace}_bar_plot.html`, exists => {
                        barExists = exists;
                        const plotContainer = document.querySelector(`#${namespace}-plots .main-plot`);
                        if (!exists && plotContainer) {
                            plotContainer.innerHTML = `<div class="no-plot-message">No bar plot available for ${namespace.toUpperCase().replace('bp', 'Biological Process').replace('mf', 'Molecular Function').replace('cc', 'Cellular Component')}</div>`;
                        }
                        checkAllPlots();
                    });

                    checkPlotExists(`/plots/${namespace}_bubble_plot.html`, exists => {
                        bubbleExists = exists;
                        const plotContainer = document.querySelector(`#${namespace}-plots .secondary-plot:first-of-type`);
                        if (!exists && plotContainer) {
                            plotContainer.innerHTML = `<div class="no-plot-message">No bubble plot available for ${namespace.toUpperCase().replace('bp', 'Biological Process').replace('mf', 'Molecular Function').replace('cc', 'Cellular Component')}</div>`;
                        }
                        checkAllPlots();
                    });

                    checkPlotExists(`/plots/${namespace}_network_plot.html`, exists => {
                        networkExists = exists;
                        const plotContainer = document.querySelector(`#${namespace}-plots .secondary-plot:last-of-type`);
                        if (!exists && plotContainer) {
                            plotContainer.innerHTML = `<div class="no-plot-message">No network plot available for ${namespace.toUpperCase().replace('bp', 'Biological Process').replace('mf', 'Molecular Function').replace('cc', 'Cellular Component')}</div>`;
                        }
                        checkAllPlots();
                    });

                    function checkAllPlots() {
                        if (!barExists && !bubbleExists && !networkExists) {
                            const tabContent = document.querySelector(`#${namespace}-plots`);
                            if (tabContent) {
                                tabContent.innerHTML = `<div class="no-plots-message">No plots available for ${namespace.toUpperCase().replace('bp', 'Biological Process').replace('mf', 'Molecular Function').replace('cc', 'Cellular Component')}</div>`;
                            }
                        }
                    }
                }

                checkNamespacePlots('bp');
                checkNamespacePlots('mf');
                checkNamespacePlots('cc');
                
                setupIframeErrorHandling();

                plotTabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const currentActiveButton = document.querySelector('.tab-button[data-plot-tab].active');
                        const currentActiveTabContentElement = document.querySelector('.plot-tab-content.active');

                        if (currentActiveButton) {
                            currentActiveButton.classList.remove('active');
                        }
                        if (currentActiveTabContentElement) {
                            currentActiveTabContentElement.classList.remove('active');
                        }

                        button.classList.add('active');
                        const tabId = button.getAttribute('data-plot-tab');
                        const newActiveTabContent = document.getElementById(tabId);

                        if (newActiveTabContent) {
                            newActiveTabContent.classList.add('active'); 

                            requestAnimationFrame(() => {
                                const plotsGrid = newActiveTabContent.querySelector('.plots-grid');
                                const iframesInActiveTab = newActiveTabContent.querySelectorAll('iframe.plot-frame');

                                if (plotsGrid) {


                                    const originalOpacity = plotsGrid.style.opacity;
                                    plotsGrid.style.opacity = '0.9999'; 
                                    plotsGrid.offsetHeight; 
                                    plotsGrid.style.opacity = originalOpacity || ''; 
                                }

                                iframesInActiveTab.forEach(iframe => {
                                    const parentPlotElement = iframe.parentElement; 
                                    const loadingIndicator = parentPlotElement ? parentPlotElement.querySelector('.plot-loading') : null;

                                    if (parentPlotElement) {
                                        const originalDisplay = parentPlotElement.style.display;
                                        parentPlotElement.style.display = 'none';
                                        parentPlotElement.offsetHeight; 
                                        parentPlotElement.style.display = originalDisplay || '';
                                    }

                                    const currentSrc = iframe.getAttribute('src');

                                    if (currentSrc && currentSrc.trim() !== '' && currentSrc !== 'about:blank' && newActiveTabContent.id !== 'biological-process-plots') {
                                        if (iframe.dataset.isReloading !== 'true') {
                                            iframe.dataset.isReloading = 'true';

                                            if (loadingIndicator) {
                                                loadingIndicator.style.display = 'flex';
                                            }
                                            iframe.style.opacity = '0';

                                            const handleLoad = () => {
                                                if (loadingIndicator) {
                                                    loadingIndicator.style.display = 'none';
                                                }
                                                iframe.style.opacity = '1';
                                                cleanupListeners();
                                            };

                                            const handleError = () => {
                                                if (loadingIndicator) {
                                                    loadingIndicator.style.display = 'none';
                                                }
                                                if (parentPlotElement) {
                                                    const id = iframe.id || '';
                                                    let namespace = 'Unknown', plotType = 'plot';
                                                    if (id.startsWith('bp')) namespace = 'Biological Process';
                                                    else if (id.startsWith('mf')) namespace = 'Molecular Function';
                                                    else if (id.startsWith('cc')) namespace = 'Cellular Component';
                                                    if (id.includes('plot1')) plotType = 'bar plot';
                                                    else if (id.includes('plot2')) plotType = 'bubble plot';
                                                    else if (id.includes('plot3')) plotType = 'network plot';
                                                    parentPlotElement.innerHTML = `<div class="no-plot-message">Error loading ${plotType} for ${namespace}.</div>`;
                                                }
                                                cleanupListeners();
                                            };

                                            const cleanupListeners = () => {
                                                iframe.removeEventListener('load', handleLoad);
                                                iframe.removeEventListener('error', handleError);
                                                delete iframe.dataset.isReloading; 
                                            };

                                            iframe.addEventListener('load', handleLoad);
                                            iframe.addEventListener('error', handleError);

                                            iframe.src = 'about:blank'; 
                                            setTimeout(() => {
                                                iframe.src = currentSrc;
                                            }, 30); 
                                        }
                                    } else if (loadingIndicator) {
                                        try {
                                            if (iframe.contentWindow && iframe.contentWindow.document.readyState === 'complete') {
                                                loadingIndicator.style.display = 'none';
                                            }
                                        } catch (e) {
                                        }
                                    }
                                });
                            });
                        }
                    });
                });
            });
        </script>

        <div id="full-results-modal" class="modal">
            <div class="modal-content">
                <span class="close-modal" id="close-modal">&times;</span>
                <div class="title" style="font-size: 1.5rem; margin-bottom: 1.5rem;">All Results</div>
                
                <div class="tab-container">
                    <button class="tab-button active" data-namespace="all-results">All Results</button>
                    <button class="tab-button" data-namespace="biological-process">Biological Process</button>
                    <button class="tab-button" data-namespace="molecular-function">Molecular Function</button>
                    <button class="tab-button" data-namespace="cellular-component">Cellular Component</button>
                </div>

                <div class="table-container">
                    <div class="tab-content active" id="modal-all-results-content">
                        <table class="results-table">
                            <thead>
                                <tr>
                                </tr>
                            </thead>
                            <tbody id="modal-all-results-body">
                            </tbody>
                        </table>
                    </div>

                    <div class="tab-content" id="modal-biological-process-content">
                        <table class="results-table">
                            <thead>
                                <tr>
                                </tr>
                            </thead>
                            <tbody id="modal-biological-process-body">
                            </tbody>
                        </table>
                    </div>

                    <div class="tab-content" id="modal-molecular-function-content">
                        <table class="results-table">
                            <thead>
                                <tr>
                                </tr>
                            </thead>
                            <tbody id="modal-molecular-function-body">
                            </tbody>
                        </table>
                    </div>

                    <div class="tab-content" id="modal-cellular-component-content">
                        <table class="results-table">
                            <thead>
                                <tr>
                                </tr>
                            </thead>
                            <tbody id="modal-cellular-component-body">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="ancestor-analysis-modal" class="modal">
            <div class="modal-content">
                <span class="close-modal" id="close-ancestor-modal">&times;</span>
                <div class="modal-header">
                    <div class="title" style="font-size: 1.5rem; margin-bottom: 1rem;">Ancestor Analysis</div>
                    <p style="color: var(--text-secondary);">
                        Analyze common ancestors between GO terms to understand their relationships in the GO hierarchy. This tool helps you visualize how selected GO terms are related through their shared parent terms.
                    </p>
                </div>
                
                <div class="modal-body">
                    <div class="form-section">
                        <div class="form-group">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <label class="form-label" style="margin-bottom: 0;">Select GO Terms for Analysis</label>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button id="select-all-terms-btn" class="secondary-button" style="font-size: 0.875rem; padding: 0.25rem 0.75rem; background-color: var(--background-color); color: var(--text-secondary);">
                                        Select All
                                    </button>
                                    <button id="clear-all-terms-btn" class="secondary-button" style="font-size: 0.875rem; padding: 0.25rem 0.75rem; background-color: var(--background-color); color: var(--text-secondary);">
                                        Clear All
                                    </button>
                                </div>
                            </div>
                            <p style="color: var(--text-tertiary); font-size: 0.875rem; margin-top: 0.25rem; margin-bottom: 0.75rem;">
                                Select at least two GO terms to analyze their relationships and common ancestors in the GO hierarchy.
                            </p>
                            <div class="selected-terms-container" style="margin-bottom: 1rem;">
                                <div id="selected-terms-list" class="selected-terms-list">
                                    <p style="color: var(--text-tertiary); font-style: italic;">No terms selected yet</p>
                                </div>
                            </div>
                            
                            <div class="term-selection-controls">
                                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                                    <button id="select-from-results-btn" class="secondary-button" style="flex: 1;">
                                        Select from Results
                                    </button>
                                    <button id="enter-go-term-btn" class="secondary-button" style="flex: 1;">
                                        Enter GO Term ID
                                    </button>
                                </div>
                            </div>
                            
                            <div id="manual-go-entry" style="display: none; margin-bottom: 1rem;">
                                <div style="display: flex; gap: 0.5rem;">
                                    <input type="text" id="go-term-input" class="form-input" placeholder="Enter GO:0000000 format" 
                                           style="flex: 1;" pattern="GO:[0-9]{7}">
                                    <button id="add-go-term-btn" class="secondary-button">Add</button>
                                </div>
                                <p id="go-term-error" style="color: var(--error-color); font-size: 0.875rem; margin-top: 0.5rem; display: none;">
                                    Please enter a valid GO term ID in the format GO:0000000
                                </p>
                            </div>
                        </div>
                        
                        <button id="run-ancestor-analysis" class="primary-button" style="width: 100%; margin-top: 1.5rem;" disabled>
                            <span class="btn-text">Run Analysis</span>
                            <span class="spinner"></span>
                        </button>
                    </div>
                    
                    <div id="ancestor-analysis-results" style="display: none; margin-top: 2rem;">
                        <h3 style="font-size: 1.25rem; margin-bottom: 1rem;">Analysis Results</h3>
                        <div id="ancestor-graph-container">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="semantic-similarity-modal" class="modal">
            <div class="modal-content">
                <span class="close-modal" id="close-semantic-modal">&times;</span>
                <div class="modal-header">
                    <div class="title" style="font-size: 1.5rem; margin-bottom: 1rem;">Semantic Similarity</div>
                    <p style="color: var(--text-secondary);">
                        Calculate semantic similarity between GO terms to quantify their functional relatedness. This tool helps you understand how similar GO terms are based on their positions in the GO hierarchy.
                    </p>
                </div>
                
                <div class="modal-body">
                    <div class="form-section">
                        <div class="form-group">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <label class="form-label" style="margin-bottom: 0;">Select GO Terms for Similarity Analysis</label>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button id="semantic-select-all-terms-btn" class="secondary-button" style="font-size: 0.875rem; padding: 0.25rem 0.75rem; background-color: var(--background-color); color: var(--text-secondary);">
                                        Select All
                                    </button>
                                    <button id="semantic-clear-all-terms-btn" class="secondary-button" style="font-size: 0.875rem; padding: 0.25rem 0.75rem; background-color: var(--background-color); color: var(--text-secondary);">
                                        Clear All
                                    </button>
                                </div>
                            </div>
                            <p style="color: var(--text-tertiary); font-size: 0.875rem; margin-top: 0.25rem; margin-bottom: 0.75rem;">
                                Select at least two GO terms to analyze their semantic similarity.
                            </p>
                            <div class="selected-terms-container" style="margin-bottom: 1rem;">
                                <div id="semantic-selected-terms-list" class="selected-terms-list">
                                    <p style="color: var(--text-tertiary); font-style: italic;">No terms selected yet</p>
                                </div>
                            </div>
                            
                            <div class="term-selection-controls">
                                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                                    <button id="semantic-select-from-results-btn" class="secondary-button" style="flex: 1;">
                                        Select from Results
                                    </button>
                                    <button id="semantic-enter-go-term-btn" class="secondary-button" style="flex: 1;">
                                        Enter GO Term ID
                                    </button>
                                </div>
                            </div>
                            
                            <div id="semantic-manual-go-entry" style="display: none; margin-bottom: 1rem;">
                                <div style="display: flex; gap: 0.5rem;">
                                    <input type="text" id="semantic-go-term-input" class="form-input" placeholder="Enter GO:0000000 format" 
                                           style="flex: 1;" pattern="GO:[0-9]{7}">
                                    <button id="semantic-add-go-term-btn" class="secondary-button">Add</button>
                                </div>
                                <p id="semantic-go-term-error" style="color: var(--error-color); font-size: 0.875rem; margin-top: 0.5rem; display: none;">
                                    Please enter a valid GO term ID in the format GO:0000000
                                </p>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Similarity Method</label>
                            <p style="color: var(--text-tertiary); font-size: 0.875rem; margin-top: 0.25rem; margin-bottom: 0.75rem;">
                                Select the method to calculate semantic similarity between GO terms.
                            </p>
                            <div class="method-selection-container">
                                <label class="method-option">
                                    <input type="radio" name="similarity-method" value="resnik" checked>
                                    <div class="method-content">
                                        <span class="method-name">Resnik</span>
                                        <span class="method-description">Information content of common ancestor</span>
                                    </div>
                                </label>
                                <label class="method-option">
                                    <input type="radio" name="similarity-method" value="lin">
                                    <div class="method-content">
                                        <span class="method-name">Lin</span>
                                        <span class="method-description">Normalized information content</span>
                                    </div>
                                </label>
                                <label class="method-option">
                                    <input type="radio" name="similarity-method" value="jiang-conrath">
                                    <div class="method-content">
                                        <span class="method-name">Jiang-Conrath</span>
                                        <span class="method-description">Distance-based measure</span>
                                    </div>
                                </label>
                                <label class="method-option">
                                    <input type="radio" name="similarity-method" value="wang">
                                    <div class="method-content">
                                        <span class="method-name">Wang</span>
                                        <span class="method-description">Graph-based similarity</span>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <button id="run-semantic-similarity" class="primary-button" style="width: 100%; margin-top: 1.5rem;" disabled>
                            <span class="btn-text">Run Analysis</span>
                            <span class="spinner"></span>
                        </button>
                    </div>
                    
                    <div id="semantic-similarity-results" style="display: none; margin-top: 2rem;">
                        <h3 style="font-size: 1.25rem; margin-bottom: 1rem;">Similarity Results</h3>
                        <div id="similarity-results-container">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            function formatScientific(num) {
                if (num === undefined || num === null || num === '') return '-';
                if (num === 0) return "0";
                if (typeof num === 'string') {
                    num = parseFloat(num);
                    if (isNaN(num)) return '-';
                }
                
                if (num < 0.0001) {
                    return num.toExponential(2);
                }
                
                return num.toFixed(6);
            }

            function formatNumber(num) {
                if (num === undefined || num === null || num === '') return '-';
                if (num === 0) return "0";
                if (typeof num === 'string') {
                    num = parseFloat(num);
                    if (isNaN(num)) return '-';
                }
                return num.toFixed(2);
            }

            let allResults = [];
            let currentSortColumn = null;
            let currentSortDirection = null;

            function sortData(data, column, type, direction) {
                return [...data].sort((a, b) => {
                    let valueA = a[column];
                    let valueB = b[column];
                    
                    if (column === 3) { 
                        valueA = valueA === "inf" ? Infinity : parseFloat(valueA) || 0;
                        valueB = valueB === "inf" ? Infinity : parseFloat(valueB) || 0;
                        
                        if (valueA === valueB) {
                            const pValueA = parseFloat(a[4]) || 0;
                            const pValueB = parseFloat(b[4]) || 0;
                            return direction === 'asc' ? pValueA - pValueB : pValueB - pValueA;
                        }
                    } else if (type === 'numeric') {
                        valueA = parseFloat(valueA) || 0;
                        valueB = parseFloat(valueB) || 0;
                    }
                    
                    if (direction === 'asc') {
                        return valueA > valueB ? 1 : valueA < valueB ? -1 : 0;
                    } else {
                        return valueA < valueB ? 1 : valueA > valueB ? -1 : 0;
                    }
                });
            }

            function initializeTableSorting(table) {
                if (!table) return;
                
                table.querySelectorAll('.sortable-header').forEach(header => {
                    header.addEventListener('click', function() {
                        const tbody = this.closest('table').querySelector('tbody');
                        const column = parseInt(this.dataset.column);
                        const type = this.dataset.type;
                        
                        table.querySelectorAll('.sortable-header').forEach(h => {
                            if (h !== header) {
                                h.querySelector('.sort-arrow').className = 'sort-arrow';
                            }
                        });
                        
                        let direction;
                        const arrow = this.querySelector('.sort-arrow');
                        
                        if (currentSortColumn !== column) {
                            direction = type === 'numeric' ? 'desc' : 'asc';
                        } else {
                            direction = currentSortDirection === 'asc' ? 'desc' : 'asc';
                        }
                        
                        arrow.className = `sort-arrow active ${direction}`;
                        currentSortColumn = column;
                        currentSortDirection = direction;
                        
                        const activeTab = document.querySelector('.results-table-container .tab-button.active');
                        const currentNamespace = activeTab ? activeTab.getAttribute('data-tab') : 'all-results';
                        
                        let dataToSort = currentNamespace === 'all-results' ? 
                            allResults : 
                            allResults.filter(row => row[2].toLowerCase().replace(' ', '-') === currentNamespace);
                        
                        const sortedData = sortData(dataToSort, column, type === 'numeric' ? 'number' : 'string', direction);
                        
                        tbody.innerHTML = '';
                        for (let i = 0; i < Math.min(10, sortedData.length); i++) {
                            tbody.appendChild(createTableRow(sortedData[i]));
                        }
                    });
                });
            }

            function displayNamespaceResults(namespace) {
                const tbody = document.getElementById('results-body');
                tbody.innerHTML = '';
                
                let results = namespace === 'all-results' ? 
                    allResults : 
                    allResults.filter(columns => columns[2].toLowerCase().replace(' ', '-') === namespace);
                
                if (results.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                No results found for ${namespace.replace('-', ' ')}.
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                for (let i = 0; i < Math.min(10, results.length); i++) {
                    tbody.appendChild(createTableRow(results[i]));
                }
            }

            function initializeTabSwitching() {
                const tabButtons = document.querySelectorAll('.results-table-container .tab-button');
                
                tabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const namespace = button.getAttribute('data-tab');
                        
                        tabButtons.forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        
                        currentSortColumn = null;
                        currentSortDirection = null;
                        document.querySelectorAll('.sort-arrow').forEach(arrow => {
                            arrow.className = 'sort-arrow';
                        });
                        
                        displayNamespaceResults(namespace);
                    });
                });
            }

            function createTableRow(columns) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><a href="https://www.ebi.ac.uk/QuickGO/term/${columns[0]}" 
                           target="_blank" 
                           class="go-term-link">${columns[0]}</a></td>
                    <td>${columns[1]}</td>
                    <td>${columns[2]}</td>
                    <td>${columns[3]}</td>
                    <td class="scientific">${formatScientific(columns[4])}</td>
                `;
                return row;
            }

            const modal = document.getElementById('full-results-modal');
            const closeModal = document.getElementById('close-modal');
            const showAllButton = document.getElementById('show-all-button');

            let currentMainNamespace = 'all-results';
            let currentModalNamespace = 'all-results';

            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    
                    button.classList.add('active');
                    const tabId = button.getAttribute('data-tab');
                    document.getElementById(`${tabId}-content`).classList.add('active');

                    currentMainNamespace = tabId;

                    if (tabId !== 'all-results') {
                        loadNamespaceResults(tabId);
                    }
                });
            });

            document.getElementById('show-all-button').addEventListener('click', function() {
                const modal = document.getElementById('full-results-modal');
                
                modal.classList.add('active');
                document.body.classList.add('modal-open');

                document.querySelectorAll('.results-table-container .sort-arrow').forEach(arrow => {
                    arrow.className = 'sort-arrow';
                });

                const modalTabButtons = modal.querySelectorAll('.tab-button');
                const modalTabContents = modal.querySelectorAll('.tab-content');
                
                const mainTableHeaders = Array.from(document.querySelector('.results-table thead tr').children);
                
                modal.querySelectorAll('.tab-content table thead tr').forEach(thead => {
                    thead.innerHTML = '';
                    
                    mainTableHeaders.forEach(header => {
                        const clonedHeader = header.cloneNode(true);
                        thead.appendChild(clonedHeader);
                    });
                });

                modal.querySelectorAll('.tab-content table').forEach(table => {
                    table.querySelectorAll('.sortable-header').forEach(header => {
                        header.addEventListener('click', function() {
                            const tbody = this.closest('table').querySelector('tbody');
                            const column = parseInt(this.dataset.column);
                            const type = this.dataset.type;
                            
                            table.querySelectorAll('.sortable-header').forEach(h => {
                                if (h !== header) {
                                    const arrow = h.querySelector('.sort-arrow');
                                    if (arrow) arrow.className = 'sort-arrow';
                                }
                            });
                            
                            let direction;
                            const arrow = this.querySelector('.sort-arrow');
                            if (!arrow) return;
                            
                            const currentDirection = this.getAttribute('data-sort') || 'none';
                            const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
                            
                            this.setAttribute('data-sort', newDirection);
                            arrow.className = `sort-arrow active ${newDirection}`;
                            
                            const rows = Array.from(tbody.querySelectorAll('tr'));
                            const sortedRows = rows.sort((rowA, rowB) => {
                                if (!rowA.cells[column] || !rowB.cells[column]) return 0;
                                
                                const cellA = rowA.cells[column].textContent.trim();
                                const cellB = rowB.cells[column].textContent.trim();
                                
                                if (type === 'numeric') {
                                    let numA = cellA === "inf" ? Infinity : parseFloat(cellA) || 0;
                                    let numB = cellB === "inf" ? Infinity : parseFloat(cellB) || 0;
                                    
                                    if (column === 3 && numA === numB) {
                                        const pValueA = parseFloat(rowA.cells[4]?.textContent.trim()) || 0;
                                        const pValueB = parseFloat(rowB.cells[4]?.textContent.trim()) || 0;
                                        return newDirection === 'asc' ? pValueA - pValueB : pValueB - pValueA;
                                    }
                                    
                                    return newDirection === 'asc' ? numA - numB : numB - numA;
                                } else {
                                    return newDirection === 'asc' 
                                        ? cellA.localeCompare(cellB) 
                                        : cellB.localeCompare(cellA);
                                }
                            });
                            
                            tbody.innerHTML = '';
                            sortedRows.forEach(row => tbody.appendChild(row));
                        });
                    });
                });

                function populateModalTable(namespace) {
                    const nsName = namespace.toLowerCase().replace(' ', '-');
                    const tbody = modal.querySelector(`#modal-${nsName}-body`);
                    
                    tbody.innerHTML = Array(5).fill(`
                        <tr class="loading-row">
                            ${Array(mainTableHeaders.length).fill('<td class="loading-skeleton">&nbsp;</td>').join('')}
                        </tr>
                    `).join('');

                    let namespaceResults = nsName === 'all-results' 
                        ? allResults 
                        : allResults.filter(columns => {
                            const resultNs = columns[2].toLowerCase().replace(' ', '-');
                            return resultNs === nsName;
                        });

                    namespaceResults.sort((a, b) => {
                        const oddsRatioA = a[3] === "inf" ? Infinity : parseFloat(a[3]) || 0;
                        const oddsRatioB = b[3] === "inf" ? Infinity : parseFloat(b[3]) || 0;
                        const oddsRatioDiff = oddsRatioB - oddsRatioA;
                        
                        if (Math.abs(oddsRatioDiff) < 0.0001) {
                            const statSigA = parseFloat(a[4]) || 0;
                            const statSigB = parseFloat(b[4]) || 0;
                            return statSigA - statSigB;
                        }
                        
                        return oddsRatioDiff;
                    });

                    tbody.innerHTML = '';

                    if (namespaceResults.length > 0) {
                        namespaceResults.forEach(result => {
                            tbody.appendChild(createTableRow(result));
                        });
                    } else {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="${mainTableHeaders.length}" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                    No results found for ${namespace.replace('-', ' ')}.
                                </td>
                            </tr>
                        `;
                    }
                }

                modalTabButtons.forEach(btn => {
                    const namespace = btn.dataset.namespace;
                    if (namespace === currentMainNamespace) {
                        modalTabButtons.forEach(b => b.classList.remove('active'));
                        modalTabContents.forEach(content => content.classList.remove('active'));
                        
                        btn.classList.add('active');
                        modal.querySelector(`#modal-${namespace}-content`).classList.add('active');
                        
                        currentModalNamespace = namespace;
                        
                        populateModalTable(namespace);
                    }
                });

                modalTabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const namespace = button.dataset.namespace;
                        
                        modalTabButtons.forEach(btn => btn.classList.remove('active'));
                        modalTabContents.forEach(content => content.classList.remove('active'));
                        
                        button.classList.add('active');
                        modal.querySelector(`#modal-${namespace}-content`).classList.add('active');
                        
                        currentModalNamespace = namespace;
                        
                        populateModalTable(namespace);
                    });
                });

                const closeHandler = () => {
                    modal.classList.remove('active');
                    document.body.classList.remove('modal-open');

                    const mainTabButton = document.querySelector(`.tab-button[data-tab="${currentModalNamespace}"]`);
                    if (mainTabButton) {
                        mainTabButton.click();
                    }
                };

                modal.querySelector('.close-modal').addEventListener('click', closeHandler);

                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeHandler();
                    }
                });
            });

            closeModal.addEventListener('click', () => {
                modal.classList.remove('active');
            });

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });

            document.addEventListener('DOMContentLoaded', function() {
                loadResults();

                initializeFunctionButtons();

                initializeUI();

                const plotTabButtons = document.querySelectorAll('[data-plot-tab]');
                const plotTabContents = document.querySelectorAll('.plot-tab-content');

                plotTabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        plotTabButtons.forEach(btn => btn.classList.remove('active'));
                        plotTabContents.forEach(content => content.classList.remove('active'));

                        button.classList.add('active');
                        const tabId = button.getAttribute('data-plot-tab');
                        document.getElementById(tabId).classList.add('active');

                    });
                });
            });

            function initializeFunctionButtons() {
                let storedSelectedTerms = new Set();

                const ancestorAnalysisButton = document.querySelector('.secondary-button:nth-child(1)');
                ancestorAnalysisButton.addEventListener('click', () => {
                    const modal = document.getElementById('ancestor-analysis-modal');
                    modal.classList.add('active');
                    document.body.classList.add('modal-open');
                });

                const closeAncestorModal = document.getElementById('close-ancestor-modal');
                closeAncestorModal.addEventListener('click', () => {
                    const modal = document.getElementById('ancestor-analysis-modal');
                    modal.classList.remove('active');
                    document.body.classList.remove('modal-open');
                });

                document.getElementById('ancestor-analysis-modal').addEventListener('click', (e) => {
                    if (e.target === document.getElementById('ancestor-analysis-modal')) {
                        document.getElementById('ancestor-analysis-modal').classList.remove('active');
                        document.body.classList.remove('modal-open');
                    }
                });

                initializeAncestorAnalysis();

                const semanticSimilarityButton = document.querySelector('.secondary-button:nth-child(2)');
                semanticSimilarityButton.addEventListener('click', () => {
                    const modal = document.getElementById('semantic-similarity-modal');
                    modal.classList.add('active');
                    document.body.classList.add('modal-open');
                });

                const closeSemanticModal = document.getElementById('close-semantic-modal');
                closeSemanticModal.addEventListener('click', () => {
                    const modal = document.getElementById('semantic-similarity-modal');
                    modal.classList.remove('active');
                    document.body.classList.remove('modal-open');
                });

                document.getElementById('semantic-similarity-modal').addEventListener('click', (e) => {
                    if (e.target === document.getElementById('semantic-similarity-modal')) {
                        document.getElementById('semantic-similarity-modal').classList.remove('active');
                        document.body.classList.remove('modal-open');
                    }
                });

                initializeSemanticSimilarity();

                const pathwayButtonMain = document.querySelector('.secondary-button:nth-child(3)');
                pathwayButtonMain.addEventListener('click', () => {
                    alert('Pathway analysis is coming soon!');
            });

            const downloadButton = document.querySelector('.download-button');
                if (downloadButton) {
            downloadButton.addEventListener('click', () => {
                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 500px; padding: 2rem;">
                        <span class="close-modal">&times;</span>
                        
                        <div class="title" style="font-size: 1.5rem; margin-bottom: 1.5rem;">
                            Download Results
                        </div>
                        
                        <p style="color: var(--text-secondary); font-size: 1rem; margin-bottom: 2rem;">
                            Select in what form/s you want to save the results
                        </p>
                        
                        <div style="display: flex; flex-direction: column; gap: 1.25rem; margin-bottom: 2rem;">
                            <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.75rem; background: var(--background-color); border-radius: 0.5rem; transition: all 0.2s ease;">
                                <input type="checkbox" class="format-checkbox" value="csv" style="width: 1.25rem; height: 1.25rem; cursor: pointer;">
                                <span style="color: var(--text-primary); font-size: 1rem;">CSV</span>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.75rem; background: var(--background-color); border-radius: 0.5rem; transition: all 0.2s ease;">
                                <input type="checkbox" class="format-checkbox" value="tsv" style="width: 1.25rem; height: 1.25rem; cursor: pointer;">
                                <span style="color: var(--text-primary); font-size: 1rem;">TSV</span>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.75rem; background: var(--background-color); border-radius: 0.5rem; transition: all 0.2s ease;">
                                <input type="checkbox" class="format-checkbox" value="json" style="width: 1.25rem; height: 1.25rem; cursor: pointer;">
                                <span style="color: var(--text-primary); font-size: 1rem;">JSON</span>
                            </label>
                        </div>

                        <button class="primary-button download-save-btn" 
                                style="background-color: var(--primary-color); width: 100%; padding: 1rem; border-radius: 0.5rem; color: white; font-weight: 600; transition: all 0.2s ease;">
                            Save
                        </button>
                    </div>
                `;
                
                const labels = modal.querySelectorAll('label');
                labels.forEach(label => {
                    label.addEventListener('mouseover', () => {
                        label.style.background = 'var(--card-background)';
                    });
                    label.addEventListener('mouseout', () => {
                        label.style.background = 'var(--background-color)';
                    });
                });
                
                document.body.appendChild(modal);
                        toggleModalState(true);
                
                const saveButton = modal.querySelector('.download-save-btn');
                saveButton.addEventListener('click', async () => {
                    const selectedFormats = Array.from(modal.querySelectorAll('.format-checkbox:checked'))
                        .map(checkbox => checkbox.value);
                    
                    if (selectedFormats.length === 0) {
                        alert('Please select at least one format');
                        return;
                    }

                    try {
                        saveButton.classList.add('loading');
                        
                        async function downloadWithDelay(formats) {
                            for (const format of formats) {
                                const link = document.createElement('a');
                                link.style.display = 'none';
                                document.body.appendChild(link);
                                const response = await fetch(`/download/${format}`);
                                if (!response.ok) {
                                    throw new Error(`Download failed for ${format}`);
                                }
                                let filename = `results.${format}`;
                                const contentDisposition = response.headers.get('Content-Disposition');
                                if (contentDisposition) {
                                    const filenameMatch = contentDisposition.match(/filename="(.+?)"/);
                                    if (filenameMatch && filenameMatch[1]) {
                                        filename = filenameMatch[1];
                                    }
                                }
                                const blob = await response.blob();
                                const url = window.URL.createObjectURL(blob);
                                link.href = url;
                                link.download = filename;
                                link.click();
                                window.URL.revokeObjectURL(url);
                                document.body.removeChild(link);
                                console.log(`[TaxaGO] Downloaded ${filename}`);
                                await new Promise(res => setTimeout(res, 500));
                            }
                        }
                        await downloadWithDelay(selectedFormats);
                        document.body.removeChild(modal);
                        toggleModalState(false);
                    } catch (error) {
                        console.error('Error downloading files:', error);
                        alert('Error downloading files. Please try again.');
                    } finally {
                        saveButton.classList.remove('loading');
                    }
                });
                
                const closeButton = modal.querySelector('.close-modal');
                closeButton.addEventListener('click', () => {
                    document.body.removeChild(modal);
                            toggleModalState(false);
                });
                
                modal.addEventListener('click', (event) => {
                    if (event.target === modal) {
                        document.body.removeChild(modal);
                                toggleModalState(false);
                    }
                });
            });
                } else {
                    console.error('Download button not found');
                }
        }

        function sortResultsByOddsRatioAndPValue(results) {
            return results.sort((a, b) => {
                const oddsRatioA = a[3] === "inf" ? Infinity : parseFloat(a[3]) || 0;
                const oddsRatioB = b[3] === "inf" ? Infinity : parseFloat(b[3]) || 0;
                
                if (oddsRatioA !== oddsRatioB) {
                    return oddsRatioB - oddsRatioA;
                }
                
                const pValueA = parseFloat(a[4]) || 0;
                const pValueB = parseFloat(b[4]) || 0;
                return pValueA - pValueB;
            });
        }

        function toggleModalState(isOpen) {
            document.body.classList.toggle('modal-open', isOpen);
        }

        async function loadNamespaceResults(namespace) {
            try {
                const tbody = document.querySelector(`#${namespace}-body`);
                const thead = document.querySelector(`#${namespace}-table thead tr`);
                
                tbody.innerHTML = Array(5).fill(0).map(() => `
                    <tr class="loading-row">
                        ${Array(9).fill('<td class="loading-skeleton">&nbsp;</td>').join('')}
                    </tr>
                `).join('');

                const mainTableHeaders = Array.from(document.querySelector('.results-table thead tr').children);
                
                thead.innerHTML = '';
                
                mainTableHeaders.forEach(header => {
                    thead.appendChild(header.cloneNode(true));
                });

                let namespaceResults = allResults.filter(columns => {
                    const nsName = columns[2].toLowerCase().replace(' ', '-');
                    return namespace === nsName;
                });

                tbody.innerHTML = ''; 

                if (namespaceResults.length > 0) {
                    for (let i = 0; i < Math.min(10, namespaceResults.length); i++) {
                        tbody.appendChild(createTableRow(namespaceResults[i]));
                    }
                } else {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="${mainTableHeaders.length}" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                No results found for ${namespace.replace('-', ' ')}.
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error(`Error loading ${namespace} results:`, error);
            }
        }

        const style = document.createElement('style');
        style.textContent = `
            .tab-container {
                border-bottom: 1px solid var(--border-color);
            }
            
            .tab-button {
                padding: 0.5rem 1rem;
                border: none;
                background: none;
                cursor: pointer;
                color: var(--text-secondary);
                font-weight: 500;
                transition: color 0.2s;
            }
            
            .tab-button:hover {
                color: var(--text-primary);
            }
            
            .tab-button.active {
                color: var(--primary-color);
                border-bottom: 2px solid var(--primary-color);
            }
            
            .tab-content {
                display: none;
            }
            
            .tab-content.active {
                display: block;
            }
        `;
        document.head.appendChild(style);

        modal.querySelectorAll('.sortable-header').forEach(header => {
            header.addEventListener('click', function() {
                const table = this.closest('table');
                const tbody = table.querySelector('tbody');
                const column = parseInt(this.dataset.column);
                const type = this.dataset.type;
                
                table.querySelectorAll('.sortable-header').forEach(h => {
                    if (h !== header) {
                        h.querySelector('.sort-arrow').className = 'sort-arrow';
                    }
                });
                
                let direction;
                const arrow = this.querySelector('.sort-arrow');
                const currentDirection = this.getAttribute('data-sort') || 'none';
                const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
                
                this.setAttribute('data-sort', newDirection);
                arrow.className = `sort-arrow active ${newDirection}`;
                
                const rows = Array.from(tbody.querySelectorAll('tr'));
                const sortedRows = rows.sort((rowA, rowB) => {
                    const cellA = rowA.cells[column].textContent.trim();
                    const cellB = rowB.cells[column].textContent.trim();
                    
                    if (type === 'numeric') {
                        let numA = cellA === "inf" ? Infinity : parseFloat(cellA) || 0;
                        let numB = cellB === "inf" ? Infinity : parseFloat(cellB) || 0;
                        return newDirection === 'asc' ? numA - numB : numB - numA;
                    } else {
                        return newDirection === 'asc' 
                            ? cellA.localeCompare(cellB) 
                            : cellB.localeCompare(cellA);
                    }
                });
                
                tbody.innerHTML = '';
                sortedRows.forEach(row => tbody.appendChild(row));
            });
        });

        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.sortable-header').forEach(header => {
                if (!header.hasAttribute('data-full-title')) {
                    header.setAttribute('data-full-title', header.textContent.replace(/|/, '').trim());
                }
            });
        });

        document.addEventListener('DOMContentLoaded', function() {
            const newAnalysisButton = document.querySelector('button[onclick="clearDataAndRedirect()"]');
            if (newAnalysisButton) {
                newAnalysisButton.removeAttribute('onclick');
                newAnalysisButton.addEventListener('click', async function() {
                    try {
                        await fetch('/clear-results', { method: 'POST' });
                        
                        await fetch('/clear-data-folder', { method: 'POST' });
                        
                        window.location.href = '/';
                    } catch (error) {
                        console.error('Error clearing data:', error);
                        window.location.href = '/';
                    }
                });
            }
            
            const changeResultsButton = document.querySelector('button[onclick="window.location.href=\'/loading?subsequent=true&odds_ratio_threshold=1.0&n_protein_threshold=1\'"]');
            if (changeResultsButton) {
                changeResultsButton.removeAttribute('onclick');

                changeResultsButton.disabled = true;
                changeResultsButton.style.backgroundColor = 'var(--text-tertiary)';
                changeResultsButton.style.opacity = '0.6';
                changeResultsButton.style.cursor = 'not-allowed';
                changeResultsButton.title = 'Change Results is not available for single testing';
                
                fetch('/check-testing-type')
                    .then(response => response.json())
                    .then(data => {
                        console.log("Testing type check result:", data); 
                        
                        if (data.is_single_testing === false) {
                            changeResultsButton.disabled = false;
                            changeResultsButton.style.backgroundColor = '';
                            changeResultsButton.style.opacity = '';
                            changeResultsButton.style.cursor = '';
                            changeResultsButton.title = 'Change which results file to display';
                            
                            changeResultsButton.addEventListener('click', function() {
                                showResultsSelectionModal();
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error checking testing type:', error);
                    });
            }
        });

        async function showResultsSelectionModal() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-title">Select Results for Presentation</div>
                    <div class="selection-list" id="selectionList">
                        <!-- Categories will be populated here -->
                    </div>
                    <button class="continue-btn" id="continueBtn" disabled>Continue to Results</button>
                </div>
            `;
            
            const style = document.createElement('style');
            style.textContent = `
                .modal {
                    display: none;
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.5);
                    justify-content: center;
                    align-items: center;
                    z-index: 1000;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                }

                .modal.fade-in {
                    opacity: 1;
                }

                .modal-content {
                    background-color: var(--card-background);
                    padding: 2rem;
                    border-radius: 1rem;
                    box-shadow: 0 8px 16px -1px rgb(0 0 0 / 0.1);
                    max-width: 500px;
                    width: 90%;
                    max-height: 80vh;
                    display: flex;
                    flex-direction: column;
                    transform: translateY(20px);
                    opacity: 0;
                    transition: all 0.3s ease;
                }

                .modal.show .modal-content {
                    transform: translateY(0);
                    opacity: 1;
                }

                .modal-title {
                    font-size: 1.5rem;
                    font-weight: 700;
                    margin-bottom: 1.5rem;
                    color: var(--text-primary);
                    text-align: center;
                    padding-bottom: 1rem;
                    border-bottom: 2px solid var(--border-color);
                }

                .selection-list {
                    flex: 1;
                    overflow-y: auto;
                    margin: 1rem -2rem;
                    padding: 0 2rem;
                    scrollbar-width: thin;
                    scrollbar-gutter: stable;
                }

                .category-group {
                    margin-bottom: 1.5rem;
                    background-color: var(--background-color);
                    border-radius: 0.75rem;
                    overflow: hidden;
                    box-shadow: 0 2px 4px -1px rgb(0 0 0 / 0.05);
                }

                .category-title {
                    font-weight: 600;
                    padding: 1rem;
                    color: var(--text-primary);
                    font-size: 1rem;
                    text-transform: capitalize;
                    background-color: var(--primary-color);
                    color: white;
                }

                .selection-item {
                    display: flex;
                    align-items: center;
                    padding: 1rem;
                    border-bottom: 1px solid var(--border-color);
                    cursor: pointer;
                    transition: all 0.2s ease;
                    background-color: var(--card-background);
                }

                .selection-item:last-child {
                    border-bottom: none;
                }

                .selection-item:hover {
                    background-color: var(--background-color);
                }

                .selection-item input[type="radio"] {
                    margin-right: 1rem;
                    width: 1.25rem;
                    height: 1.25rem;
                    border: 2px solid var(--border-color);
                    border-radius: 50%;
                    appearance: none;
                    -webkit-appearance: none;
                    outline: none;
                    cursor: pointer;
                    position: relative;
                    transition: all 0.2s ease;
                }

                .selection-item input[type="radio"]:checked {
                    border-color: var(--primary-color);
                    background-color: var(--primary-color);
                }

                .selection-item input[type="radio"]:checked::after {
                    content: '';
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    width: 0.5rem;
                    height: 0.5rem;
                    background-color: white;
                    border-radius: 50%;
                }

                .selection-item label {
                    cursor: pointer;
                    font-size: 1rem;
                    color: var(--text-primary);
                    flex: 1;
                }

                .continue-btn {
                    background-color: var(--primary-color);
                    color: white;
                    border: none;
                    padding: 1rem 2rem;
                    font-size: 1.1rem;
                    font-weight: 600;
                    border-radius: 0.75rem;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    margin-top: 2rem;
                    width: 100%;
                    box-shadow: 0 4px 6px -1px rgb(79 70 229 / 0.3);
                }

                .continue-btn:not(:disabled):hover {
                    background-color: var(--primary-hover);
                    transform: translateY(-2px);
                    box-shadow: 0 6px 8px -1px rgb(79 70 229 / 0.4);
                }

                .continue-btn:disabled {
                    opacity: 0.7;
                    cursor: not-allowed;
                    transform: none;
                }

                .selection-list::-webkit-scrollbar {
                    width: 4px;
                }

                .selection-list::-webkit-scrollbar-track {
                    background: transparent;
                }

                .selection-list::-webkit-scrollbar-thumb {
                    background-color: #d4d4d4;
                    border-radius: 2px;
                    opacity: 0;
                    transition: opacity 0.3s;
                }

                .selection-list:hover::-webkit-scrollbar-thumb {
                    opacity: 1;
                }
                
                .loading-container {
                    text-align: center;
                    padding: 2rem;
                    background: var(--card-background);
                    border-radius: 1rem;
                    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
                    max-width: 600px;
                    width: 100%;
                    transition: opacity 0.3s ease;
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    z-index: 2000;
                }

                .loading-text {
                    font-size: 1.5rem;
                    font-weight: 600;
                    margin-bottom: 2rem;
                    color: var(--text-primary);
                }

                .spinner {
                    width: 50px;
                    height: 50px;
                    border: 5px solid var(--border-color);
                    border-top-color: var(--primary-color);
                    border-radius: 50%;
                    animation: spin 1s linear infinite;
                    margin: 0 auto;
                }

                @keyframes spin {
                    to { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(modal);
            
            modal.style.display = 'flex';
            setTimeout(() => {
                modal.classList.add('fade-in', 'show');
            }, 10);
            
            toggleModalState(true);
            
            let selectedOption = null;
            const continueBtn = modal.querySelector('#continueBtn');
            const selectionList = modal.querySelector('#selectionList');
            
            try {
                const combinedFilesResponse = await fetch('/get-combined-files');
                const combinedFiles = await combinedFilesResponse.json();
                const hasCombinedResults = combinedFilesResponse.ok && combinedFiles.length > 0;
                
                const singleFilesResponse = await fetch('/get-single-files');
                const singleFiles = singleFilesResponse.ok ? await singleFilesResponse.json() : [];
                
                if (hasCombinedResults) {
                    const combinedGroup = document.createElement('div');
                    combinedGroup.className = 'category-group';
                    
                    const combinedTitle = document.createElement('div');
                    combinedTitle.className = 'category-title';
                    combinedTitle.textContent = 'Combined Results';
                    combinedGroup.appendChild(combinedTitle);
                    
                    combinedFiles.sort((a, b) => {
                        const displayNameA = a.replace("_GOEA_results.txt", "");
                        const displayNameB = b.replace("_GOEA_results.txt", "");
                        return displayNameA.localeCompare(displayNameB);
                    });
                    
                    combinedFiles.forEach(file => {
                        const item = document.createElement('div');
                        item.className = 'selection-item';
                        
                        const radio = document.createElement('input');
                        radio.type = 'radio';
                        radio.name = 'category';
                        radio.value = JSON.stringify({
                            type: 'combined_file',
                            filename: file
                        });
                        radio.id = `combined-file-${file}`;
                        
                        const label = document.createElement('label');
                        label.htmlFor = radio.id;
                        const rawName = file.replace("_GOEA_results.txt", "");
                        const displayName = rawName.split('_')
                            .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                            .join(' ');
                        label.textContent = displayName;
                        
                        radio.addEventListener('change', () => {
                            selectedOption = {
                                type: 'combined_file',
                                filename: file
                            };
                            continueBtn.disabled = false;
                        });
                        
                        item.appendChild(radio);
                        item.appendChild(label);
                        combinedGroup.appendChild(item);
                    });
                    
                    selectionList.appendChild(combinedGroup);
                }
                
                const singleGroup = document.createElement('div');
                singleGroup.className = 'category-group';
                
                const singleTitle = document.createElement('div');
                singleTitle.className = 'category-title';
                singleTitle.textContent = 'Single Results';
                singleGroup.appendChild(singleTitle);
                
                if (singleFiles.length > 0) {
                    singleFiles.sort((a, b) => {
                        const displayNameA = a.replace("_GOEA_results.txt", "");
                        const displayNameB = b.replace("_GOEA_results.txt", "");
                        return displayNameA.localeCompare(displayNameB);
                    });
                    
                    singleFiles.forEach(file => {
                        const item = document.createElement('div');
                        item.className = 'selection-item';
                        
                        const radio = document.createElement('input');
                        radio.type = 'radio';
                        radio.name = 'category';
                        radio.value = JSON.stringify({
                            type: 'single_file',
                            filename: file
                        });
                        radio.id = `single-file-${file}`;
                        
                        const label = document.createElement('label');
                        label.htmlFor = radio.id;
                        const rawName = file.replace("_GOEA_results.txt", "");
                        const displayName = rawName.split('_')
                            .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                            .join(' ');
                        label.textContent = displayName;
                        
                        radio.addEventListener('change', () => {
                            selectedOption = {
                                type: 'single_file',
                                filename: file
                            };
                            continueBtn.disabled = false;
                        });
                        
                        item.appendChild(radio);
                        item.appendChild(label);
                        singleGroup.appendChild(item);
                    });
                } else {
                    const noFiles = document.createElement('div');
                    noFiles.className = 'selection-item';
                    noFiles.style.fontStyle = 'italic';
                    noFiles.textContent = 'No single results files found';
                    singleGroup.appendChild(noFiles);
                }
                
                selectionList.appendChild(singleGroup);
                
                continueBtn.addEventListener('click', async () => {
                    if (selectedOption) {
                        const loadingDiv = document.createElement('div');
                        loadingDiv.className = 'loading-container';
                        loadingDiv.innerHTML = `
                            <div class="loading-text">Processing your request...</div>
                            <div class="spinner"></div>
                        `;
                        document.body.appendChild(loadingDiv);
                        modal.style.display = 'none';
                        
                        try {
                            const copyResponse = await fetch('/copy-results-file', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify(selectedOption)
                            });
                            
                            if (!copyResponse.ok) {
                                throw new Error('Failed to copy results file');
                            }
                            
                            localStorage.setItem('selectedBackground', JSON.stringify(selectedOption));
                            
                            window.location.reload();
                        } catch (error) {
                            console.error('Error copying results file:', error);
                            alert('Error copying results file: ' + error.message);
                            document.body.removeChild(loadingDiv);
                            modal.style.display = 'flex';
                        }
                    }
                });
                
                const closeButton = document.createElement('span');
                closeButton.className = 'close-modal';
                closeButton.innerHTML = '&times;';
                closeButton.style.position = 'absolute';
                closeButton.style.right = '1.5rem';
                closeButton.style.top = '1.5rem';
                closeButton.style.fontSize = '1.5rem';
                closeButton.style.cursor = 'pointer';
                closeButton.style.color = 'var(--text-secondary)';
                modal.querySelector('.modal-content').prepend(closeButton);
                
                closeButton.addEventListener('click', () => {
                    document.body.removeChild(modal);
                    toggleModalState(false);
                });
                
                modal.addEventListener('click', (event) => {
                    if (event.target === modal) {
                        document.body.removeChild(modal);
                        toggleModalState(false);
                    }
                });
            } catch (error) {
                console.error('Error loading selection options:', error);
                selectionList.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: var(--error-color);">
                        Error loading selection options. Please try again.
                    </div>
                `;
            }
        }

        function initializeAncestorAnalysis() {
            const selectedTerms = new Set();
            const selectedTermsList = document.getElementById('selected-terms-list');
            const runAnalysisButton = document.getElementById('run-ancestor-analysis');
            
            document.getElementById('enter-go-term-btn').addEventListener('click', () => {
                const manualEntry = document.getElementById('manual-go-entry');
                manualEntry.style.display = manualEntry.style.display === 'none' ? 'block' : 'none';
            });
            
            document.getElementById('add-go-term-btn').addEventListener('click', () => {
                const input = document.getElementById('go-term-input');
                const errorMsg = document.getElementById('go-term-error');
                const goTermPattern = /^GO:[0-9]{7}$/;
                
                if (goTermPattern.test(input.value)) {
                    addSelectedTerm(input.value);
                    input.value = '';
                    errorMsg.style.display = 'none';
                } else {
                    errorMsg.style.display = 'block';
                }
            });

            document.getElementById('go-term-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    document.getElementById('add-go-term-btn').click();
                }
            });
            
            document.getElementById('clear-all-terms-btn').addEventListener('click', () => {
                clearAllSelectedTerms();
            });
            
            document.getElementById('select-all-terms-btn').addEventListener('click', () => {
                selectAllTerms();
            });
            
            document.getElementById('select-from-results-btn').addEventListener('click', () => {
                const selectModal = document.createElement('div');
                selectModal.className = 'modal active';
                selectModal.innerHTML = `
                    <div class="modal-content" style="width: 80%; max-width: 1000px;">
                        <span class="close-modal">&times;</span>
                        <div class="title" style="font-size: 1.25rem; margin-bottom: 1rem;">Select GO Terms</div>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                            Select GO terms from your results to include in the ancestor analysis.
                        </p>
                        <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                            <table class="results-table">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;"></th>
                                        <th>GO Term ID</th>
                                        <th>Name</th>
                                        <th>Namespace</th>
                                    </tr>
                                </thead>
                                <tbody id="term-selection-body">
                                    <!-- Will be populated with results -->
                                </tbody>
                            </table>
                        </div>
                        <button class="primary-button" id="confirm-selection" style="margin-top: 1rem;">
                            Confirm Selection
                        </button>
                    </div>
                `;
                
                document.body.appendChild(selectModal);
                
                const selectionBody = document.getElementById('term-selection-body');
                allResults.forEach(result => {
                    const row = document.createElement('tr');
                    const isSelected = selectedTerms.has(result[0]);
                    
                    row.innerHTML = `
                        <td>
                            <input type="checkbox" class="species-selection-checkbox" value="${result[0]}" 
                                   ${isSelected ? 'checked' : ''}>
                        </td>
                        <td>${result[0]}</td>
                        <td>${result[1]}</td>
                        <td>${result[2]}</td>
                    `;
                    
                    selectionBody.appendChild(row);
                    
                    const checkbox = row.querySelector('input[type="checkbox"]');
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            addSelectedTerm(this.value);
                        } else {
                            removeSelectedTerm(this.value);
                        }
                    });
                });
                
                document.getElementById('confirm-selection').addEventListener('click', () => {
                    document.body.removeChild(selectModal);
                });
                
                selectModal.querySelector('.close-modal').addEventListener('click', () => {
                    document.body.removeChild(selectModal);
                });
                
                selectModal.addEventListener('click', (e) => {
                    if (e.target === selectModal) {
                        document.body.removeChild(selectModal);
                    }
                });
            });
            
            function addSelectedTerm(termId) {
                if (selectedTerms.has(termId)) return;
                
                selectedTerms.add(termId);
                updateSelectedTermsList();
                updateRunButtonState();
            }
            
            function removeSelectedTerm(termId) {
                selectedTerms.delete(termId);
                updateSelectedTermsList();
                updateRunButtonState();
            }
            
            function clearAllSelectedTerms() {
                selectedTerms.clear();
                updateSelectedTermsList();
                updateRunButtonState();
            }
            
            function selectAllTerms() {
                allResults.forEach(result => {
                    selectedTerms.add(result[0]);
                });
                updateSelectedTermsList();
                updateRunButtonState();
            }
            
            function updateSelectedTermsList() {
                if (selectedTerms.size === 0) {
                    selectedTermsList.innerHTML = `<p style="color: var(--text-tertiary); font-style: italic;">No terms selected yet</p>`;
                    return;
                }
                
                selectedTermsList.innerHTML = '';
                selectedTerms.forEach(term => {
                    let termName = '';
                    let termNamespace = '';
                    
                    const termDetails = allResults.find(result => result[0] === term);
                    if (termDetails) {
                        termName = termDetails[1];
                        termNamespace = termDetails[2];
                    }
                    
                    const termElement = document.createElement('div');
                    termElement.className = 'selected-term';
                    termElement.innerHTML = `
                        <div style="display: flex; align-items: center; background: var(--background-color); 
                                    padding: 0.5rem; border-radius: 0.5rem; margin-bottom: 0.5rem;">
                            <div style="flex: 1;">
                                <div style="font-weight: 500;">${term}</div>
                                ${termName ? `<div style="font-size: 0.875rem; color: var(--text-secondary);">${termName}</div>` : ''}
                                ${termNamespace ? `<div style="font-size: 0.75rem; color: var(--text-tertiary);">${termNamespace}</div>` : ''}
                            </div>
                            <button class="remove-term" data-term="${term}" style="background: none; border: none; cursor: pointer; 
                                                                                   color: var(--text-tertiary); font-size: 1.25rem;">
                                &times;
                            </button>
                        </div>
                    `;
                    
                    selectedTermsList.appendChild(termElement);
                    
                    termElement.querySelector('.remove-term').addEventListener('click', function() {
                        removeSelectedTerm(this.getAttribute('data-term'));
                    });
                });
            }
            
            function updateRunButtonState() {
                runAnalysisButton.disabled = selectedTerms.size < 2;
            }
            
            runAnalysisButton.addEventListener('click', async () => {
                runAnalysisButton.classList.add('loading');
                
                const similarityContainer = document.getElementById('similarity-fullscreen-container');
                if (similarityContainer.style.display === 'flex') {
                    similarityContainer.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
                document.getElementById('fullscreen-similarity-content').innerHTML = '';
                
                try {
                    const goTerms = Array.from(selectedTerms);
                    
                    const response = await fetch('/run-ancestor-analysis', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ go_terms: goTerms }),
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to run ancestor analysis');
                    }
                    
                    const result = await response.json();
                    
                    document.getElementById('ancestor-analysis-results').style.display = 'block';
                    
                    document.getElementById('ancestor-analysis-results').scrollIntoView({ behavior: 'smooth' });
                    
                    document.getElementById('ancestor-graph-container').innerHTML = `
                        <div style="padding: 1rem; background-color: var(--card-background); border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 1rem;">
                                <div style="display: flex; gap: 0.5rem;">
                                    <div class="info-tooltip">
                                        <button class="info-button">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 16px; height: 16px;">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                            Info
                                        </button>
                                        <span class="tooltip-text">Click on any term box in the graph to open its QuickGO page in a new tab.</span>
                                    </div>
                                    <a href="/ancestor-graph" download="ancestor_graph.pdf" class="fullscreen-button" style="background-color: var(--success-color);">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 16px; height: 16px;">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                        </svg>
                                        Download PDF
                                    </a>
                                    <button class="fullscreen-button" onclick="toggleDiagramFullscreen()">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 16px; height: 16px;">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5" />
                                        </svg>
                                        Fullscreen
                                    </button>
                                </div>
                            </div>
                            <div id="mermaid-diagram" style="width: 100%;  height: auto; overflow: visible;">
                                <div class="loading-indicator" style="display: flex; justify-content: center; align-items: center; height: 300px;">
                                    <div style="display: flex; flex-direction: column; align-items: center;">
                                        <div class="spinner" style="width: 40px; height: 40px; border-width: 4px;"></div>
                                        <p style="margin-top: 1rem; color: var(--text-secondary);">Loading diagram...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    fetch('/ancestor-mermaid')
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Failed to fetch Mermaid diagram');
                            }
                            return response.text();
                        })
                        .then(mermaidCode => {
                            const mermaidContainer = document.getElementById('mermaid-diagram');
                            
                            if (mermaidCode.trim() === "No common ancestors found between the provided GO terms") {
                                const controlsContainer = document.querySelector('#ancestor-graph-container .fullscreen-button').closest('div');
                                if (controlsContainer) {
                                    controlsContainer.style.display = 'none';
                                }
                                
                                mermaidContainer.innerHTML = `
                                    <div style="padding: 3rem; text-align: center; color: var(--text-secondary); background-color: var(--card-background); border-radius: 0.5rem; min-height: 300px; display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                        <div>
                                            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 1.5rem; color: var(--text-tertiary);">
                                                <path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"></path>
                                                <path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"></path>
                                                <path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"></path>
                                                <line x1="2" y1="2" x2="22" y2="22"></line>
                                            </svg>
                                            <p style="font-size: 1.25rem; font-weight: 500; margin-bottom: 0.75rem;">No Common Ancestors Found</p>
                                            <p style="color: var(--text-tertiary); max-width: 400px; margin: 0 auto; line-height: 1.5;">The selected GO terms do not share any common ancestors in the GO hierarchy. Try selecting terms from the same branch or more closely related biological processes.</p>
                                        </div>
                                    </div>
                                `;
                                return;
                            }
                            
                            mermaidContainer.innerHTML = `<pre class="mermaid" style="overflow: visible; max-width: none; width: auto;">${mermaidCode}</pre>`;
                            
                            mermaid.run({
                                nodes: document.querySelectorAll('.mermaid')
                            }).then(() => {
                                setLinksToOpenInNewTab();
                                
                                const svgElement = mermaidContainer.querySelector('svg');
                                if (svgElement) {
                                    svgElement.style.maxWidth = 'none';
                                    svgElement.style.width = '100%';
                                    svgElement.style.height = 'auto';
                                    
                                    mermaidContainer.style.overflowX = 'auto';
                                }
                            }).catch(error => {
                                console.error('Error rendering Mermaid diagram:', error);
                                mermaidContainer.innerHTML = `
                                    <div style="padding: 2rem; color: var(--error-color);">
                                        Error rendering diagram. The diagram may be too complex to display in the browser.
                                        <div style="margin-top: 1rem;">
                                            <a href="/ancestor-graph" target="_blank" rel="noopener noreferrer" style="color: var(--primary-color);">View as PDF instead</a>
                                        </div>
                                    </div>
                                `;
                            });
                        })
                        .catch(error => {
                            console.error('Error fetching Mermaid diagram:', error);
                            document.getElementById('mermaid-diagram').innerHTML = `
                                <div style="padding: 2rem; color: var(--error-color);">
                                    Error loading diagram. Please try again.
                                    <div style="margin-top: 1rem;">
                                        <a href="/ancestor-graph" target="_blank" rel="noopener noreferrer" style="color: var(--primary-color);">View as PDF instead</a>
                                    </div>
                                </div>
                            `;
                        });
                } catch (error) {
                    console.error('Error running ancestor analysis:', error);
                    
                    document.getElementById('ancestor-analysis-results').style.display = 'block';
                    document.getElementById('ancestor-graph-container').innerHTML = `
                        <div style="background-color: var(--card-background); padding: 2rem; border-radius: 0.5rem; text-align: center; height: 200px; display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <p style="color: var(--error-color); margin: 0;">Error: Unable to generate graph. Please try again with different GO terms.</p>
                        </div>
                    `;
                } finally {
                    runAnalysisButton.classList.remove('loading');
                }
            });

            document.getElementById('close-ancestor-modal').addEventListener('click', resetAncestorAnalysisForm);
            document.getElementById('ancestor-analysis-modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('ancestor-analysis-modal')) {
                    resetAncestorAnalysisForm();
                }
            });

            function resetAncestorAnalysisForm() {
                document.getElementById('manual-go-entry').style.display = 'none';
                
                document.getElementById('ancestor-analysis-results').style.display = 'none';
                
                document.getElementById('go-term-error').style.display = 'none';
                
                document.getElementById('go-term-input').value = '';
            }
        }

        function initializeSemanticSimilarity() {
            const selectedTerms = new Set();
            const selectedTermsList = document.getElementById('semantic-selected-terms-list');
            const runAnalysisButton = document.getElementById('run-semantic-similarity');
            
            document.getElementById('semantic-enter-go-term-btn').addEventListener('click', () => {
                const manualEntry = document.getElementById('semantic-manual-go-entry');
                manualEntry.style.display = manualEntry.style.display === 'none' ? 'block' : 'none';
            });
            
            document.getElementById('semantic-add-go-term-btn').addEventListener('click', () => {
                const input = document.getElementById('semantic-go-term-input');
                const errorMsg = document.getElementById('semantic-go-term-error');
                const goTermPattern = /^GO:[0-9]{7}$/;
                
                if (goTermPattern.test(input.value)) {
                    addSelectedTerm(input.value);
                    input.value = '';
                    errorMsg.style.display = 'none';
                } else {
                    errorMsg.style.display = 'block';
                }
            });

            document.getElementById('semantic-go-term-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    document.getElementById('semantic-add-go-term-btn').click();
                }
            });
            
            document.getElementById('semantic-clear-all-terms-btn').addEventListener('click', () => {
                clearAllSelectedTerms();
            });
            
            document.getElementById('semantic-select-all-terms-btn').addEventListener('click', () => {
                selectAllTerms();
            });
            
            document.getElementById('semantic-select-from-results-btn').addEventListener('click', () => {
                const selectModal = document.createElement('div');
                selectModal.className = 'modal active';
                selectModal.innerHTML = `
                    <div class="modal-content" style="width: 80%; max-width: 1000px;">
                        <span class="close-modal">&times;</span>
                        <div class="title" style="font-size: 1.25rem; margin-bottom: 1rem;">Select GO Terms</div>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                            Select GO terms from your results to include in the semantic similarity analysis.
                        </p>
                        <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                            <table class="results-table">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;"></th>
                                        <th>GO Term ID</th>
                                        <th>Name</th>
                                        <th>Namespace</th>
                                    </tr>
                                </thead>
                                <tbody id="term-selection-body">
                                    <!-- Will be populated with results -->
                                </tbody>
                            </table>
                        </div>
                        <button class="primary-button" id="confirm-selection" style="margin-top: 1rem;">
                            Confirm Selection
                        </button>
                    </div>
                `;
                
                document.body.appendChild(selectModal);
                
                const selectionBody = document.getElementById('term-selection-body');
                allResults.forEach(result => {
                    const row = document.createElement('tr');
                    const isSelected = selectedTerms.has(result[0]);
                    
                    row.innerHTML = `
                        <td>
                            <input type="checkbox" class="species-selection-checkbox" value="${result[0]}" 
                                   ${isSelected ? 'checked' : ''}>
                        </td>
                        <td>${result[0]}</td>
                        <td>${result[1]}</td>
                        <td>${result[2]}</td>
                    `;
                    
                    selectionBody.appendChild(row);
                    
                    const checkbox = row.querySelector('input[type="checkbox"]');
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            addSelectedTerm(this.value);
                        } else {
                            removeSelectedTerm(this.value);
                        }
                    });
                });
                
                document.getElementById('confirm-selection').addEventListener('click', () => {
                    document.body.removeChild(selectModal);
                });
                
                selectModal.querySelector('.close-modal').addEventListener('click', () => {
                    document.body.removeChild(selectModal);
                });
                
                selectModal.addEventListener('click', (e) => {
                    if (e.target === selectModal) {
                        document.body.removeChild(selectModal);
                    }
                });
            });
            
            function addSelectedTerm(termId) {
                if (selectedTerms.has(termId)) return;
                
                selectedTerms.add(termId);
                updateSelectedTermsList();
                updateRunButtonState();
            }
            
            function removeSelectedTerm(termId) {
                selectedTerms.delete(termId);
                updateSelectedTermsList();
                updateRunButtonState();
            }
            
            function clearAllSelectedTerms() {
                selectedTerms.clear();
                updateSelectedTermsList();
                updateRunButtonState();
            }
            
            function selectAllTerms() {
                allResults.forEach(result => {
                    selectedTerms.add(result[0]);
                });
                updateSelectedTermsList();
                updateRunButtonState();
            }
            
            function updateSelectedTermsList() {
                if (selectedTerms.size === 0) {
                    selectedTermsList.innerHTML = `<p style="color: var(--text-tertiary); font-style: italic;">No terms selected yet</p>`;
                    return;
                }
                
                selectedTermsList.innerHTML = '';
                selectedTerms.forEach(term => {
                    let termName = '';
                    let termNamespace = '';
                    
                    const termDetails = allResults.find(result => result[0] === term);
                    if (termDetails) {
                        termName = termDetails[1];
                        termNamespace = termDetails[2];
                    }
                    
                    const termElement = document.createElement('div');
                    termElement.className = 'selected-term';
                    termElement.innerHTML = `
                        <div style="display: flex; align-items: center; background: var(--background-color); 
                                    padding: 0.5rem; border-radius: 0.5rem; margin-bottom: 0.5rem;">
                            <div style="flex: 1;">
                                <div style="font-weight: 500;">${term}</div>
                                ${termName ? `<div style="font-size: 0.875rem; color: var(--text-secondary);">${termName}</div>` : ''}
                                ${termNamespace ? `<div style="font-size: 0.75rem; color: var(--text-tertiary);">${termNamespace}</div>` : ''}
                            </div>
                            <button class="remove-term" data-term="${term}" style="background: none; border: none; cursor: pointer; 
                                                                                   color: var(--text-tertiary); font-size: 1.25rem;">
                                &times;
                            </button>
                        </div>
                    `;
                    
                    selectedTermsList.appendChild(termElement);
                    
                    termElement.querySelector('.remove-term').addEventListener('click', function() {
                        removeSelectedTerm(this.getAttribute('data-term'));
                    });
                });
            }
            
            function updateRunButtonState() {
                runAnalysisButton.disabled = selectedTerms.size < 2;
            }
            
            runAnalysisButton.addEventListener('click', async () => {
                runAnalysisButton.classList.add('loading');
                
                const similarityContainer = document.getElementById('similarity-fullscreen-container');
                if (similarityContainer.style.display === 'flex') {
                    similarityContainer.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
                document.getElementById('fullscreen-similarity-content').innerHTML = '';
                
                try {
                    const goTerms = Array.from(selectedTerms);
                    
                    const similarityMethod = document.querySelector('input[name="similarity-method"]:checked').value;
                    
                    const response = await fetch('/run-semantic-similarity', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            go_terms: goTerms,
                            method: similarityMethod
                        }),
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to run semantic similarity analysis');
                    }
                    
                    const result = await response.json();
                    
                    document.getElementById('semantic-similarity-results').style.display = 'block';
                    
                    document.getElementById('semantic-similarity-results').scrollIntoView({ behavior: 'smooth' });
                    
                    const resultsContainer = document.getElementById('similarity-results-container');
                    
                    resultsContainer.innerHTML = `
                        <div style="background-color: var(--card-background); padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h4 style="margin: 0;">Similarity Scores (${similarityMethod})</h4>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="fullscreen-button" id="download-small-similarity-csv" style="background-color: var(--success-color);">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 16px; height: 16px;">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                        </svg>
                                        Download CSV
                                    </button>
                                    <button class="fullscreen-button" id="toggle-similarity-fullscreen">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 16px; height: 16px;">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5" />
                                        </svg>
                                        Fullscreen
                                    </button>
                                </div>
                            </div>
                            <div class="similarity-table-container">
                                <table class="similarity-table" style="width: 100%; min-width: 600px; border-collapse: collapse;">
                                    <thead>
                                        <tr>
                                            <th class="corner-header">GO Term</th>
                                            ${goTerms.map(term => `<th style="padding: 0.75rem; text-align: center; border-bottom: 1px solid var(--border-color); min-width: 120px;">${term}</th>`).join('')}
                                        </tr>
                                    </thead>
                                    <tbody id="similarity-table-body">
                                        ${goTerms.map(term1 => `
                                            <tr>
                                                <td style="padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border-color); font-weight: 500; background-color: var(--card-background); min-width: 120px;">${term1}</td>
                                                ${goTerms.map(term2 => {
                                                    const score = result.similarityScores[`${term1}-${term2}`] || 
                                                                 result.similarityScores[`${term2}-${term1}`] || 
                                                                 (term1 === term2 ? 1 : 0);
                                                    
                                                    const intensity = Math.min(Math.max(score, 0), 1);
                                                    const backgroundColor = term1 === term2 ? 
                                                        'var(--primary-color-light)' : 
                                                        `rgba(79, 70, 229, ${intensity * 0.2})`;
                                                    
                                                    return `<td style="padding: 0.75rem; text-align: center; border-bottom: 1px solid var(--border-color); background-color: ${backgroundColor}; min-width: 120px;">
                                                        ${score.toFixed(4)}
                                                    </td>`;
                                                }).join('')}
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                    
                    const smallDownloadButton = document.getElementById('download-small-similarity-csv');
                    if (smallDownloadButton) {
                        const newSmallDownloadButton = smallDownloadButton.cloneNode(true);
                        smallDownloadButton.parentNode.replaceChild(newSmallDownloadButton, smallDownloadButton);
                        
                        newSmallDownloadButton.addEventListener('click', function() {
                            const currentTable = document.querySelector('.similarity-table');
                            downloadSimilarityCSVFromTable(currentTable);
                        });
                    }
                    
                    const fullscreenButton = document.getElementById('toggle-similarity-fullscreen');
                    if (fullscreenButton) {
                        const newFullscreenButton = fullscreenButton.cloneNode(true);
                        fullscreenButton.parentNode.replaceChild(newFullscreenButton, fullscreenButton);
                        
                        newFullscreenButton.addEventListener('click', toggleSimilarityFullscreen);
                    }
                    
                } catch (error) {
                    console.error('Error running semantic similarity analysis:', error);
                    
                    document.getElementById('semantic-similarity-results').style.display = 'block';
                    document.getElementById('similarity-results-container').innerHTML = `
                        <div style="background-color: var(--card-background); padding: 2rem; border-radius: 0.5rem; text-align: center; min-height: 200px; display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <p style="color: var(--error-color); margin: 0;">Error: Unable to calculate semantic similarity. Please try again with different GO terms.</p>
                        </div>
                    `;
                } finally {
                    runAnalysisButton.classList.remove('loading');
                }
            });

            document.getElementById('close-semantic-modal').addEventListener('click', resetSemanticSimilarityForm);
            document.getElementById('semantic-similarity-modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('semantic-similarity-modal')) {
                    resetSemanticSimilarityForm();
                }
            });

            function resetSemanticSimilarityForm() {
                document.getElementById('semantic-manual-go-entry').style.display = 'none';
                
                document.getElementById('semantic-similarity-results').style.display = 'none';
                
                document.getElementById('semantic-go-term-error').style.display = 'none';
                
                document.getElementById('semantic-go-term-input').value = '';
                
                document.querySelector('input[name="similarity-method"][value="resnik"]').checked = true;
                
            }
        }
    </script>
</body>
</html>
