<!DOCTYPE html>
<html>
<head>
    <title>TaxaGO - Analysis Results</title>
    <style>
        :root {
            --primary-color: #4f46e5;
            --primary-hover: #4338ca;
            --background-color: #f8fafc;
            --card-background: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-tertiary: #94a3b8;  
            --border-color: #e2e8f0;
            --success-color: #10b981;
            --error-color: #ef4444;
        }

        iframe.plot-frame {
            transition: opacity 0.25s ease-in-out; /* Adjust timing as you see fit */
        }

        html {
            /* Force scrollbar to always be visible */
            overflow-y: scroll;
            /* This is the modern approach to prevent layout shift */
            scrollbar-gutter: stable both-edges;
        }

        body {
            margin: 0;
            padding: 20px;
            font-family: system-ui, -apple-system, sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            min-width: 320px; /* Prevent container from becoming too narrow */
            overflow-x: hidden; /* Prevent horizontal scrolling */
            width: 100vw;
            box-sizing: border-box;
            padding-right: calc(100vw - 100%);
        }

        /* Add custom scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
            background-color: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background-color: rgba(100, 116, 139, 0.2);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background-color: rgba(100, 116, 139, 0.3);
        }

        /* For Firefox */
        * {
            scrollbar-width: thin;
            scrollbar-color: rgba(100, 116, 139, 0.2) transparent;
        }

        .main-container {
            width: 100%;
            max-width: 90%;
            margin: 0 auto;
            padding: 1rem;
            box-sizing: border-box;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 65% 35%;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .results-table-container {
            width: 100%;
            margin-bottom: 2rem;
            background: var(--card-background);
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        .results-table-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 12px -1px rgb(0 0 0 / 0.15);
        }

        /* Update table scroll container to use overlay scrollbar */
        .table-scroll-container {
            overflow: auto;
            position: relative;
            max-height: 500px;
            width: 100%;
            overflow-x: overlay;
            overflow-y: overlay;
            scrollbar-gutter: stable;
            margin-top: 0; /* Remove top margin */
        }

        .plot-container {
            background: var(--card-background);
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            height: 600px;  /* Fixed height for all plot containers */
            display: flex;
            flex-direction: column;
        }

        .plot-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 12px -1px rgb(0 0 0 / 0.15);
        }

        .title {
            text-align: center;
            color: var(--text-primary);
            font-size: 2.25rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .subtitle {
            text-align: center;
            color: var(--text-secondary);
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 2.5rem;
        }

        .change-results-button {
            display: block;
            margin: 0 auto 2.5rem auto;
            padding: 0.75rem 1.5rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
            text-decoration: none;
        }

        .change-results-button:hover {
            background-color: var(--primary-hover);
        }

        .results-table {
            width: 100%;
            border-spacing: 0;
            border-collapse: collapse;
            table-layout: fixed;  /* Force consistent column widths */
        }

        /* Set specific widths for common column types */
        .results-table th,
        .results-table td {
            padding: 0.625rem 0.75rem; /* Slightly reduced padding */
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: normal;  /* Changed from nowrap to normal */
            min-width: 120px;  /* Minimum width for all columns */
            word-wrap: break-word;  /* Enable word wrapping */
            max-height: none;  /* Allow height to adjust to content */
            vertical-align: middle;  /* Center content vertically */
            line-height: 1.4;  /* Improve readability of wrapped text */
        }

        /* Specific column types */
        .results-table th[data-type="id"],
        .results-table td[data-type="id"] {
            width: 150px;  /* Fixed width for ID columns */
            white-space: nowrap;  /* Keep IDs on one line */
            text-overflow: clip;  /* Remove ellipsis */
            overflow: visible;  /* Allow content to be fully visible */
        }

        .results-table th[data-type="name"],
        .results-table td[data-type="name"] {
            width: 200px;  /* Fixed width for name columns */
        }

        .results-table th[data-type="numeric"],
        .results-table td[data-type="numeric"] {
            width: 120px;  /* Fixed width for numeric columns */
            white-space: nowrap;  /* Keep numbers on one line */
        }

        .results-table th[data-type="description"],
        .results-table td[data-type="description"] {
            width: 300px;  /* Fixed width for description columns */
        }

        /* Keep header text on one line */
        .results-table th {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .results-table thead {
            position: sticky;
            top: 0;
            background-color: var(--card-background);
            z-index: 10;  /* Increased z-index */
        }

        /* Make the first column sticky */
        .results-table th:first-child,
        .results-table td:first-child {
            position: sticky;
            left: 0;
            background-color: var(--card-background);
            z-index: 5;  /* Increased z-index */
            /* Add shadow for better visibility */
            box-shadow: 2px 0 4px -2px rgba(0, 0, 0, 0.1);
        }

        /* Make the first header cell (intersection of sticky header and column) extra sticky */
        .results-table thead th:first-child {
            position: sticky;
            left: 0;
            z-index: 15;  /* Highest z-index to stay on top */
            background-color: var(--card-background);
            /* Add shadow for better visibility */
            box-shadow: 
                2px 0 4px -2px rgba(0, 0, 0, 0.1),  /* right shadow */
                0 2px 4px -2px rgba(0, 0, 0, 0.1);   /* bottom shadow */
        }

        /* Ensure other header cells stay above regular cells */
        .results-table thead th {
            position: sticky;
            top: 0;
            z-index: 10;  /* Increased z-index */
            background-color: var(--card-background);
            /* Add shadow for better visibility */
            box-shadow: 0 1px 2px -1px rgba(0, 0, 0, 0.1);
        }

        /* Adjust background color on hover while maintaining stickiness */
        .results-table tr:hover td:first-child {
            background-color: var(--background-color);
        }

        .table-container {
            max-height: calc(90vh - 150px);
            overflow-y: auto;
            margin-top: 1rem;
        }

        .results-table th {
            padding: 0.5rem 0.5rem; /* Reduced vertical padding */
            font-size: 0.875rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
            vertical-align: middle; /* Center content vertically */
            height: 2.5rem; /* Fixed height for headers */
            line-height: 1.2; /* Tighter line height */
        }

        .results-table td {
            padding: 0.625rem 0.75rem; /* Slightly reduced padding */
            border-bottom: 1px solid var(--border-color);
            color: var(--text-secondary);
            text-align: center;  
        }

        .results-table tr {
            transition: background-color 0.2s ease;
        }

        .results-table tr:hover {
            background-color: var(--background-color);
        }

        .go-term {
            color: var(--primary-color);
        }

        .scientific {
            color: var(--text-secondary);
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Add this new style for body when modal is open */
        body.modal-open {
            overflow: hidden !important;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        /* Update modal content styles to enable scrolling within modal */
        .modal-content {
            background: var(--card-background);
            margin: auto;
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 1400px;
            position: relative;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
            max-height: 90vh;
            overflow-y: hidden; 
            box-sizing: border-box;
        }

        .modal.active {
            display: flex;
            opacity: 1;
        }

        .close-modal {
            position: absolute;
            right: 1.5rem;
            top: 1.5rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.2s ease;
        }

        .close-modal:hover {
            color: var(--text-primary);
        }

        .show-all-button {
            display: block;
            width: 100%;
            padding: 1rem;
            margin-top: 1rem;
            background: var(--background-color);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .show-all-button:hover {
            background: var(--card-background);
            color: var(--text-primary);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Sorting styles */
        .sortable-header {
            cursor: pointer;
            position: relative;
            padding-right: 1.5rem;
            user-select: none;
            white-space: nowrap;
            text-align: center;
        }

        .sort-arrow {
            position: absolute;
            right: 0.25rem;
            top: 50%;
            transform: translateY(-50%);
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            opacity: 0.3;
            transition: opacity 0.2s ease;
            width: 8px;
            height: 16px;
            pointer-events: none;
        }

        .sort-arrow.active {
            opacity: 1;
            color: var(--primary-color);
        }

        .sort-arrow::before,
        .sort-arrow::after {
            content: '';
            position: absolute;
            display: block;
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            pointer-events: none;
        }

        .sort-arrow::before {
            top: 0;
            border-bottom: 4px solid currentColor;
        }

        .sort-arrow::after {
            bottom: 0;
            border-top: 4px solid currentColor;
        }

        .sort-arrow.asc::before {
            border-bottom-color: var(--primary-color);
            opacity: 1;
        }

        .sort-arrow.asc::after {
            opacity: 0.3;
        }

        .sort-arrow.desc::before {
            opacity: 0.3;
        }

        .sort-arrow.desc::after {
            border-top-color: var(--primary-color);
            opacity: 1;
        }

        /* GO term link styling */
        .go-term-link {
            color: var(--primary-color);
            text-decoration: none;
            transition: color 0.2s ease;
            position: relative;
            text-align: left;
            display: inline-block;
        }

        .go-term-link:hover {
            color: var(--primary-hover);
        }

        .go-term-link::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 1px;
            bottom: -1px;
            left: 0;
            background-color: var(--primary-hover);
            transform: scaleX(0);
            transform-origin: bottom right;
            transition: transform 0.3s ease;
        }

        .go-term-link:hover::after {
            transform: scaleX(1);
            transform-origin: bottom left;
        }

        /* Function Buttons Styling */
        .function-buttons-container {
            margin-bottom: 2rem;
        }

        .primary-actions {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            justify-content: center;
        }

        .secondary-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
        }

        .primary-button {
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            min-width: 180px;
            justify-content: center;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .primary-button:disabled {
            background-color: rgb(79 70 229 / 0.5) !important;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .primary-button:not(:disabled) {
            background-color: var(--primary-color);
        }

        .primary-button:not(:disabled):hover {
            background-color: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 8px -1px rgb(79 70 229 / 0.3);
        }

        .primary-button:not(:disabled):active {
            transform: translateY(0);
        }

        .primary-button .spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 1.5rem;
            height: 1.5rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
            display: none;
        }

        .primary-button.loading .spinner {
            display: block;
        }

        .primary-button.loading .btn-text {
            visibility: hidden;
        }

        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        .download-button {
            background-color: var(--primary-color);
        }

        .download-button:hover {
            background-color: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 8px -1px rgb(79 70 229 / 0.3);
        }

        .download-button:active {
            transform: translateY(0);
        }

        .secondary-button {
            background-color: var(--background-color);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            padding: 0.75rem 1.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 150px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .secondary-button:hover {
            background-color: var(--card-background);
            color: var(--text-primary);
            border-color: var(--text-secondary);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .secondary-button:active {
            transform: translateY(0);
        }

        /* Form styling */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            background-color: var(--card-background);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .radio-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s ease;
        }

        .radio-label:hover {
            background-color: var(--background-color);
        }

        .radio-label input[type="radio"] {
            width: 1rem;
            height: 1rem;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            appearance: none;
            -webkit-appearance: none;
            outline: none;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
        }

        .radio-label input[type="radio"]:checked {
            border-color: var(--primary-color);
            background-color: var(--primary-color);
        }

        .radio-label input[type="radio"]:checked::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 0.375rem;
            height: 0.375rem;
            background-color: white;
            border-radius: 50%;
        }

        /* Range input styling */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 0.375rem;
            background: var(--border-color);
            border-radius: 0.25rem;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.2);
        }

        /* Analysis results styling */
        .analysis-parameters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            padding: 1.25rem;
            background: var(--background-color);
            border-radius: 0.75rem;
            margin-bottom: 2rem;
        }

        .parameter-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .parameter-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .parameter-value {
            font-size: 0.875rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .tab-container {
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
        }

        .tab-button {
            padding: 0.75rem 1.5rem;
            border: none;
            background: none;
            cursor: pointer;
            color: var(--text-secondary);
            font-weight: 500;
            position: relative;
            transition: all 0.2s ease;
        }

        .tab-button.active {
            color: var(--primary-color);
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: var(--primary-color);
        }

        .tab-button:hover:not(.active) {
            color: var(--text-primary);
        }

        @media (max-width: 768px) {
            .primary-actions, .secondary-actions {
                flex-direction: column;
                align-items: stretch;
            }
            
            .primary-button, .secondary-button {
                width: 100%;
            }
        }

        /* Plots styling */
        .content-grid {
            display: grid;
            grid-template-columns: 65% 35%;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .plot-frame {
            width: 100%;
            height: 100%;
            min-height: 400px;
            border: none;
            border-radius: 0.5rem;
            background: var(--background-color);
        }

        .plot-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
            text-align: center;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--background-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Loading skeleton animation */
        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }
            100% {
                background-position: 1000px 0;
            }
        }

        .loading-skeleton {
            background: linear-gradient(90deg, 
                var(--background-color) 25%, 
                var(--card-background) 50%, 
                var(--background-color) 75%);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite linear;
        }

        .loading-row td {
            height: 24px;
            border-radius: 4px;
        }

        /* Modal loading animation */
        .modal-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
        }

        .modal-spinner {
            width: 3rem;
            height: 3rem;
            border: 3px solid var(--border-color);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s linear infinite;
        }

        /* Checkbox styling */
        .species-checkbox {
            position: relative;
            margin-right: 0.75rem;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 0.25rem;
            border: 2px solid var(--border-color);
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            transition: all 0.2s ease;
        }

        .species-checkbox:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .species-checkbox:checked::after {
            content: '\2713';  /* Unicode checkmark */
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 0.875rem;
            line-height: 1;
            font-weight: bold;
        }

        /* Format checkbox styling */
        .format-checkbox {
            position: relative;
            margin-right: 0.75rem;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 0.25rem;
            border: 2px solid var(--border-color);
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            transition: all 0.2s ease;
        }

        .format-checkbox:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .format-checkbox:checked::after {
            content: '\2713';  /* Unicode checkmark */
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 0.875rem;
            line-height: 1;
            font-weight: bold;
        }

        /* Update species selection modal checkbox styles */
        .species-selection-checkbox {
            position: relative;
            margin-right: 0.75rem;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 0.25rem;
            border: 2px solid var(--border-color);
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            transition: all 0.2s ease;
        }

        .species-selection-checkbox:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .species-selection-checkbox:checked::after {
            content: '\2713';  /* Unicode checkmark */
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 0.875rem;
            line-height: 1;
            font-weight: bold;
        }

        /* Modal specific styles */
        .modal .tab-content {
            display: none;
        }

        .modal .tab-content.active {
            display: block;
        }

        /* Update table container styles */
        .modal .table-container {
            max-height: calc(90vh - 400px); /* Adjust height to account for headers and padding */
            overflow-y: auto;
            border-radius: 0.5rem;
            background: var(--card-background);
            margin-top: 1rem;
        }

        /* Keep header sticky */
        .modal .results-table thead {
            position: sticky;
            top: 0;
            background: var(--card-background);
            z-index: 10;
        }

        /* Update cell styles */
        .modal .results-table td {
            vertical-align: top;
            padding: 1rem;
            line-height: 1.5;
            word-wrap: break-word;
        }

        /* Specific styling for the ancestors column */
        .modal .results-table td:last-child {
            max-width: none;
            white-space: normal;
            word-wrap: break-word;
        }

        /* Ensure proper spacing between ancestor terms */
        .modal .results-table .go-term-link {
            display: inline-block;
            margin-right: 0.25rem;
        }

        /* Plots grid layout */
        .plots-grid {
            width: 100%;
            display: grid;
            grid-template-columns: 34% 63%;
            gap: 1.5rem;
            padding: 0;
            box-sizing: border-box;
        }

        @media (max-width: 1790px) {
            .plots-grid {
                grid-template-columns: 34% 63%;
                transform: scale(0.9);
                transform-origin: top left;
                width: 111%;  /* Compensate for scale to maintain layout */
            }
        }

        @media (max-width: 1400px) {
            .plots-grid {
                transform: scale(0.8);
                width: 125%;
            }
        }

        @media (max-width: 1200px) {
            .plots-grid {
                grid-template-columns: 1fr;
                transform: none;
                width: 100%;
                gap: 2rem;
            }

            .secondary-plots {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
                gap: 1.5rem;
            }

            .main-plot {
                min-height: 800px;
            }

            .secondary-plot {
                min-height: 400px;
            }
        }

        .main-plot {
            min-height: 1000px;
            background: var(--card-background);
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            padding: 0;
            box-sizing: border-box;
            overflow-x: hidden;
            position: relative;
        }

        .secondary-plots {
            display: flex;
            flex-direction: column;
            gap: 36px;
        }
        
        .secondary-plot {
            flex: 1;
            min-height: 450px;
            background: var(--card-background);
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            padding: 0;
            box-sizing: border-box;
            overflow-x: hidden;
            position: relative;
        }

        .plot-frame {
            width: 100%;
            height: 100%;
            min-height: 400px;
            border: none;
            border-radius: 0.5rem;
            background: var(--background-color);
        }

        .plots-container {
            width: 100%;
            margin-bottom: 2rem;
            background: var(--card-background);
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        .plots-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 12px -1px rgb(0 0 0 / 0.15);
        }

        .plot-tab-content {
            display: none;
        }

        .plot-tab-content.active {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            padding: 1rem;
        }

        .secondary-plots {
            display: flex;
            gap: 1.5rem;
        }

        .main-plot iframe,
        .secondary-plot iframe,
        .secondary-plot img {
            width: 100%;
            height: 100%;
            min-height: 400px;
            border: none;
            background: white;
            display: block;
        }

        .no-plot-message {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            background-color: var(--background-color);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 1rem;
            text-align: center;
            padding: 1rem;
            box-sizing: border-box;
        }

        .no-plots-message {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 1500px;
            width: 100%;
            background-color: var(--background-color);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 1.2rem;
            text-align: center;
            padding: 2rem;
            box-sizing: border-box;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .plot-loading {
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            background-color: var(--background-color);
            color: var(--text-secondary);
            font-size: 1rem;
            z-index: 5;
        }

        .main-plot, .secondary-plot {
            position: relative;
        }

        .plot-frame {
            position: relative;
            z-index: 10;
        }

        @media (max-width: 1024px) {
            .plots-grid {
                grid-template-columns: 1fr;
                gap: 2rem;
            }

            .main-plot,
            .secondary-plots {
                grid-column: 1;
                width: 100%;
            }

            .secondary-plots {
                flex-direction: column;
            }

            .secondary-plot {
                width: 100%;
            }
        }

        /* Tab content styles */
        .tab-content {
            min-height: 500px;  /* Minimum height to prevent vertical shifts */
            width: 100%;
            position: relative;
        }

        .tab-pane {
            position: absolute;
            width: 100%;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }

        .tab-pane.active {
            opacity: 1;
            visibility: visible;
            position: relative;
        }

        /* Add these styles to the existing <style> section */
        .results-table th {
            padding: 0.5rem 0.5rem; /* Reduced vertical padding */
            font-size: 0.875rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
            vertical-align: middle; /* Center content vertically */
            height: 2.5rem; /* Fixed height for headers */
            line-height: 1.2; /* Tighter line height */
        }

        /* Add tooltips to show full header text on hover */
        .sortable-header {
            position: relative;
        }

        .sortable-header[data-full-title]:hover::after {
            content: attr(data-full-title);
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--text-primary);
            color: white;
            padding: 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 20;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            pointer-events: none;
        }

        /* Add these new styles for the ancestor analysis modal */
        .selected-terms-container {
            background-color: var(--background-color);
            border-radius: 0.75rem;
            padding: 1rem;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }

        .selected-terms-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .selected-term {
            transition: all 0.2s ease;
        }

        .selected-term:hover {
            transform: translateY(-2px);
        }

        .remove-term:hover {
            color: var(--error-color) !important;
        }

        .term-selection-controls {
            margin-top: 1rem;
        }

        #manual-go-entry {
            background-color: var(--background-color);
            border-radius: 0.75rem;
            padding: 1rem;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        /* Style for the ancestor analysis modal */
        #ancestor-analysis-modal .modal-content {
            max-width: 800px;
            width: 80%;
            height: 80vh;
            min-height: 600px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #ancestor-analysis-modal .modal-header {
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        #ancestor-analysis-modal .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 0 1.5rem 1.5rem 1.5rem;
        }

        #ancestor-analysis-modal .modal-body .form-section:first-child {
            margin-top: 1.5rem;
        }

        #ancestor-analysis-modal .form-section {
            margin-bottom: 2rem;
        }

        #ancestor-analysis-modal .form-group {
            margin-bottom: 1.5rem;
        }

        #ancestor-analysis-modal .form-label {
            display: block;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
        }

        #ancestor-analysis-modal .radio-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            background-color: var(--background-color);
            border-radius: 0.75rem;
            padding: 1rem;
            border: 1px solid var(--border-color);
        }

        #ancestor-analysis-modal .radio-label {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease;
            cursor: pointer;
        }

        #ancestor-analysis-modal .radio-label:hover {
            background-color: var(--card-background);
        }

        #ancestor-analysis-modal .checkbox-label {
            padding: 0.75rem;
            background-color: var(--background-color);
            border-radius: 0.5rem;
            transition: background-color 0.2s ease;
            cursor: pointer;
        }

        #ancestor-analysis-modal .checkbox-label:hover {
            background-color: var(--card-background);
        }

        /* Set a fixed height for the selected terms container to maintain consistent modal size */
        .selected-terms-container {
            background-color: var(--background-color);
            border-radius: 0.75rem;
            padding: 1rem;
            height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }

        .selected-terms-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .selected-term {
            transition: all 0.2s ease;
        }

        .selected-term:hover {
            transform: translateY(-2px);
        }

        .remove-term:hover {
            color: var(--error-color) !important;
        }

        /* Animation for the ancestor analysis results */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Set a fixed height for the ancestor analysis results to maintain consistent modal size */
        #ancestor-analysis-results {
            margin-top: 2rem;
            animation: fadeIn 0.5s ease forwards;
        }

        #ancestor-graph-container {
            height: auto;
            background: var(--background-color);
            border-radius: 0.5rem;
            overflow: visible;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        #ancestor-graph-container:hover {
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        #ancestor-table-container {
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            transition: all 0.3s ease;
        }

        #ancestor-table-container:hover {
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        /* Responsive styles for the ancestor analysis modal */
        @media (max-width: 768px) {
            #ancestor-analysis-modal .modal-content {
                width: 95%;
                height: 90vh;
                padding: 1.5rem;
            }

            .term-selection-controls div {
                flex-direction: column;
            }

            #manual-go-entry div {
                flex-direction: column;
            }

            #ancestor-analysis-modal .checkbox-label {
                width: 100%;
            }
        }

        /* Fullscreen container styles */
        #diagram-fullscreen-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 2rem;
            box-sizing: border-box;
        }
        
        #fullscreen-diagram-content {
            width: 95%;
            height: 90%;
            background-color: white;
            border-radius: 0.5rem;
            padding: 1rem;
            overflow: auto;
            position: relative;
        }
        
        #fullscreen-diagram-content svg {
            cursor: grab;
        }

        #fullscreen-diagram-content svg:active {
            cursor: grabbing;
        }
        
        .fullscreen-controls {
            width: 95%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .fullscreen-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 0.25rem;
            padding: 0.5rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            transition: background-color 0.2s;
        }
        
        .fullscreen-button:hover {
            background-color: var(--primary-hover);
        }
        
        .fullscreen-button svg {
            width: 16px;
            height: 16px;
        }
        
        .close-fullscreen-button {
            background-color: white;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .close-fullscreen-button:hover {
            background-color: var(--background-color);
        }

        /* Style for the semantic similarity modal */
        #semantic-similarity-modal .modal-content {
            max-width: 800px;
            width: 80%;
            height: 80vh;
            min-height: 600px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #semantic-similarity-modal .modal-header {
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        #semantic-similarity-modal .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 0 1.5rem 1.5rem 1.5rem;
        }

        #semantic-similarity-modal .modal-body .form-section:first-child {
            margin-top: 1.5rem;
        }

        #semantic-similarity-modal .form-section {
            margin-bottom: 2rem;
        }

        #semantic-similarity-modal .form-group {
            margin-bottom: 1.5rem;
        }

        /* Radio button styles */
        .radio-container {
            display: flex;
            flex-direction: column;
            padding: 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            margin-bottom: 0.5rem;
            border: 1px solid var(--border-color);
        }

        .radio-container:hover {
            background-color: var(--background-color-hover);
        }

        .radio-container input[type="radio"] {
            margin-right: 0.5rem;
        }

        .radio-label {
            font-weight: 500;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
        }

        .radio-description {
            font-size: 0.875rem;
            color: var(--text-tertiary);
            margin-top: 0.25rem;
            margin-left: 1.5rem;
        }

        /* Method selection styles */
        .method-selection-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .method-option {
            position: relative;
            cursor: pointer;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            background-color: var(--background-color);
            transition: all 0.2s ease;
            overflow: hidden;
        }

        .method-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-color-light);
        }

        .method-option input[type="radio"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .method-content {
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .method-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .method-description {
            font-size: 0.85rem;
            color: var(--text-tertiary);
        }

        /* Style for selected method */
        .method-option input[type="radio"]:checked + .method-content {
            background-color: var(--primary-color-light);
            border-color: var(--primary-color);
        }

        .method-option input[type="radio"]:checked + .method-content .method-name {
            color: var(--primary-color);
        }

        .method-option input[type="radio"]:focus + .method-content {
            box-shadow: 0 0 0 2px var(--primary-color-light);
        }

        /* Similarity table styles */
        .similarity-table-container {
            max-height: 500px;
            min-height: 300px;
            overflow: auto;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            position: relative;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
        }

        .similarity-table th, 
        .similarity-table td {
            padding: 0.75rem;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }

        .similarity-table th {
            position: sticky;
            top: 0;
            background-color: var(--card-background);
            z-index: 1;
        }

        .similarity-table th:first-child {
            text-align: left;
            position: sticky;
            left: 0;
            z-index: 2; /* Higher z-index to appear above other sticky elements */
        }

        .similarity-table td:first-child {
            position: sticky;
            left: 0;
            background-color: var(--card-background);
            font-weight: 500;
            z-index: 1;
        }

        /* Special styling for the corner cell (1,1) - "GO Term" header */
        .similarity-table th:first-child {
            z-index: 3; /* Highest z-index to stay on top of everything */
            background-color: var(--card-background);
        }

        /* Specific styling for the corner header */
        .corner-header {
            position: sticky;
            top: 0;
            left: 0;
            z-index: 3;
            background-color: var(--card-background);
            text-align: left;
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        /* Zoom controls for the diagram */
        .zoom-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .zoom-button {
            background-color: var(--background-color);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        
        .zoom-button:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Add tooltip styles for the info button */
        .info-tooltip {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .info-tooltip .tooltip-text {
            visibility: hidden;
            width: 250px;
            background-color: var(--text-primary);
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 8px 12px;
            position: absolute;
            z-index: 100;
            top: 125%; /* Changed from bottom: 125% to top: 125% */
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.875rem;
            font-weight: normal;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            pointer-events: none;
        }
        
        .info-tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            bottom: 100%; 
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: transparent transparent var(--text-primary) transparent; 
        }
        
        .info-tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        .info-button {
            background-color: var(--background-color);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .info-button:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Similarity fullscreen container styles */
        #similarity-fullscreen-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 1rem;
            box-sizing: border-box;
        }
        
        #fullscreen-similarity-content {
            width: 98%;
            height: 95%;
            background-color: white;
            border-radius: 0.5rem;
            padding: 0 !important; /* Remove padding */
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        #fullscreen-similarity-content .similarity-table-container {
            flex: 1;
            overflow: auto;
            max-height: 100%;
            margin: 0 !important; /* Remove margin */
            padding: 0 !important; /* Remove padding */
            width: 100% !important;
        }
        
        #fullscreen-similarity-content .similarity-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0 !important; /* Remove margin */
            border-spacing: 0 !important; /* Remove border spacing */
        }
        
        #fullscreen-similarity-content .similarity-table thead th {
            position: sticky !important;
            top: 0 !important;
            background-color: var(--card-background);
            z-index: 10 !important;
            box-shadow: 0 1px 0 var(--border-color);
            /* Make headers larger */
            padding: 1rem 1.5rem !important;
            font-size: 1rem !important;
            white-space: nowrap !important;
            min-width: 150px !important;  /* Increased minimum width */
        }
        
        #fullscreen-similarity-content .similarity-table tbody td:first-child {
            position: sticky !important;
            left: 0 !important;
            background-color: var(--card-background);
            z-index: 5 !important;
            box-shadow: 1px 0 0 var(--border-color);
            /* Match header size */
            padding: 1rem 1.5rem !important;
            font-size: 1rem !important;
            white-space: nowrap !important;
            min-width: 150px !important;  /* Match header width */
        }
        
        /* Make the top-left cell (GO Term) fixed in both directions */
        #fullscreen-similarity-content .similarity-table thead th:first-child,
        #fullscreen-similarity-content .similarity-table thead th.corner-header {
            position: sticky !important;
            left: 0 !important;
            top: 0 !important;
            z-index: 20 !important; /* Higher z-index to appear above other sticky elements */
            background-color: var(--card-background);
            box-shadow: 1px 1px 0 var(--border-color);
            /* Match other header sizes */
            padding: 1rem 1.5rem !important;
            min-width: 150px !important;  /* Match header width */
        }

        /* Style the regular cells in the fullscreen table */
        #fullscreen-similarity-content .similarity-table tbody td {
            padding: 1rem 1.5rem !important;
            min-width: 150px !important;  /* Match header width */
            text-align: center !important;
        }
                
        .fullscreen-controls {
            width: 98%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .fullscreen-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 0.25rem;
            padding: 0.5rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            transition: background-color 0.2s;
        }
        
        .fullscreen-button:hover {
            background-color: var(--primary-hover);
        }
        
        .fullscreen-button svg {
            width: 16px;
            height: 16px;
        }
        
        .close-fullscreen-button {
            background-color: white;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .close-fullscreen-button:hover {
            background-color: var(--background-color);
        }

        .main-container .results-table thead {
            position: sticky;
            top: 0;
            background-color: var(--card-background);
            z-index: 10;  /* Increased z-index */
        }

        /* Make the first column sticky */
        .main-container .results-table th:first-child,
        .main-container .results-table td:first-child {
            position: sticky;
            left: 0;
            background-color: var(--card-background);
            z-index: 5;  /* Increased z-index */
            /* Add shadow for better visibility */
            box-shadow: 2px 0 4px -2px rgba(0, 0, 0, 0.1);
        }

        /* Make the first header cell (intersection of sticky header and column) extra sticky */
        .main-container .results-table thead th:first-child {
            position: sticky;
            left: 0;
            z-index: 15;  /* Highest z-index to stay on top */
            background-color: var(--card-background);
            /* Add shadow for better visibility */
            box-shadow: 
                2px 0 4px -2px rgba(0, 0, 0, 0.1),  /* right shadow */
                0 2px 4px -2px rgba(0, 0, 0, 0.1);   /* bottom shadow */
        }

        /* Ensure other header cells stay above regular cells */
        .main-container .results-table thead th {
            position: sticky;
            top: 0;
            z-index: 10;  /* Increased z-index */
            background-color: var(--card-background);
            /* Add shadow for better visibility */
            box-shadow: 0 1px 2px -1px rgba(0, 0, 0, 0.1);
        }

        .secondary-plots {
            display: flex;
            gap: 1.5rem;
        }

        .main-plot iframe,
        .secondary-plot iframe,
        .secondary-plot img {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
            display: block;
        }

        .no-plot-message {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            background-color: var(--background-color);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 1rem;
            text-align: center;
            padding: 1rem;
            box-sizing: border-box;
        }

        .no-plots-message {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 1500px;
            width: 100%;
            background-color: var(--background-color);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 1.2rem;
            text-align: center;
            padding: 2rem;
            box-sizing: border-box;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* Plot loading and error message styles */
        .plot-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1rem;
            color: var(--text-secondary);
            z-index: 1;
        }
        
        .no-plot-message, .no-plots-message {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            font-size: 1.125rem;
            color: var(--text-secondary);
            text-align: center;
            padding: 2rem;
        }

        /* Modal and Loading Styles */
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal-backdrop.active {
            display: block;
            opacity: 1;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1001;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.active {
            display: flex;
            opacity: 1;
        }

        .loading-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .loading-container.active {
            display: flex;
            opacity: 1;
        }
    </style>
    <!-- Add Mermaid library for rendering diagrams -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <script>
        // Initialize mermaid with a light theme that matches our UI
        mermaid.initialize({
            startOnLoad: false,
            theme: 'default',
            flowchart: {
                useMaxWidth: false,
                htmlLabels: true,
                curve: 'basis'
            },
            securityLevel: 'loose',
            // Add link settings to open in new tab
            htmlLabels: true,
            // Ensure proper rendering
            er: { useMaxWidth: false },
            sequence: { useMaxWidth: false },
            gantt: { useMaxWidth: false },
            journey: { useMaxWidth: false },
            pie: { useMaxWidth: false }
        });

        // Add event listener for the close fullscreen button
        document.addEventListener('DOMContentLoaded', function() {
            setupCloseFullscreenButton();
        });
        
        // Function to set up the close fullscreen button
        function setupCloseFullscreenButton() {
            const closeFullscreenButton = document.getElementById('close-similarity-fullscreen');
            if (closeFullscreenButton) {
                // Remove any existing event listeners by cloning
                const newCloseButton = closeFullscreenButton.cloneNode(true);
                closeFullscreenButton.parentNode.replaceChild(newCloseButton, closeFullscreenButton);
                
                // Add a fresh event listener
                newCloseButton.addEventListener('click', toggleSimilarityFullscreen);
            }
        }

        // Function to toggle fullscreen mode for the diagram
        function toggleDiagramFullscreen() {
            const diagramContainer = document.getElementById('diagram-fullscreen-container');
            
            if (diagramContainer.style.display === 'flex') {
                // Exit fullscreen
                diagramContainer.style.display = 'none';
                document.body.style.overflow = 'auto';
                
                // Remove event listeners for panning and zooming
                const container = document.querySelector('#fullscreen-diagram-content > div');
                if (container) {
                    container.removeEventListener('mousedown', handleMouseDown);
                    container.removeEventListener('mousemove', handleMouseMove);
                    container.removeEventListener('mouseup', handleMouseUp);
                    container.removeEventListener('mouseleave', handleMouseUp);
                    container.removeEventListener('wheel', handleWheel);
                }
                
                const svgElement = document.querySelector('#fullscreen-diagram-content svg');
                if (svgElement) {
                    svgElement.removeEventListener('click', handleSvgClick);
                }
            } else {
                // Enter fullscreen
                try {
                    // Get the mermaid code directly from the original source
                    fetch('/ancestor-mermaid')
                        .then(response => response.text())
                        .then(mermaidCode => {
                            document.getElementById('fullscreen-diagram-content').innerHTML = 
                                `<div style="width: 100%; height: 100%; overflow: hidden; position: relative;">
                                    <div class="zoom-container" style="position: absolute; transform-origin: 0 0;">
                                        <pre class="mermaid" style="overflow: visible; max-width: none; width: auto;">${mermaidCode}</pre>
                                    </div>
                                    <div class="zoom-controls" style="position: absolute; top: 20px; right: 20px; display: flex; gap: 0.5rem; background: rgba(255,255,255,0.9); padding: 0.5rem; border-radius: 0.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                        <div class="info-tooltip">
                                            <button class="info-button">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 16px; height: 16px;">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                                Info
                                            </button>
                                            <span class="tooltip-text">Click on any term box in the graph to open its QuickGO page in a new tab.</span>
                                        </div>
                                        <button class="zoom-button" onclick="zoomDiagram(0.8)" style="padding: 0.5rem; border-radius: 0.25rem; border: 1px solid #ccc; background: white; cursor: pointer;">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <circle cx="11" cy="11" r="8"/>
                                                <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                                                <line x1="8" y1="11" x2="14" y2="11"/>
                                            </svg>
                                        </button>
                                        <button class="zoom-button" onclick="zoomDiagram(1)" style="padding: 0.5rem; border-radius: 0.25rem; border: 1px solid #ccc; background: white; cursor: pointer;">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                            </svg>
                                        </button>
                                        <button class="zoom-button" onclick="zoomDiagram(1.2)" style="padding: 0.5rem; border-radius: 0.25rem; border: 1px solid #ccc; background: white; cursor: pointer;">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <circle cx="11" cy="11" r="8"/>
                                                <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                                                <line x1="11" y1="8" x2="11" y2="14"/>
                                                <line x1="8" y1="11" x2="14" y2="11"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>`;
                            
                            // Re-render the diagram in fullscreen
                            mermaid.run({
                                nodes: document.querySelectorAll('#fullscreen-diagram-content .mermaid')
                            }).then(() => {
                                // Make sure the SVG is fully visible in fullscreen mode
                                const svgElement = document.querySelector('#fullscreen-diagram-content svg');
                                if (svgElement) {
                                    svgElement.style.maxWidth = 'none';
                                    svgElement.style.width = '100%';
                                    svgElement.style.height = 'auto';
                                    
                                    // Add click handler to SVG elements
                                    svgElement.addEventListener('click', handleSvgClick, true);
                                }
                                
                                // Store original dimensions and initialize position
                                const container = document.querySelector('#fullscreen-diagram-content > div');
                                const zoomContainer = document.querySelector('.zoom-container');
                                window.originalWidth = zoomContainer.offsetWidth;
                                window.originalHeight = zoomContainer.offsetHeight;
                                window.currentScale = 1;
                                window.currentX = 0;
                                window.currentY = 0;
                                
                                // Center the diagram initially
                                centerDiagram();
                                
                                // Add event listeners for panning and zooming
                                container.addEventListener('mousedown', handleMouseDown);
                                container.addEventListener('mousemove', handleMouseMove);
                                container.addEventListener('mouseup', handleMouseUp);
                                container.addEventListener('mouseleave', handleMouseUp);
                                container.addEventListener('wheel', handleWheel, { passive: false });
                                
                                // Make sure all links open in new tabs
                                document.querySelectorAll('#fullscreen-diagram-content a').forEach(link => {
                                    link.setAttribute('target', '_blank');
                                    link.setAttribute('rel', 'noopener noreferrer');
                                });
                            })
                            .catch(error => {
                                console.error('Error rendering fullscreen diagram:', error);
                                document.getElementById('fullscreen-diagram-content').innerHTML = 
                                    `<div style="padding: 2rem; color: var(--error-color); background: white; border-radius: 0.5rem;">
                                        Error rendering diagram in fullscreen. The diagram may be too complex.
                                        <div style="margin-top: 1rem;">
                                            <a href="/ancestor-graph" target="_blank" rel="noopener noreferrer" style="color: var(--primary-color);">View as PDF instead</a>
                                        </div>
                                    </div>`;
                            });
                        })
                        .catch(error => {
                            console.error('Error fetching mermaid code for fullscreen:', error);
                            document.getElementById('fullscreen-diagram-content').innerHTML = 
                                `<div style="padding: 2rem; color: var(--error-color); background: white; border-radius: 0.5rem;">
                                    Error loading diagram for fullscreen view. Please try again.
                                </div>`;
                        });
                } catch (error) {
                    console.error('Error in fullscreen toggle:', error);
                }
                
                diagramContainer.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        }
        
        // Function to ensure all links in the Mermaid diagram open in new tabs
        function setLinksToOpenInNewTab() {
            document.querySelectorAll('#mermaid-diagram a, .mermaid a').forEach(link => {
                link.setAttribute('target', '_blank');
                link.setAttribute('rel', 'noopener noreferrer');
            });
        }

        // Function to zoom the diagram
        function zoomDiagram(scale) {
            const zoomContainer = document.querySelector('.zoom-container');
            if (!zoomContainer) return;

            const container = document.querySelector('#fullscreen-diagram-content > div');
            const oldScale = window.currentScale || 1;

            if (scale === 1) {
                // Reset to original size and center
                window.currentScale = 1;
                centerDiagram();
            } else {
                // Calculate new scale
                // Use a more aggressive zoom factor
                const zoomFactor = scale > 1 ? 1.5 : 0.667; // More pronounced zoom in/out
                window.currentScale = oldScale * zoomFactor;
                // Allow for more extreme zoom levels
                window.currentScale = Math.min(Math.max(window.currentScale, 0.1), 10);

                // Adjust position to zoom around center
                const containerRect = container.getBoundingClientRect();
                const centerX = containerRect.width / 2;
                const centerY = containerRect.height / 2;

                const scaleChange = window.currentScale / oldScale;
                const dx = centerX - (centerX - window.currentX) * scaleChange;
                const dy = centerY - (centerY - window.currentY) * scaleChange;

                window.currentX = dx;
                window.currentY = dy;

                updateTransform();
            }
        }

        // Add wheel zoom support
        function handleWheel(e) {
            if (!e.ctrlKey) return; // Only zoom when Ctrl is pressed
            e.preventDefault();
            
            const zoomFactor = e.deltaY < 0 ? 1.1 : 0.9;
            zoomDiagram(zoomFactor);
        }

        // Function to zoom the fullscreen diagram
        function zoomFullscreenDiagram(scale) {
            const svgElement = document.querySelector('#fullscreen-diagram-content svg');
            if (svgElement) {
                // Get the current transform if any
                const currentTransform = svgElement.getAttribute('transform') || '';
                const currentScaleMatch = currentTransform.match(/scale\(([^)]+)\)/);
                
                let currentScale = 1;
                if (currentScaleMatch && currentScaleMatch[1]) {
                    currentScale = parseFloat(currentScaleMatch[1]);
                }
                
                // Calculate the new scale
                const newScale = scale === 1 ? 1 : currentScale * scale;
                
                // Apply the new transform
                if (newScale === 1) {
                    svgElement.removeAttribute('transform');
                } else {
                    // Apply transform from the center of the SVG
                    const bbox = svgElement.getBBox();
                    const cx = bbox.x + bbox.width/2;
                    const cy = bbox.y + bbox.height/2;
                    svgElement.setAttribute('transform', `scale(${newScale})`);
                }
                
                // Adjust container to fit the content
                const fullscreenContainer = document.querySelector('#fullscreen-diagram-content > div');
                if (fullscreenContainer) {
                    fullscreenContainer.style.minWidth = `${svgElement.getBBox().width * newScale}px`;
                    fullscreenContainer.style.minHeight = `${svgElement.getBBox().height * newScale}px`;
                }
            }
        }

        // Function to center the diagram
        function centerDiagram() {
            const container = document.querySelector('#fullscreen-diagram-content > div');
            const zoomContainer = document.querySelector('.zoom-container');
            if (!container || !zoomContainer) return;

            const scale = window.currentScale || 1;
            const containerWidth = container.offsetWidth;
            const containerHeight = container.offsetHeight;
            const diagramWidth = window.originalWidth * scale;
            const diagramHeight = window.originalHeight * scale;

            window.currentX = (containerWidth - diagramWidth) / 2;
            window.currentY = (containerHeight - diagramHeight) / 2;
            updateTransform();
        }

        // Function to update transform
        function updateTransform() {
            const zoomContainer = document.querySelector('.zoom-container');
            if (!zoomContainer) return;

            const scale = window.currentScale || 1;
            zoomContainer.style.transform = `translate(${window.currentX}px, ${window.currentY}px) scale(${scale})`;
        }

        // Function to handle panning in fullscreen mode
        let isDragging = false;
        let startX, startY;
        let hasMoved = false;
        let clickStartTime = 0;

        function handleMouseDown(e) {
            // Store the time when mouse down occurred
            clickStartTime = Date.now();
            hasMoved = false;
            isDragging = true;
            
            const container = document.querySelector('#fullscreen-diagram-content > div');
            startX = e.clientX - window.currentX;
            startY = e.clientY - window.currentY;
            container.style.cursor = 'grabbing';
            
            // Prevent default to avoid text selection
            e.preventDefault();
            
            // We no longer disable pointer events here - we'll handle this in the mouseup event
        }

        function handleMouseMove(e) {
            if (!isDragging) return;
            
            // Calculate distance moved
            const dx = e.clientX - (startX + window.currentX);
            const dy = e.clientY - (startY + window.currentY);
            
            // Set hasMoved flag if moved more than a small threshold
            if (Math.abs(dx) > 5 || Math.abs(dy) > 5) {
                hasMoved = true;
            }
            
            window.currentX = e.clientX - startX;
            window.currentY = e.clientY - startY;
            updateTransform();
            
            // Always prevent default during drag to avoid browser behaviors
            e.preventDefault();
        }

        function handleMouseUp(e) {
            if (isDragging) {
                isDragging = false;
                const container = document.querySelector('#fullscreen-diagram-content > div');
                if (container) {
                    container.style.cursor = 'grab';
                }
                
                // If the mouse hasn't moved significantly and the click was short,
                // allow the click to proceed naturally to the link
                if (!hasMoved && (Date.now() - clickStartTime < 300)) {
                    // This was a click, not a drag - do nothing special to allow the click to work
                } else {
                    // This was a drag, not a click - prevent any click events
                    e.preventDefault();
                    e.stopPropagation();
                }
            }
        }

        // Add a click handler for SVG elements
        function handleSvgClick(e) {
            // Only prevent clicks if we've been dragging
            if (hasMoved) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
            // Otherwise, allow the click to proceed normally
        }

        // Function to toggle fullscreen mode for the similarity table
        function toggleSimilarityFullscreen() {
            const similarityContainer = document.getElementById('similarity-fullscreen-container');
            
            if (similarityContainer.style.display === 'flex') {
                // Exit fullscreen
                similarityContainer.style.display = 'none';
                document.body.style.overflow = 'auto';
            } else {
                // Enter fullscreen
                try {
                    // Always get the current similarity table content
                    const tableContainer = document.querySelector('.similarity-table-container');
                    if (!tableContainer) {
                        console.error('Similarity table container not found');
                        return;
                    }
                    
                    // Get the current table content
                    const tableHTML = tableContainer.querySelector('.similarity-table').outerHTML;
                    
                    // Clear previous content
                    const fullscreenContent = document.getElementById('fullscreen-similarity-content');
                    fullscreenContent.innerHTML = '';
                    
                    // Create a new table container that maximizes height
                    const newTableContainer = document.createElement('div');
                    newTableContainer.className = 'similarity-table-container';
                    newTableContainer.innerHTML = tableHTML;
                    
                    // No longer adding the non-sticky-table class since we want sticky headers
                    
                    // Ensure the corner header has the correct class
                    const cornerHeader = newTableContainer.querySelector('.similarity-table thead th:first-child');
                    if (cornerHeader && !cornerHeader.classList.contains('corner-header')) {
                        cornerHeader.classList.add('corner-header');
                    }
                    
                    // Append the table container directly to the fullscreen content
                    fullscreenContent.appendChild(newTableContainer);
                    
                    // Setup CSV download button with a fresh event listener
                    const downloadButton = document.getElementById('download-similarity-csv');
                    if (downloadButton) {
                        // Remove any existing event listeners by cloning
                        const newDownloadButton = downloadButton.cloneNode(true);
                        downloadButton.parentNode.replaceChild(newDownloadButton, downloadButton);
                        
                        // Add a fresh event listener that gets the current table
                        newDownloadButton.addEventListener('click', function() {
                            // Get the current table in the fullscreen view
                            const currentTable = document.querySelector('#fullscreen-similarity-content .similarity-table');
                            if (currentTable) {
                                downloadSimilarityCSVFromTable(currentTable);
                            } else {
                                console.error('Table not found in fullscreen view');
                            }
                        });
                    }
                    
                    // Setup close button with a fresh event listener
                    setupCloseFullscreenButton();
                    
                    // Show the fullscreen container
                    similarityContainer.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                } catch (error) {
                    console.error('Error in similarity fullscreen toggle:', error);
                }
            }
        }
        
        // Function to download similarity table as CSV
        function downloadSimilarityCSV() {
            // Always get the current table in the fullscreen view
            const currentTable = document.querySelector('#fullscreen-similarity-content .similarity-table');
            if (currentTable) {
                downloadSimilarityCSVFromTable(currentTable);
            } else {
                console.error('Table not found in fullscreen view for CSV download');
                // Try to get the table from the main view as a fallback
                const mainTable = document.querySelector('.similarity-table');
                if (mainTable) {
                    downloadSimilarityCSVFromTable(mainTable);
                } else {
                    console.error('No similarity table found for CSV download');
                }
            }
        }
        
        // Generic function to download a table as CSV
        function downloadSimilarityCSVFromTable(table) {
            try {
                if (!table) {
                    console.error('Table not found');
                    return;
                }
                
                const rows = Array.from(table.querySelectorAll('tr'));
                let csvContent = "data:text/csv;charset=utf-8,";
                
                rows.forEach(row => {
                    const cells = Array.from(row.querySelectorAll('th, td'));
                    const rowData = cells.map(cell => {
                        // Remove any HTML and get just the text content
                        let content = cell.textContent.trim();
                        // Escape quotes and wrap content in quotes if it contains commas
                        if (content.includes(',') || content.includes('"')) {
                            content = '"' + content.replace(/"/g, '""') + '"';
                        }
                        return content;
                    });
                    csvContent += rowData.join(',') + '\r\n';
                });
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement('a');
                link.setAttribute('href', encodedUri);
                link.setAttribute('download', 'semantic_similarity.csv');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                console.error('Error downloading CSV:', error);
            }
        }

        // Add error handling for iframes
        function setupIframeErrorHandling() {
            document.querySelectorAll('iframe.plot-frame').forEach(iframe => {
                // Remove any existing event listeners by cloning
                const newIframe = iframe.cloneNode(true);
                iframe.parentNode.replaceChild(newIframe, iframe);
                
                // Set a timeout to check if the plot is taking too long to load
                const loadTimeout = setTimeout(() => {
                    // If the iframe is still loading after 10 seconds, show an error
                    const loadingEl = newIframe.parentElement.querySelector('.plot-loading');
                    if (loadingEl) {
                        loadingEl.textContent = 'Plot is taking longer than expected to load...';
                    }
                }, 10000); // 10 seconds
                
                // Add load event listener to check for errors and remove loading indicator
                newIframe.addEventListener('load', function() {
                    // Clear the timeout
                    clearTimeout(loadTimeout);
                    
                    // Remove the loading indicator
                    const loadingEl = this.parentElement.querySelector('.plot-loading');
                    if (loadingEl) {
                        loadingEl.style.display = 'none';
                    }
                    
                    try {
                        // If we can access the iframe content and it's an error page
                        // Note: This might not work for cross-origin iframes due to security restrictions
                        if (this.contentDocument && 
                            (this.contentDocument.title.includes('Error: Plot Not Found') || 
                             this.contentDocument.body.textContent.includes('Plot Not Found') ||
                             this.contentDocument.body.classList.contains('plot-error-page'))) {
                            
                            // Get the plot type and namespace from the iframe ID
                            const id = this.id || '';
                            let namespace = 'Unknown';
                            let plotType = 'plot';
                            
                            if (id.startsWith('bp')) {
                                namespace = 'Biological Process';
                            } else if (id.startsWith('mf')) {
                                namespace = 'Molecular Function';
                            } else if (id.startsWith('cc')) {
                                namespace = 'Cellular Component';
                            }
                            
                            if (id.includes('plot1')) {
                                plotType = 'bar plot';
                            } else if (id.includes('plot2')) {
                                plotType = 'bubble plot';
                            } else if (id.includes('plot3')) {
                                plotType = 'network plot';
                            }
                            
                            
                            this.parentElement.innerHTML = `<div class="no-plot-message">No ${plotType} available for ${namespace}</div>`;
                        }
                    } catch (e) {
                        // If we can't access the iframe content (cross-origin), we need to rely on the fetch check
                        console.log('Cannot check iframe content:', e);
                    }
                });
                
                // Add error handler for the iframe
                newIframe.addEventListener('error', function() {
                    // Clear the timeout
                    clearTimeout(loadTimeout);
                    
                    // Get the plot type and namespace from the iframe ID
                    const id = this.id || '';
                    let namespace = 'Unknown';
                    let plotType = 'plot';
                    
                    if (id.startsWith('bp')) {
                        namespace = 'Biological Process';
                    } else if (id.startsWith('mf')) {
                        namespace = 'Molecular Function';
                    } else if (id.startsWith('cc')) {
                        namespace = 'Cellular Component';
                    }
                    
                    if (id.includes('plot1')) {
                        plotType = 'bar plot';
                    } else if (id.includes('plot2')) {
                        plotType = 'bubble plot';
                    } else if (id.includes('plot3')) {
                        plotType = 'network plot';
                    }
                    
                    this.parentElement.innerHTML = `<div class="no-plot-message">No ${plotType} available for ${namespace}</div>`;
                });
            });
            
            // Also handle image loading
            document.querySelectorAll('img.plot-frame').forEach(img => {
                img.addEventListener('load', function() {
                    // Remove the loading indicator
                    const loadingEl = this.parentElement.querySelector('.plot-loading');
                    if (loadingEl) {
                        loadingEl.style.display = 'none';
                    }
                });
            });
        }

        // Add this at the start of your JavaScript section
        function showLoading() {
            const loadingContainer = document.getElementById('global-loading-container');
            loadingContainer.classList.add('active');
        }

        function hideLoading() {
            const loadingContainer = document.getElementById('global-loading-container');
            loadingContainer.classList.remove('active');
        }

        function showModal(modalId) {
            const backdrop = document.getElementById('modal-backdrop');
            const modal = document.getElementById(modalId);
            backdrop.classList.add('active');
            modal.classList.add('active');
            document.body.classList.add('modal-open');
        }

        function hideModal(modalId) {
            const backdrop = document.getElementById('modal-backdrop');
            const modal = document.getElementById(modalId);
            backdrop.classList.remove('active');
            modal.classList.remove('active');
            document.body.classList.remove('modal-open');
        }

        // Update the loadResults function
        async function loadResults() {
            try {
                const tbody = document.getElementById('results-body');
                const thead = document.querySelector('.results-table thead tr');
                
                showLoading(); // Show loading state
                
                // Show loading skeleton
                tbody.innerHTML = Array(5).fill(0).map(() => `
                    <tr class="loading-row">
                        ${Array(9).fill('<td class="loading-skeleton">&nbsp;</td>').join('')}
                    </tr>
                `).join('');

                const response = await fetch('/get_results');
                if (!response.ok) {
                    throw new Error('Results not found');
                }
                
                const data = await response.text();
                if (!data) {
                    throw new Error('No results data available');
                }
                
                const lines = data.split('\n');
                tbody.innerHTML = ''; // Clear loading skeleton
                
                // Clear existing headers
                thead.innerHTML = '';
                
                // Parse headers from the first line
                if (lines.length > 0) {
                    const headerLine = lines[0].trim();
                    const headers = headerLine.split('\t');
                    
                    // Create header cells
                    headers.forEach((header, index) => {
                        const th = document.createElement('th');
                        th.className = 'sortable-header';
                        th.setAttribute('data-column', index);
                        
                        // Set appropriate data-type based on header content
                        if (header.includes('GO') && header.includes('ID')) {
                            th.setAttribute('data-type', 'id');
                        } else if (header.includes('Name') || header.includes('Namespace')) {
                            th.setAttribute('data-type', 'name');
                        } else {
                            th.setAttribute('data-type', 'numeric');
                        }
                        
                        // Set full title if needed
                        if (header.length > 15) {
                            th.setAttribute('data-full-title', header);
                        }
                        
                        // Create the header text and sort arrow
                        th.textContent = header;
                        const sortArrow = document.createElement('span');
                        sortArrow.className = 'sort-arrow';
                        th.appendChild(sortArrow);
                        
                        thead.appendChild(th);
                    });
                }
                
                // Store all results
                allResults = [];
                
                // Process each data row (skip header)
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue; // Skip empty lines
                    
                    const columns = line.split('\t');
                    if (columns.length >= 3) { // Make sure we have at least a few columns
                        allResults.push(columns);
                    }
                }

                if (allResults.length === 0) {
                    throw new Error('No valid results found');
                }

                // Sort the results by Odds Ratio (descending) and p-value (ascending)
                allResults = sortResultsByOddsRatioAndPValue(allResults);

                // Display first 10 rows in main table
                for (let i = 0; i < Math.min(10, allResults.length); i++) {
                    tbody.appendChild(createTableRow(allResults[i]));
                }

                // Initialize sorting for the main table
                initializeTableSorting(document.querySelector('.results-table-container .results-table'));
                
                // Initialize tabs
                initializeTabSwitching();
            } catch (error) {
                console.error('Error loading results:', error);
                const tbody = document.getElementById('results-body');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            No results available. Please run an analysis first.
                        </td>
                    </tr>
                `;
            } finally {
                hideLoading(); // Always hide loading when done
            }
        }

        // Update event listeners for modals
        document.addEventListener('DOMContentLoaded', function() {
            // Close modal when clicking backdrop
            document.getElementById('modal-backdrop').addEventListener('click', function() {
                const activeModal = document.querySelector('.modal.active');
                if (activeModal) {
                    hideModal(activeModal.id);
                }
            });

            // Close modal when clicking close button
            document.querySelectorAll('.close-modal').forEach(button => {
                button.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    if (modal) {
                        hideModal(modal.id);
                    }
                });
            });

            // Stop propagation of clicks on modal content
            document.querySelectorAll('.modal-content').forEach(content => {
                content.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            });
        });
    </script>
</head>
<body>
    <!-- Add backdrop and loading container -->
    <div id="modal-backdrop" class="modal-backdrop"></div>
    <div id="global-loading-container" class="loading-container">
        <div class="loading-text">Processing your request...</div>
    </div>

    <!-- Add fullscreen container at the top level of the body -->
    <div id="diagram-fullscreen-container">
        <div class="fullscreen-controls">
            <div style="display: flex; gap: 0.5rem;">
                <a href="/ancestor-graph" download="ancestor_graph.pdf" class="fullscreen-button" style="background-color: var(--success-color);">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Download PDF
                </a>
            </div>
            <button class="fullscreen-button close-fullscreen-button" onclick="toggleDiagramFullscreen()">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
                Close Fullscreen
            </button>
        </div>
        <div id="fullscreen-diagram-content"></div>
    </div>

    <!-- Add fullscreen container for semantic similarity table -->
    <div id="similarity-fullscreen-container">
        <div class="fullscreen-controls">
            <div style="display: flex; gap: 0.5rem;">
                <button class="fullscreen-button" id="download-similarity-csv" style="background-color: var(--success-color);">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Download CSV
                </button>
            </div>
            <button class="fullscreen-button close-fullscreen-button" id="close-similarity-fullscreen">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
                Close Fullscreen
            </button>
        </div>
        <div id="fullscreen-similarity-content"></div>
    </div>
    
    <div class="main-container">
        <h1 class="title">TaxaGO Results</h1>

        <!-- Action Buttons at the top -->
        <div class="function-buttons-container">
            <div class="primary-actions">
                <button class="primary-button download-button">Download Results</button>
                <button class="primary-button" style="background-color: var(--text-secondary)" onclick="clearDataAndRedirect()">New Analysis</button>
                <button class="primary-button" style="background-color: var(--text-tertiary)" onclick="window.location.href='/loading?subsequent=true&odds_ratio_threshold=1.0&n_protein_threshold=1'">Change Results</button>
            </div>
            <div class="secondary-actions">
                <button class="secondary-button">Ancestor Analysis</button>
                <button class="secondary-button">Semantic Similarity</button>
            </div>
        </div>

        <!-- Results Table Section -->
        <div class="results-table-container">
            <div class="table-scroll-container">
                <table class="results-table">
                    <thead>
                        <tr>
                            <!-- Headers will be dynamically populated -->
                        </tr>
                    </thead>
                    <tbody id="results-body">
                        <!-- Results will be populated here -->
                    </tbody>
                </table>
            </div>

            <button id="show-all-button" class="show-all-button">
                Show All Results
            </button>
        </div>

        <!-- Plots Section with Namespace Tabs -->
        <div class="plots-container">
            <!-- Namespace Tabs for Plots -->
            <div class="tab-container" style="margin-bottom: 1.5rem;">
                <div style="display: flex; gap: 1rem;">
                    <button class="tab-button active" data-plot-tab="biological-process-plots">
                        Biological Process
                    </button>
                    <button class="tab-button" data-plot-tab="molecular-function-plots">
                        Molecular Function
                    </button>
                    <button class="tab-button" data-plot-tab="cellular-component-plots">
                        Cellular Component
                    </button>
                </div>
            </div>

            <!-- Plot Content for Each Tab -->
            <div class="plot-tab-content active" id="biological-process-plots">
                <div class="plots-grid">
                    <!-- Main plot - Bar plot -->
                    <div class="main-plot">
                        <div class="plot-loading">Loading plot...</div>
                        <iframe id="bp-plot1" class="plot-frame" src="/plots/bp_bar.html" style="width: 100%; height: 100%; border: none;"></iframe>
                    </div>
                    
                    <!-- Secondary plots - Bubble plots -->
                    <div class="secondary-plots">
                        <div class="secondary-plot">
                            <div class="plot-loading">Loading plot...</div>
                            <iframe id="bp-plot2" class="plot-frame" src="/plots/bp_bubble.html" style="width: 100%; height: 100%; border: none;"></iframe>
                        </div>
                        <div class="secondary-plot">
                            <div class="plot-loading">Loading plot...</div>
                            <iframe id="bp-plot3" class="plot-frame" src="/plots/bp_network.html" style="width: 100%; height: 100%; border: none;"></iframe>
                        </div>
                    </div>
                </div>
            </div>

            <div class="plot-tab-content" id="molecular-function-plots">
                <div class="plots-grid">
                    <!-- Main plot - Bar plot -->
                    <div class="main-plot">
                        <div class="plot-loading">Loading plot...</div>
                        <iframe id="mf-plot1" class="plot-frame" src="/plots/mf_bar.html" style="width: 100%; height: 100%; border: none;"></iframe>
                    </div>
                    
                    <!-- Secondary plots - Bubble plots -->
                    <div class="secondary-plots">
                        <div class="secondary-plot">
                            <div class="plot-loading">Loading plot...</div>
                            <iframe id="mf-plot2" class="plot-frame" src="/plots/mf_bubble.html" style="width: 100%; height: 100%; border: none;"></iframe>
                        </div>
                        <div class="secondary-plot">
                            <div class="plot-loading">Loading plot...</div>
                            <iframe id="mf-plot3" class="plot-frame" src="/plots/mf_network.html" style="width: 100%; height: 100%; border: none;"></iframe>
                        </div>
                    </div>
                </div>
            </div>

            <div class="plot-tab-content" id="cellular-component-plots">
                <div class="plots-grid">
                    <!-- Main plot - Bar plot -->
                    <div class="main-plot">
                        <div class="plot-loading">Loading plot...</div>
                        <iframe id="cc-plot1" class="plot-frame" src="/plots/cc_bar.html" style="width: 100%; height: 100%; border: none;"></iframe>
                    </div>
                    
                    <!-- Secondary plots - Bubble plots -->
                    <div class="secondary-plots">
                        <div class="secondary-plot">
                            <div class="plot-loading">Loading plot...</div>
                            <iframe id="cc-plot2" class="plot-frame" src="/plots/cc_bubble.html" style="width: 100%; height: 100%; border: none;"></iframe>
                        </div>
                        <div class="secondary-plot">
                            <div class="plot-loading">Loading plot...</div>
                            <iframe id="cc-plot3" class="plot-frame" src="/plots/cc_network.html" style="width: 100%; height: 100%; border: none;"></iframe>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const plotTabButtons = document.querySelectorAll('[data-plot-tab]');
                const plotTabContents = document.querySelectorAll('.plot-tab-content');

                // Function to check if a plot exists
                function checkPlotExists(url, callback) {
                    fetch(url, { method: 'HEAD' })
                        .then(response => {
                            callback(response.ok);
                        })
                        .catch(() => {
                            callback(false);
                        });
                }

                // Add error handling for iframes
                function setupIframeErrorHandling() {
                    document.querySelectorAll('iframe.plot-frame').forEach(iframe => {
                        // Remove any existing event listeners by cloning
                        const newIframe = iframe.cloneNode(true);
                        iframe.parentNode.replaceChild(newIframe, iframe);
                        
                        // Set a timeout to check if the plot is taking too long to load
                        const loadTimeout = setTimeout(() => {
                            // If the iframe is still loading after 10 seconds, show an error
                            const loadingEl = newIframe.parentElement.querySelector('.plot-loading');
                            if (loadingEl) {
                                loadingEl.textContent = 'Plot is taking longer than expected to load...';
                            }
                        }, 10000); // 10 seconds
                        
                        // Add load event listener to check for errors and remove loading indicator
                        newIframe.addEventListener('load', function() {
                            // Clear the timeout
                            clearTimeout(loadTimeout);
                            
                            // Remove the loading indicator
                            const loadingEl = this.parentElement.querySelector('.plot-loading');
                            if (loadingEl) {
                                loadingEl.style.display = 'none';
                            }
                            
                            try {
                                // If we can access the iframe content and it's an error page
                                // Note: This might not work for cross-origin iframes due to security restrictions
                                if (this.contentDocument && 
                                    (this.contentDocument.title.includes('Error: Plot Not Found') || 
                                     this.contentDocument.body.textContent.includes('Plot Not Found') ||
                                     this.contentDocument.body.classList.contains('plot-error-page'))) {
                                    
                                    // Get the plot type and namespace from the iframe ID
                                    const id = this.id || '';
                                    let namespace = 'Unknown';
                                    let plotType = 'plot';
                                    
                                    if (id.startsWith('bp')) {
                                        namespace = 'Biological Process';
                                    } else if (id.startsWith('mf')) {
                                        namespace = 'Molecular Function';
                                    } else if (id.startsWith('cc')) {
                                        namespace = 'Cellular Component';
                                    }
                                    
                                    if (id.includes('plot1')) {
                                        plotType = 'bar plot';
                                    } else if (id.includes('plot2')) {
                                        plotType = 'bubble plot';
                                    } else if (id.includes('plot3')) {
                                        plotType = 'network plot';
                                    }
                                    
                                    this.parentElement.innerHTML = `<div class="no-plot-message">No ${plotType} available for ${namespace}</div>`;
                                }
                            } catch (e) {
                                // If we can't access the iframe content (cross-origin), we need to rely on the fetch check
                                console.log('Cannot check iframe content:', e);
                            }
                        });
                        
                        // Add error handler for the iframe
                        newIframe.addEventListener('error', function() {
                            // Clear the timeout
                            clearTimeout(loadTimeout);
                            
                            // Get the plot type and namespace from the iframe ID
                            const id = this.id || '';
                            let namespace = 'Unknown';
                            let plotType = 'plot';
                            
                            if (id.startsWith('bp')) {
                                namespace = 'Biological Process';
                            } else if (id.startsWith('mf')) {
                                namespace = 'Molecular Function';
                            } else if (id.startsWith('cc')) {
                                namespace = 'Cellular Component';
                            }
                            
                            if (id.includes('plot1')) {
                                plotType = 'bar plot';
                            } else if (id.includes('plot2')) {
                                plotType = 'bubble plot';
                            } else if (id.includes('plot3')) {
                                plotType = 'network plot';
                            }
                            
                            this.parentElement.innerHTML = `<div class="no-plot-message">No ${plotType} available for ${namespace}</div>`;
                        });
                    });
                    
                    // Also handle image loading
                    document.querySelectorAll('img.plot-frame').forEach(img => {
                        img.addEventListener('load', function() {
                            // Remove the loading indicator
                            const loadingEl = this.parentElement.querySelector('.plot-loading');
                            if (loadingEl) {
                                loadingEl.style.display = 'none';
                            }
                        });
                    });
                }

                // Function to check all plots for a namespace and show appropriate messages
                function checkNamespacePlots(namespace) {
                    let barExists = false;
                    let bubbleExists = false;
                    let networkExists = false;
                    
                    // Check bar plot
                    checkPlotExists(`/plots/${namespace}_bar_plot.html`, exists => {
                        barExists = exists;
                        const plotContainer = document.querySelector(`#${namespace}-plots .main-plot`);
                        if (!exists && plotContainer) {
                            plotContainer.innerHTML = `<div class="no-plot-message">No bar plot available for ${namespace.toUpperCase().replace('bp', 'Biological Process').replace('mf', 'Molecular Function').replace('cc', 'Cellular Component')}</div>`;
                        }
                        checkAllPlots();
                    });

                    // Check bubble plot
                    checkPlotExists(`/plots/${namespace}_bubble_plot.html`, exists => {
                        bubbleExists = exists;
                        const plotContainer = document.querySelector(`#${namespace}-plots .secondary-plot:first-of-type`);
                        if (!exists && plotContainer) {
                            plotContainer.innerHTML = `<div class="no-plot-message">No bubble plot available for ${namespace.toUpperCase().replace('bp', 'Biological Process').replace('mf', 'Molecular Function').replace('cc', 'Cellular Component')}</div>`;
                        }
                        checkAllPlots();
                    });

                    // Check network plot
                    checkPlotExists(`/plots/${namespace}_network_plot.html`, exists => {
                        networkExists = exists;
                        const plotContainer = document.querySelector(`#${namespace}-plots .secondary-plot:last-of-type`);
                        if (!exists && plotContainer) {
                            plotContainer.innerHTML = `<div class="no-plot-message">No network plot available for ${namespace.toUpperCase().replace('bp', 'Biological Process').replace('mf', 'Molecular Function').replace('cc', 'Cellular Component')}</div>`;
                        }
                        checkAllPlots();
                    });

                    // Function to check if all plots are missing and show a message
                    function checkAllPlots() {
                        if (!barExists && !bubbleExists && !networkExists) {
                            const tabContent = document.querySelector(`#${namespace}-plots`);
                            if (tabContent) {
                                tabContent.innerHTML = `<div class="no-plots-message">No plots available for ${namespace.toUpperCase().replace('bp', 'Biological Process').replace('mf', 'Molecular Function').replace('cc', 'Cellular Component')}</div>`;
                            }
                        }
                    }
                }

                // Check plots for all namespaces
                checkNamespacePlots('bp');
                checkNamespacePlots('mf');
                checkNamespacePlots('cc');
                
                // Set up iframe error handling
                setupIframeErrorHandling();

                plotTabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const currentActiveButton = document.querySelector('.tab-button[data-plot-tab].active');
                        const currentActiveTabContentElement = document.querySelector('.plot-tab-content.active');

                        if (currentActiveButton) {
                            currentActiveButton.classList.remove('active');
                        }
                        if (currentActiveTabContentElement) {
                            currentActiveTabContentElement.classList.remove('active');
                        }

                        button.classList.add('active');
                        const tabId = button.getAttribute('data-plot-tab');
                        const newActiveTabContent = document.getElementById(tabId);

                        if (newActiveTabContent) {
                            newActiveTabContent.classList.add('active'); 

                            requestAnimationFrame(() => {
                                const plotsGrid = newActiveTabContent.querySelector('.plots-grid');
                                const iframesInActiveTab = newActiveTabContent.querySelectorAll('iframe.plot-frame');

                                if (plotsGrid) {


                                    const originalOpacity = plotsGrid.style.opacity;
                                    plotsGrid.style.opacity = '0.9999'; 
                                    plotsGrid.offsetHeight; 
                                    plotsGrid.style.opacity = originalOpacity || ''; 
                                }

                                iframesInActiveTab.forEach(iframe => {
                                    const parentPlotElement = iframe.parentElement; 
                                    const loadingIndicator = parentPlotElement ? parentPlotElement.querySelector('.plot-loading') : null;

                                    if (parentPlotElement) {
                                        const originalDisplay = parentPlotElement.style.display;
                                        parentPlotElement.style.display = 'none';
                                        parentPlotElement.offsetHeight; 
                                        parentPlotElement.style.display = originalDisplay || '';
                                    }

                                    const currentSrc = iframe.getAttribute('src');

                                    if (currentSrc && currentSrc.trim() !== '' && currentSrc !== 'about:blank' && newActiveTabContent.id !== 'biological-process-plots') {
                                        if (iframe.dataset.isReloading !== 'true') {
                                            iframe.dataset.isReloading = 'true';

                                            if (loadingIndicator) {
                                                loadingIndicator.style.display = 'flex';
                                            }
                                            iframe.style.opacity = '0';

                                            const handleLoad = () => {
                                                if (loadingIndicator) {
                                                    loadingIndicator.style.display = 'none';
                                                }
                                                iframe.style.opacity = '1';
                                                cleanupListeners();
                                            };

                                            const handleError = () => {
                                                if (loadingIndicator) {
                                                    loadingIndicator.style.display = 'none';
                                                }
                                                if (parentPlotElement) {
                                                    const id = iframe.id || '';
                                                    let namespace = 'Unknown', plotType = 'plot';
                                                    if (id.startsWith('bp')) namespace = 'Biological Process';
                                                    else if (id.startsWith('mf')) namespace = 'Molecular Function';
                                                    else if (id.startsWith('cc')) namespace = 'Cellular Component';
                                                    if (id.includes('plot1')) plotType = 'bar plot';
                                                    else if (id.includes('plot2')) plotType = 'bubble plot';
                                                    else if (id.includes('plot3')) plotType = 'network plot';
                                                    parentPlotElement.innerHTML = `<div class="no-plot-message">Error loading ${plotType} for ${namespace}.</div>`;
                                                }
                                                cleanupListeners();
                                            };

                                            const cleanupListeners = () => {
                                                iframe.removeEventListener('load', handleLoad);
                                                iframe.removeEventListener('error', handleError);
                                                delete iframe.dataset.isReloading; 
                                            };

                                            iframe.addEventListener('load', handleLoad);
                                            iframe.addEventListener('error', handleError);

                                            iframe.src = 'about:blank'; 
                                            setTimeout(() => {
                                                iframe.src = currentSrc;
                                            }, 30); 
                                        }
                                    } else if (loadingIndicator) {
                                        try {
                                            if (iframe.contentWindow && iframe.contentWindow.document.readyState === 'complete') {
                                                loadingIndicator.style.display = 'none';
                                            }
                                        } catch (e) {
                                        }
                                    }
                                });
                            });
                        }
                    });
                });
            });
        </script>

        <!-- Modal -->
        <div id="full-results-modal" class="modal">
            <div class="modal-content">
                <span class="close-modal" id="close-modal">&times;</span>
                <div class="title" style="font-size: 1.5rem; margin-bottom: 1.5rem;">All Results</div>
                
                <!-- Add tab container -->
                <div class="tab-container">
                    <button class="tab-button active" data-namespace="all-results">All Results</button>
                    <button class="tab-button" data-namespace="biological-process">Biological Process</button>
                    <button class="tab-button" data-namespace="molecular-function">Molecular Function</button>
                    <button class="tab-button" data-namespace="cellular-component">Cellular Component</button>
                </div>

                <div class="table-container">
                    <!-- All Results Tab -->
                    <div class="tab-content active" id="modal-all-results-content">
                        <table class="results-table">
                            <thead>
                                <tr>
                                    <!-- Headers will be dynamically populated -->
                                </tr>
                            </thead>
                            <tbody id="modal-all-results-body">
                                <!-- Content will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Biological Process Tab -->
                    <div class="tab-content" id="modal-biological-process-content">
                        <table class="results-table">
                            <thead>
                                <tr>
                                    <!-- Headers will be dynamically populated -->
                                </tr>
                            </thead>
                            <tbody id="modal-biological-process-body">
                                <!-- Content will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Molecular Function Tab -->
                    <div class="tab-content" id="modal-molecular-function-content">
                        <table class="results-table">
                            <thead>
                                <tr>
                                    <!-- Headers will be dynamically populated -->
                                </tr>
                            </thead>
                            <tbody id="modal-molecular-function-body">
                                <!-- Content will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Cellular Component Tab -->
                    <div class="tab-content" id="modal-cellular-component-content">
                        <table class="results-table">
                            <thead>
                                <tr>
                                    <!-- Headers will be dynamically populated -->
                                </tr>
                            </thead>
                            <tbody id="modal-cellular-component-body">
                                <!-- Content will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ancestor Analysis Modal -->
        <div id="ancestor-analysis-modal" class="modal">
            <div class="modal-content">
                <span class="close-modal" id="close-ancestor-modal">&times;</span>
                <div class="modal-header">
                    <div class="title" style="font-size: 1.5rem; margin-bottom: 1rem;">Ancestor Analysis</div>
                    <p style="color: var(--text-secondary);">
                        Analyze common ancestors between GO terms to understand their relationships in the GO hierarchy. This tool helps you visualize how selected GO terms are related through their shared parent terms.
                    </p>
                </div>
                
                <div class="modal-body">
                    <div class="form-section">
                        <div class="form-group">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <label class="form-label" style="margin-bottom: 0;">Select GO Terms for Analysis</label>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button id="select-all-terms-btn" class="secondary-button" style="font-size: 0.875rem; padding: 0.25rem 0.75rem; background-color: var(--background-color); color: var(--text-secondary);">
                                        Select All
                                    </button>
                                    <button id="clear-all-terms-btn" class="secondary-button" style="font-size: 0.875rem; padding: 0.25rem 0.75rem; background-color: var(--background-color); color: var(--text-secondary);">
                                        Clear All
                                    </button>
                                </div>
                            </div>
                            <p style="color: var(--text-tertiary); font-size: 0.875rem; margin-top: 0.25rem; margin-bottom: 0.75rem;">
                                Select at least two GO terms to analyze their relationships and common ancestors in the GO hierarchy.
                            </p>
                            <div class="selected-terms-container" style="margin-bottom: 1rem;">
                                <div id="selected-terms-list" class="selected-terms-list">
                                    <p style="color: var(--text-tertiary); font-style: italic;">No terms selected yet</p>
                                </div>
                            </div>
                            
                            <div class="term-selection-controls">
                                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                                    <button id="select-from-results-btn" class="secondary-button" style="flex: 1;">
                                        Select from Results
                                    </button>
                                    <button id="enter-go-term-btn" class="secondary-button" style="flex: 1;">
                                        Enter GO Term ID
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Manual GO term entry -->
                            <div id="manual-go-entry" style="display: none; margin-bottom: 1rem;">
                                <div style="display: flex; gap: 0.5rem;">
                                    <input type="text" id="go-term-input" class="form-input" placeholder="Enter GO:0000000 format" 
                                           style="flex: 1;" pattern="GO:[0-9]{7}">
                                    <button id="add-go-term-btn" class="secondary-button">Add</button>
                                </div>
                                <p id="go-term-error" style="color: var(--error-color); font-size: 0.875rem; margin-top: 0.5rem; display: none;">
                                    Please enter a valid GO term ID in the format GO:0000000
                                </p>
                            </div>
                        </div>
                        
                        <button id="run-ancestor-analysis" class="primary-button" style="width: 100%; margin-top: 1.5rem;" disabled>
                            <span class="btn-text">Run Analysis</span>
                            <span class="spinner"></span>
                        </button>
                    </div>
                    
                    <!-- Results section (initially hidden) -->
                    <div id="ancestor-analysis-results" style="display: none; margin-top: 2rem;">
                        <h3 style="font-size: 1.25rem; margin-bottom: 1rem;">Analysis Results</h3>
                        <div id="ancestor-graph-container">
                            <!-- Graph will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Semantic Similarity Modal -->
        <div id="semantic-similarity-modal" class="modal">
            <div class="modal-content">
                <span class="close-modal" id="close-semantic-modal">&times;</span>
                <div class="modal-header">
                    <div class="title" style="font-size: 1.5rem; margin-bottom: 1rem;">Semantic Similarity</div>
                    <p style="color: var(--text-secondary);">
                        Calculate semantic similarity between GO terms to quantify their functional relatedness. This tool helps you understand how similar GO terms are based on their positions in the GO hierarchy.
                    </p>
                </div>
                
                <div class="modal-body">
                    <div class="form-section">
                        <div class="form-group">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <label class="form-label" style="margin-bottom: 0;">Select GO Terms for Similarity Analysis</label>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button id="semantic-select-all-terms-btn" class="secondary-button" style="font-size: 0.875rem; padding: 0.25rem 0.75rem; background-color: var(--background-color); color: var(--text-secondary);">
                                        Select All
                                    </button>
                                    <button id="semantic-clear-all-terms-btn" class="secondary-button" style="font-size: 0.875rem; padding: 0.25rem 0.75rem; background-color: var(--background-color); color: var(--text-secondary);">
                                        Clear All
                                    </button>
                                </div>
                            </div>
                            <p style="color: var(--text-tertiary); font-size: 0.875rem; margin-top: 0.25rem; margin-bottom: 0.75rem;">
                                Select at least two GO terms to analyze their semantic similarity.
                            </p>
                            <div class="selected-terms-container" style="margin-bottom: 1rem;">
                                <div id="semantic-selected-terms-list" class="selected-terms-list">
                                    <p style="color: var(--text-tertiary); font-style: italic;">No terms selected yet</p>
                                </div>
                            </div>
                            
                            <div class="term-selection-controls">
                                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                                    <button id="semantic-select-from-results-btn" class="secondary-button" style="flex: 1;">
                                        Select from Results
                                    </button>
                                    <button id="semantic-enter-go-term-btn" class="secondary-button" style="flex: 1;">
                                        Enter GO Term ID
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Manual GO term entry -->
                            <div id="semantic-manual-go-entry" style="display: none; margin-bottom: 1rem;">
                                <div style="display: flex; gap: 0.5rem;">
                                    <input type="text" id="semantic-go-term-input" class="form-input" placeholder="Enter GO:0000000 format" 
                                           style="flex: 1;" pattern="GO:[0-9]{7}">
                                    <button id="semantic-add-go-term-btn" class="secondary-button">Add</button>
                                </div>
                                <p id="semantic-go-term-error" style="color: var(--error-color); font-size: 0.875rem; margin-top: 0.5rem; display: none;">
                                    Please enter a valid GO term ID in the format GO:0000000
                                </p>
                            </div>
                        </div>
                        
                        <!-- Similarity Method Selection -->
                        <div class="form-group">
                            <label class="form-label">Similarity Method</label>
                            <p style="color: var(--text-tertiary); font-size: 0.875rem; margin-top: 0.25rem; margin-bottom: 0.75rem;">
                                Select the method to calculate semantic similarity between GO terms.
                            </p>
                            <div class="method-selection-container">
                                <label class="method-option">
                                    <input type="radio" name="similarity-method" value="resnik" checked>
                                    <div class="method-content">
                                        <span class="method-name">Resnik</span>
                                        <span class="method-description">Information content of common ancestor</span>
                                    </div>
                                </label>
                                <label class="method-option">
                                    <input type="radio" name="similarity-method" value="lin">
                                    <div class="method-content">
                                        <span class="method-name">Lin</span>
                                        <span class="method-description">Normalized information content</span>
                                    </div>
                                </label>
                                <label class="method-option">
                                    <input type="radio" name="similarity-method" value="jiang-conrath">
                                    <div class="method-content">
                                        <span class="method-name">Jiang-Conrath</span>
                                        <span class="method-description">Distance-based measure</span>
                                    </div>
                                </label>
                                <label class="method-option">
                                    <input type="radio" name="similarity-method" value="wang">
                                    <div class="method-content">
                                        <span class="method-name">Wang</span>
                                        <span class="method-description">Graph-based similarity</span>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <button id="run-semantic-similarity" class="primary-button" style="width: 100%; margin-top: 1.5rem;" disabled>
                            <span class="btn-text">Run Analysis</span>
                            <span class="spinner"></span>
                        </button>
                    </div>
                    
                    <!-- Results section (initially hidden) -->
                    <div id="semantic-similarity-results" style="display: none; margin-top: 2rem;">
                        <h3 style="font-size: 1.25rem; margin-bottom: 1rem;">Similarity Results</h3>
                        <div id="similarity-results-container">
                            <!-- Results will be displayed here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Function to format scientific notation nicely
            function formatScientific(num) {
                if (num === undefined || num === null || num === '') return '-';
                if (num === 0) return "0";
                if (typeof num === 'string') {
                    num = parseFloat(num);
                    if (isNaN(num)) return '-';
                }
                
                // Use exponential notation for very small numbers
                if (num < 0.0001) {
                    return num.toExponential(2);
                }
                
                // Use fixed notation for other numbers
                return num.toFixed(6);
            }

            // Function to format regular numbers
            function formatNumber(num) {
                if (num === undefined || num === null || num === '') return '-';
                if (num === 0) return "0";
                if (typeof num === 'string') {
                    num = parseFloat(num);
                    if (isNaN(num)) return '-';
                }
                return num.toFixed(2);
            }

            let allResults = [];
            let currentSortColumn = null;
            let currentSortDirection = null;

            // Function to sort data
            function sortData(data, column, type, direction) {
                return [...data].sort((a, b) => {
                    let valueA = a[column];
                    let valueB = b[column];
                    
                    // Special handling for "inf" values in log(Odds Ratio) column
                    if (column === 3) { // log(Odds Ratio) column
                        valueA = valueA === "inf" ? Infinity : parseFloat(valueA) || 0;
                        valueB = valueB === "inf" ? Infinity : parseFloat(valueB) || 0;
                        
                        // If values are equal (including both being Infinity), sort by p-value
                        if (valueA === valueB) {
                            const pValueA = parseFloat(a[4]) || 0;
                            const pValueB = parseFloat(b[4]) || 0;
                            return direction === 'asc' ? pValueA - pValueB : pValueB - pValueA;
                        }
                    } else if (type === 'numeric') {
                        valueA = parseFloat(valueA) || 0;
                        valueB = parseFloat(valueB) || 0;
                    }
                    
                    if (direction === 'asc') {
                        return valueA > valueB ? 1 : valueA < valueB ? -1 : 0;
                    } else {
                        return valueA < valueB ? 1 : valueA > valueB ? -1 : 0;
                    }
                });
            }

            // Function to initialize table sorting
            function initializeTableSorting(table) {
                if (!table) return;
                
                table.querySelectorAll('.sortable-header').forEach(header => {
                    header.addEventListener('click', function() {
                        const tbody = this.closest('table').querySelector('tbody');
                        const column = parseInt(this.dataset.column);
                        const type = this.dataset.type;
                        
                        // Reset all other arrows
                        table.querySelectorAll('.sortable-header').forEach(h => {
                            if (h !== header) {
                                h.querySelector('.sort-arrow').className = 'sort-arrow';
                            }
                        });
                        
                        // Toggle sort direction
                        let direction;
                        const arrow = this.querySelector('.sort-arrow');
                        
                        if (currentSortColumn !== column) {
                            direction = type === 'numeric' ? 'desc' : 'asc';
                        } else {
                            direction = currentSortDirection === 'asc' ? 'desc' : 'asc';
                        }
                        
                        arrow.className = `sort-arrow active ${direction}`;
                        currentSortColumn = column;
                        currentSortDirection = direction;
                        
                        // Get current namespace
                        const activeTab = document.querySelector('.results-table-container .tab-button.active');
                        const currentNamespace = activeTab ? activeTab.getAttribute('data-tab') : 'all-results';
                        
                        // Filter and sort data
                        let dataToSort = currentNamespace === 'all-results' ? 
                            allResults : 
                            allResults.filter(row => row[2].toLowerCase().replace(' ', '-') === currentNamespace);
                        
                        const sortedData = sortData(dataToSort, column, type === 'numeric' ? 'number' : 'string', direction);
                        
                        // Update table
                        tbody.innerHTML = '';
                        for (let i = 0; i < Math.min(10, sortedData.length); i++) {
                            tbody.appendChild(createTableRow(sortedData[i]));
                        }
                    });
                });
            }

            // Function to display results for a namespace
            function displayNamespaceResults(namespace) {
                const tbody = document.getElementById('results-body');
                tbody.innerHTML = '';
                
                let results = namespace === 'all-results' ? 
                    allResults : 
                    allResults.filter(columns => columns[2].toLowerCase().replace(' ', '-') === namespace);
                
                if (results.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                No results found for ${namespace.replace('-', ' ')}.
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // Display first 10 rows
                for (let i = 0; i < Math.min(10, results.length); i++) {
                    tbody.appendChild(createTableRow(results[i]));
                }
            }

            // Function to initialize tab switching
            function initializeTabSwitching() {
                const tabButtons = document.querySelectorAll('.results-table-container .tab-button');
                
                tabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const namespace = button.getAttribute('data-tab');
                        
                        // Update active states
                        tabButtons.forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        
                        // Reset sorting state
                        currentSortColumn = null;
                        currentSortDirection = null;
                        document.querySelectorAll('.sort-arrow').forEach(arrow => {
                            arrow.className = 'sort-arrow';
                        });
                        
                        // Display results for selected namespace
                        displayNamespaceResults(namespace);
                    });
                });
            }

            // Function to create a table row
            function createTableRow(columns) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><a href="https://www.ebi.ac.uk/QuickGO/term/${columns[0]}" 
                           target="_blank" 
                           class="go-term-link">${columns[0]}</a></td>
                    <td>${columns[1]}</td>
                    <td>${columns[2]}</td>
                    <td>${columns[3]}</td>
                    <td class="scientific">${formatScientific(columns[4])}</td>
                `;
                return row;
            }

            // Modal handling
            const modal = document.getElementById('full-results-modal');
            const closeModal = document.getElementById('close-modal');
            const showAllButton = document.getElementById('show-all-button');

            // Track current namespace for both main table and modal
            let currentMainNamespace = 'all-results';
            let currentModalNamespace = 'all-results';

            // Tab switching functionality for main table
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    // Remove active class from all buttons and contents
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    
                    // Add active class to clicked button and corresponding content
                    button.classList.add('active');
                    const tabId = button.getAttribute('data-tab');
                    document.getElementById(`${tabId}-content`).classList.add('active');

                    // Update current main namespace
                    currentMainNamespace = tabId;

                    // Load namespace-specific results if not already loaded
                    if (tabId !== 'all-results') {
                        loadNamespaceResults(tabId);
                    }
                });
            });

            // Show all results button handler
            document.getElementById('show-all-button').addEventListener('click', function() {
                const modal = document.getElementById('full-results-modal');
                
                // Show modal
                modal.classList.add('active');
                document.body.classList.add('modal-open');

                // Reset sort arrows in the main table
                document.querySelectorAll('.results-table-container .sort-arrow').forEach(arrow => {
                    arrow.className = 'sort-arrow';
                });

                // Get tab elements
                const modalTabButtons = modal.querySelectorAll('.tab-button');
                const modalTabContents = modal.querySelectorAll('.tab-content');
                
                // Get the headers from the main table
                const mainTableHeaders = Array.from(document.querySelector('.results-table thead tr').children);
                
                // Copy headers to all modal tables
                modal.querySelectorAll('.tab-content table thead tr').forEach(thead => {
                    // Clear existing headers
                    thead.innerHTML = '';
                    
                    // Copy headers from main table
                    mainTableHeaders.forEach(header => {
                        const clonedHeader = header.cloneNode(true);
                        thead.appendChild(clonedHeader);
                    });
                });

                // Initialize sorting for modal tables
                modal.querySelectorAll('.tab-content table').forEach(table => {
                    table.querySelectorAll('.sortable-header').forEach(header => {
                        header.addEventListener('click', function() {
                            const tbody = this.closest('table').querySelector('tbody');
                            const column = parseInt(this.dataset.column);
                            const type = this.dataset.type;
                            
                            // Reset all other arrows in this table
                            table.querySelectorAll('.sortable-header').forEach(h => {
                                if (h !== header) {
                                    const arrow = h.querySelector('.sort-arrow');
                                    if (arrow) arrow.className = 'sort-arrow';
                                }
                            });
                            
                            // Toggle sort direction
                            let direction;
                            const arrow = this.querySelector('.sort-arrow');
                            if (!arrow) return; // Skip if no arrow element
                            
                            const currentDirection = this.getAttribute('data-sort') || 'none';
                            const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
                            
                            this.setAttribute('data-sort', newDirection);
                            arrow.className = `sort-arrow active ${newDirection}`;
                            
                            // Get current rows and sort them
                            const rows = Array.from(tbody.querySelectorAll('tr'));
                            const sortedRows = rows.sort((rowA, rowB) => {
                                if (!rowA.cells[column] || !rowB.cells[column]) return 0;
                                
                                const cellA = rowA.cells[column].textContent.trim();
                                const cellB = rowB.cells[column].textContent.trim();
                                
                                if (type === 'numeric') {
                                    // Special handling for "inf" values in log(Odds Ratio) column
                                    let numA = cellA === "inf" ? Infinity : parseFloat(cellA) || 0;
                                    let numB = cellB === "inf" ? Infinity : parseFloat(cellB) || 0;
                                    
                                    // If sorting by log(Odds Ratio) and values are equal, sort by p-value
                                    if (column === 3 && numA === numB) {
                                        const pValueA = parseFloat(rowA.cells[4]?.textContent.trim()) || 0;
                                        const pValueB = parseFloat(rowB.cells[4]?.textContent.trim()) || 0;
                                        return newDirection === 'asc' ? pValueA - pValueB : pValueB - pValueA;
                                    }
                                    
                                    return newDirection === 'asc' ? numA - numB : numB - numA;
                                } else {
                                    return newDirection === 'asc' 
                                        ? cellA.localeCompare(cellB) 
                                        : cellB.localeCompare(cellA);
                                }
                            });
                            
                            // Clear and repopulate tbody
                            tbody.innerHTML = '';
                            sortedRows.forEach(row => tbody.appendChild(row));
                        });
                    });
                });

                // Function to populate modal table for a namespace
                function populateModalTable(namespace) {
                    const nsName = namespace.toLowerCase().replace(' ', '-');
                    const tbody = modal.querySelector(`#modal-${nsName}-body`);
                    
                    // Show loading state
                    tbody.innerHTML = Array(5).fill(`
                        <tr class="loading-row">
                            ${Array(mainTableHeaders.length).fill('<td class="loading-skeleton">&nbsp;</td>').join('')}
                        </tr>
                    `).join('');

                    // Filter results for this namespace (or get all results)
                    let namespaceResults = nsName === 'all-results' 
                        ? allResults 
                        : allResults.filter(columns => {
                            const resultNs = columns[2].toLowerCase().replace(' ', '-');
                            return resultNs === nsName;
                        });

                    // Sort by Odds Ratio and Statistical significance
                    namespaceResults.sort((a, b) => {
                        // First sort by Odds Ratio (index 3) descending
                        const oddsRatioA = a[3] === "inf" ? Infinity : parseFloat(a[3]) || 0;
                        const oddsRatioB = b[3] === "inf" ? Infinity : parseFloat(b[3]) || 0;
                        const oddsRatioDiff = oddsRatioB - oddsRatioA;
                        
                        if (Math.abs(oddsRatioDiff) < 0.0001) {
                            const statSigA = parseFloat(a[4]) || 0;
                            const statSigB = parseFloat(b[4]) || 0;
                            return statSigA - statSigB;
                        }
                        
                        return oddsRatioDiff;
                    });

                    tbody.innerHTML = ''; // Clear loading skeleton

                    // Display all results
                    if (namespaceResults.length > 0) {
                        namespaceResults.forEach(result => {
                            tbody.appendChild(createTableRow(result));
                        });
                    } else {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="${mainTableHeaders.length}" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                    No results found for ${namespace.replace('-', ' ')}.
                                </td>
                            </tr>
                        `;
                    }
                }

                // Activate the same tab that's active in the main table
                modalTabButtons.forEach(btn => {
                    const namespace = btn.dataset.namespace;
                    if (namespace === currentMainNamespace) {
                        // Update active states
                        modalTabButtons.forEach(b => b.classList.remove('active'));
                        modalTabContents.forEach(content => content.classList.remove('active'));
                        
                        btn.classList.add('active');
                        modal.querySelector(`#modal-${namespace}-content`).classList.add('active');
                        
                        // Update current modal namespace
                        currentModalNamespace = namespace;
                        
                        // Populate the table
                        populateModalTable(namespace);
                    }
                });

                // Handle tab switching in modal
                modalTabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const namespace = button.dataset.namespace;
                        
                        // Update active states
                        modalTabButtons.forEach(btn => btn.classList.remove('active'));
                        modalTabContents.forEach(content => content.classList.remove('active'));
                        
                        button.classList.add('active');
                        modal.querySelector(`#modal-${namespace}-content`).classList.add('active');
                        
                        // Update current modal namespace
                        currentModalNamespace = namespace;
                        
                        // Update table content
                        populateModalTable(namespace);
                    });
                });

                // Close button handler with tab sync
                const closeHandler = () => {
                    modal.classList.remove('active');
                    document.body.classList.remove('modal-open');

                    // Sync main table tab with modal's last active tab
                    const mainTabButton = document.querySelector(`.tab-button[data-tab="${currentModalNamespace}"]`);
                    if (mainTabButton) {
                        mainTabButton.click();
                    }
                };

                // Close button handler
                modal.querySelector('.close-modal').addEventListener('click', closeHandler);

                // Click outside to close
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeHandler();
                    }
                });
            });

            closeModal.addEventListener('click', () => {
                modal.classList.remove('active');
            });

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });

            document.addEventListener('DOMContentLoaded', function() {
                // Load results when the page loads
                loadResults();

                // Initialize function buttons
                initializeFunctionButtons();

                // Initialize tab switching and other UI elements
                initializeUI();

                // Initialize plot tabs
                const plotTabButtons = document.querySelectorAll('[data-plot-tab]');
                const plotTabContents = document.querySelectorAll('.plot-tab-content');

                plotTabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        plotTabButtons.forEach(btn => btn.classList.remove('active'));
                        plotTabContents.forEach(content => content.classList.remove('active'));

                        button.classList.add('active');
                        const tabId = button.getAttribute('data-plot-tab');
                        document.getElementById(tabId).classList.add('active');

                    });
                });
            });

            function initializeFunctionButtons() {
                let storedSelectedTerms = new Set();

                const ancestorAnalysisButton = document.querySelector('.secondary-button:nth-child(1)');
                ancestorAnalysisButton.addEventListener('click', () => {
                    // Open the ancestor analysis modal instead of showing an alert
                    const modal = document.getElementById('ancestor-analysis-modal');
                    modal.classList.add('active');
                    document.body.classList.add('modal-open');
                });

                // Close button handler for ancestor analysis modal
                const closeAncestorModal = document.getElementById('close-ancestor-modal');
                closeAncestorModal.addEventListener('click', () => {
                    const modal = document.getElementById('ancestor-analysis-modal');
                    modal.classList.remove('active');
                    document.body.classList.remove('modal-open');
                });

                // Click outside to close ancestor analysis modal
                document.getElementById('ancestor-analysis-modal').addEventListener('click', (e) => {
                    if (e.target === document.getElementById('ancestor-analysis-modal')) {
                        document.getElementById('ancestor-analysis-modal').classList.remove('active');
                        document.body.classList.remove('modal-open');
                    }
                });

                // Initialize ancestor analysis functionality
                initializeAncestorAnalysis();

                // Semantic Similarity Button Handler
                const semanticSimilarityButton = document.querySelector('.secondary-button:nth-child(2)');
                semanticSimilarityButton.addEventListener('click', () => {
                    // Open the semantic similarity modal
                    const modal = document.getElementById('semantic-similarity-modal');
                    modal.classList.add('active');
                    document.body.classList.add('modal-open');
                });

                // Close button handler for semantic similarity modal
                const closeSemanticModal = document.getElementById('close-semantic-modal');
                closeSemanticModal.addEventListener('click', () => {
                    const modal = document.getElementById('semantic-similarity-modal');
                    modal.classList.remove('active');
                    document.body.classList.remove('modal-open');
                });

                // Click outside to close semantic similarity modal
                document.getElementById('semantic-similarity-modal').addEventListener('click', (e) => {
                    if (e.target === document.getElementById('semantic-similarity-modal')) {
                        document.getElementById('semantic-similarity-modal').classList.remove('active');
                        document.body.classList.remove('modal-open');
                    }
                });

                // Initialize semantic similarity functionality
                initializeSemanticSimilarity();

                // Pathway Analysis Button Handler
                const pathwayButtonMain = document.querySelector('.secondary-button:nth-child(3)');
                pathwayButtonMain.addEventListener('click', () => {
                    alert('Pathway analysis is coming soon!');
            });

            // Download Button Handler
            const downloadButton = document.querySelector('.download-button');
                if (downloadButton) {
            downloadButton.addEventListener('click', () => {
                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 500px; padding: 2rem;">
                        <span class="close-modal">&times;</span>
                        
                        <div class="title" style="font-size: 1.5rem; margin-bottom: 1.5rem;">
                            Download Results
                        </div>
                        
                        <p style="color: var(--text-secondary); font-size: 1rem; margin-bottom: 2rem;">
                            Select in what form/s you want to save the results
                        </p>
                        
                        <div style="display: flex; flex-direction: column; gap: 1.25rem; margin-bottom: 2rem;">
                            <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.75rem; background: var(--background-color); border-radius: 0.5rem; transition: all 0.2s ease;">
                                <input type="checkbox" class="format-checkbox" value="csv" style="width: 1.25rem; height: 1.25rem; cursor: pointer;">
                                <span style="color: var(--text-primary); font-size: 1rem;">CSV</span>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.75rem; background: var(--background-color); border-radius: 0.5rem; transition: all 0.2s ease;">
                                <input type="checkbox" class="format-checkbox" value="tsv" style="width: 1.25rem; height: 1.25rem; cursor: pointer;">
                                <span style="color: var(--text-primary); font-size: 1rem;">TSV</span>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.75rem; background: var(--background-color); border-radius: 0.5rem; transition: all 0.2s ease;">
                                <input type="checkbox" class="format-checkbox" value="json" style="width: 1.25rem; height: 1.25rem; cursor: pointer;">
                                <span style="color: var(--text-primary); font-size: 1rem;">JSON</span>
                            </label>
                        </div>

                        <button class="primary-button download-save-btn" 
                                style="background-color: var(--primary-color); width: 100%; padding: 1rem; border-radius: 0.5rem; color: white; font-weight: 600; transition: all 0.2s ease;">
                            Save
                        </button>
                    </div>
                `;
                
                // Add hover effect to option labels
                const labels = modal.querySelectorAll('label');
                labels.forEach(label => {
                    label.addEventListener('mouseover', () => {
                        label.style.background = 'var(--card-background)';
                    });
                    label.addEventListener('mouseout', () => {
                        label.style.background = 'var(--background-color)';
                    });
                });
                
                document.body.appendChild(modal);
                        toggleModalState(true);
                
                // Handle save button click
                const saveButton = modal.querySelector('.download-save-btn');
                saveButton.addEventListener('click', async () => {
                    const selectedFormats = Array.from(modal.querySelectorAll('.format-checkbox:checked'))
                        .map(checkbox => checkbox.value);
                    
                    if (selectedFormats.length === 0) {
                        alert('Please select at least one format');
                        return;
                    }

                    try {
                        saveButton.classList.add('loading');
                        
                        // Download files sequentially
                        for (const format of selectedFormats) {
                            const link = document.createElement('a');
                            link.style.display = 'none';
                            document.body.appendChild(link);
                            
                            const response = await fetch(`/download/${format}`);
                            if (!response.ok) {
                                throw new Error(`Download failed for ${format}`);
                            }
                            
                            // Get the filename from the Content-Disposition header if available
                            let filename = `results.${format}`;
                            const contentDisposition = response.headers.get('Content-Disposition');
                            if (contentDisposition) {
                                const filenameMatch = contentDisposition.match(/filename="(.+?)"/);
                                if (filenameMatch && filenameMatch[1]) {
                                    filename = filenameMatch[1];
                                }
                            }
                            
                            const blob = await response.blob();
                            const url = window.URL.createObjectURL(blob);
                            link.href = url;
                            link.download = filename;
                            link.click();
                            
                            window.URL.revokeObjectURL(url);
                            document.body.removeChild(link);
                        }
                        
                        document.body.removeChild(modal);
                                toggleModalState(false);
                    } catch (error) {
                        console.error('Error downloading files:', error);
                        alert('Error downloading files. Please try again.');
                    } finally {
                        saveButton.classList.remove('loading');
                    }
                });
                
                const closeButton = modal.querySelector('.close-modal');
                closeButton.addEventListener('click', () => {
                    document.body.removeChild(modal);
                            toggleModalState(false);
                });
                
                modal.addEventListener('click', (event) => {
                    if (event.target === modal) {
                        document.body.removeChild(modal);
                                toggleModalState(false);
                    }
                });
            });
                } else {
                    console.error('Download button not found');
                }
        }

        // Add this function to sort the results when they're first loaded
        function sortResultsByOddsRatioAndPValue(results) {
            return results.sort((a, b) => {
                // First sort by Odds Ratio (index 3) descending
                const oddsRatioA = a[3] === "inf" ? Infinity : parseFloat(a[3]) || 0;
                const oddsRatioB = b[3] === "inf" ? Infinity : parseFloat(b[3]) || 0;
                
                // If Odds Ratio is different, sort by that
                if (oddsRatioA !== oddsRatioB) {
                    return oddsRatioB - oddsRatioA; // Descending order
                }
                
                // If Odds Ratio is equal (including both being Infinity), sort by p-value ascending
                const pValueA = parseFloat(a[4]) || 0;
                const pValueB = parseFloat(b[4]) || 0;
                return pValueA - pValueB; // Ascending order for p-values
            });
        }

        // Add function to handle modal open/close
        function toggleModalState(isOpen) {
            document.body.classList.toggle('modal-open', isOpen);
        }

        // Function to load namespace-specific results
        async function loadNamespaceResults(namespace) {
            try {
                const tbody = document.querySelector(`#${namespace}-body`);
                const thead = document.querySelector(`#${namespace}-table thead tr`);
                
                // Show loading skeleton
                tbody.innerHTML = Array(5).fill(0).map(() => `
                    <tr class="loading-row">
                        ${Array(9).fill('<td class="loading-skeleton">&nbsp;</td>').join('')}
                    </tr>
                `).join('');

                // Get the headers from the main table
                const mainTableHeaders = Array.from(document.querySelector('.results-table thead tr').children);
                
                // Clear existing headers
                thead.innerHTML = '';
                
                // Copy headers from main table
                mainTableHeaders.forEach(header => {
                    thead.appendChild(header.cloneNode(true));
                });

                // Filter the existing allResults based on namespace only
                let namespaceResults = allResults.filter(columns => {
                    const nsName = columns[2].toLowerCase().replace(' ', '-');
                    return namespace === nsName;
                });

                tbody.innerHTML = ''; // Clear loading skeleton

                // Display results
                if (namespaceResults.length > 0) {
                    // Display only top 10 results
                    for (let i = 0; i < Math.min(10, namespaceResults.length); i++) {
                        tbody.appendChild(createTableRow(namespaceResults[i]));
                    }
                } else {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="${mainTableHeaders.length}" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                No results found for ${namespace.replace('-', ' ')}.
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error(`Error loading ${namespace} results:`, error);
            }
        }

        // Add CSS for tabs
        const style = document.createElement('style');
        style.textContent = `
            .tab-container {
                border-bottom: 1px solid var(--border-color);
            }
            
            .tab-button {
                padding: 0.5rem 1rem;
                border: none;
                background: none;
                cursor: pointer;
                color: var(--text-secondary);
                font-weight: 500;
                transition: color 0.2s;
            }
            
            .tab-button:hover {
                color: var(--text-primary);
            }
            
            .tab-button.active {
                color: var(--primary-color);
                border-bottom: 2px solid var(--primary-color);
            }
            
            .tab-content {
                display: none;
            }
            
            .tab-content.active {
                display: block;
            }
        `;
        document.head.appendChild(style);

        // Initialize sorting for modal tables
        modal.querySelectorAll('.sortable-header').forEach(header => {
            header.addEventListener('click', function() {
                const table = this.closest('table');
                const tbody = table.querySelector('tbody');
                const column = parseInt(this.dataset.column);
                const type = this.dataset.type;
                
                // Reset all other arrows
                table.querySelectorAll('.sortable-header').forEach(h => {
                    if (h !== header) {
                        h.querySelector('.sort-arrow').className = 'sort-arrow';
                    }
                });
                
                // Toggle sort direction
                let direction;
                const arrow = this.querySelector('.sort-arrow');
                const currentDirection = this.getAttribute('data-sort') || 'none';
                const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
                
                this.setAttribute('data-sort', newDirection);
                arrow.className = `sort-arrow active ${newDirection}`;
                
                // Get current rows and sort them
                const rows = Array.from(tbody.querySelectorAll('tr'));
                const sortedRows = rows.sort((rowA, rowB) => {
                    const cellA = rowA.cells[column].textContent.trim();
                    const cellB = rowB.cells[column].textContent.trim();
                    
                    if (type === 'numeric') {
                        // Special handling for "inf" values in log(Odds Ratio) column
                        let numA = cellA === "inf" ? Infinity : parseFloat(cellA) || 0;
                        let numB = cellB === "inf" ? Infinity : parseFloat(cellB) || 0;
                        return newDirection === 'asc' ? numA - numB : numB - numA;
                    } else {
                        return newDirection === 'asc' 
                            ? cellA.localeCompare(cellB) 
                            : cellB.localeCompare(cellA);
                    }
                });
                
                // Clear and repopulate tbody
                tbody.innerHTML = '';
                sortedRows.forEach(row => tbody.appendChild(row));
            });
        });

        // Add this to your existing JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            // Add full title data attributes to all sortable headers that don't have them
            document.querySelectorAll('.sortable-header').forEach(header => {
                if (!header.hasAttribute('data-full-title')) {
                    // Use the text content as the full title if not specified
                    header.setAttribute('data-full-title', header.textContent.replace(/|/, '').trim());
                }
            });
        });

        // Add this to the script section
        document.addEventListener('DOMContentLoaded', function() {
            // Only keep the "New Analysis" button handler
            const newAnalysisButton = document.querySelector('button[onclick="clearDataAndRedirect()"]');
            if (newAnalysisButton) {
                newAnalysisButton.removeAttribute('onclick');
                newAnalysisButton.addEventListener('click', async function() {
                    try {
                        // First clear the results
                        await fetch('/clear-results', { method: 'POST' });
                        
                        // Then clear the data folder
                        await fetch('/clear-data-folder', { method: 'POST' });
                        
                        // Redirect to home page
                        window.location.href = '/';
                    } catch (error) {
                        console.error('Error clearing data:', error);
                        // Redirect anyway even if there's an error
                        window.location.href = '/';
                    }
                });
            }
            
            // Check if this is a single testing result and update the "Change Results" button accordingly
            const changeResultsButton = document.querySelector('button[onclick="window.location.href=\'/loading?subsequent=true&odds_ratio_threshold=1.0&n_protein_threshold=1\'"]');
            if (changeResultsButton) {
                changeResultsButton.removeAttribute('onclick');
                
                // First, disable the button by default until we confirm it's multiple testing
                changeResultsButton.disabled = true;
                changeResultsButton.style.backgroundColor = 'var(--text-tertiary)';
                changeResultsButton.style.opacity = '0.6';
                changeResultsButton.style.cursor = 'not-allowed';
                changeResultsButton.title = 'Change Results is not available for single testing';
                
                // Check if this is a single testing result
                fetch('/check-testing-type')
                    .then(response => response.json())
                    .then(data => {
                        console.log("Testing type check result:", data); // Add logging to debug
                        
                        // Only enable the button if explicitly NOT single testing
                        if (data.is_single_testing === false) {
                            // Enable the button for multiple testing
                            changeResultsButton.disabled = false;
                            changeResultsButton.style.backgroundColor = '';
                            changeResultsButton.style.opacity = '';
                            changeResultsButton.style.cursor = '';
                            changeResultsButton.title = 'Change which results file to display';
                            
                            changeResultsButton.addEventListener('click', function() {
                                // Create and show the selection modal
                                showResultsSelectionModal();
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error checking testing type:', error);
                        // Keep the button disabled if there's an error
                    });
            }
        });

        // Function to show the results selection modal
        async function showResultsSelectionModal() {
            // Create modal element with the exact same structure as in loading.html
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-title">Select Results for Presentation</div>
                    <div class="selection-list" id="selectionList">
                        <!-- Categories will be populated here -->
                    </div>
                    <button class="continue-btn" id="continueBtn" disabled>Continue to Results</button>
                </div>
            `;
            
            // Add the exact same styles as in loading.html
            const style = document.createElement('style');
            style.textContent = `
                .modal {
                    display: none;
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.5);
                    justify-content: center;
                    align-items: center;
                    z-index: 1000;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                }

                .modal.fade-in {
                    opacity: 1;
                }

                .modal-content {
                    background-color: var(--card-background);
                    padding: 2rem;
                    border-radius: 1rem;
                    box-shadow: 0 8px 16px -1px rgb(0 0 0 / 0.1);
                    max-width: 500px;
                    width: 90%;
                    max-height: 80vh;
                    display: flex;
                    flex-direction: column;
                    transform: translateY(20px);
                    opacity: 0;
                    transition: all 0.3s ease;
                }

                .modal.show .modal-content {
                    transform: translateY(0);
                    opacity: 1;
                }

                .modal-title {
                    font-size: 1.5rem;
                    font-weight: 700;
                    margin-bottom: 1.5rem;
                    color: var(--text-primary);
                    text-align: center;
                    padding-bottom: 1rem;
                    border-bottom: 2px solid var(--border-color);
                }

                .selection-list {
                    flex: 1;
                    overflow-y: auto;
                    margin: 1rem -2rem;
                    padding: 0 2rem;
                    scrollbar-width: thin;
                    scrollbar-gutter: stable;
                }

                .category-group {
                    margin-bottom: 1.5rem;
                    background-color: var(--background-color);
                    border-radius: 0.75rem;
                    overflow: hidden;
                    box-shadow: 0 2px 4px -1px rgb(0 0 0 / 0.05);
                }

                .category-title {
                    font-weight: 600;
                    padding: 1rem;
                    color: var(--text-primary);
                    font-size: 1rem;
                    text-transform: capitalize;
                    background-color: var(--primary-color);
                    color: white;
                }

                .selection-item {
                    display: flex;
                    align-items: center;
                    padding: 1rem;
                    border-bottom: 1px solid var(--border-color);
                    cursor: pointer;
                    transition: all 0.2s ease;
                    background-color: var(--card-background);
                }

                .selection-item:last-child {
                    border-bottom: none;
                }

                .selection-item:hover {
                    background-color: var(--background-color);
                }

                .selection-item input[type="radio"] {
                    margin-right: 1rem;
                    width: 1.25rem;
                    height: 1.25rem;
                    border: 2px solid var(--border-color);
                    border-radius: 50%;
                    appearance: none;
                    -webkit-appearance: none;
                    outline: none;
                    cursor: pointer;
                    position: relative;
                    transition: all 0.2s ease;
                }

                .selection-item input[type="radio"]:checked {
                    border-color: var(--primary-color);
                    background-color: var(--primary-color);
                }

                .selection-item input[type="radio"]:checked::after {
                    content: '';
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    width: 0.5rem;
                    height: 0.5rem;
                    background-color: white;
                    border-radius: 50%;
                }

                .selection-item label {
                    cursor: pointer;
                    font-size: 1rem;
                    color: var(--text-primary);
                    flex: 1;
                }

                .continue-btn {
                    background-color: var(--primary-color);
                    color: white;
                    border: none;
                    padding: 1rem 2rem;
                    font-size: 1.1rem;
                    font-weight: 600;
                    border-radius: 0.75rem;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    margin-top: 2rem;
                    width: 100%;
                    box-shadow: 0 4px 6px -1px rgb(79 70 229 / 0.3);
                }

                .continue-btn:not(:disabled):hover {
                    background-color: var(--primary-hover);
                    transform: translateY(-2px);
                    box-shadow: 0 6px 8px -1px rgb(79 70 229 / 0.4);
                }

                .continue-btn:disabled {
                    opacity: 0.7;
                    cursor: not-allowed;
                    transform: none;
                }

                .selection-list::-webkit-scrollbar {
                    width: 4px;
                }

                .selection-list::-webkit-scrollbar-track {
                    background: transparent;
                }

                .selection-list::-webkit-scrollbar-thumb {
                    background-color: #d4d4d4;
                    border-radius: 2px;
                    opacity: 0;
                    transition: opacity 0.3s;
                }

                .selection-list:hover::-webkit-scrollbar-thumb {
                    opacity: 1;
                }
                
                .loading-container {
                    text-align: center;
                    padding: 2rem;
                    background: var(--card-background);
                    border-radius: 1rem;
                    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
                    max-width: 600px;
                    width: 100%;
                    transition: opacity 0.3s ease;
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    z-index: 2000;
                }

                .loading-text {
                    font-size: 1.5rem;
                    font-weight: 600;
                    margin-bottom: 2rem;
                    color: var(--text-primary);
                }

                .spinner {
                    width: 50px;
                    height: 50px;
                    border: 5px solid var(--border-color);
                    border-top-color: var(--primary-color);
                    border-radius: 50%;
                    animation: spin 1s linear infinite;
                    margin: 0 auto;
                }

                @keyframes spin {
                    to { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(modal);
            
            // Show modal with animation exactly like in loading.html
            modal.style.display = 'flex';
            setTimeout(() => {
                modal.classList.add('fade-in', 'show');
            }, 10);
            
            toggleModalState(true);
            
            // Load categories and files
            let selectedOption = null;
            const continueBtn = modal.querySelector('#continueBtn');
            const selectionList = modal.querySelector('#selectionList');
            
            try {
                // Check if combined results were enabled in the original analysis
                const combinedFilesResponse = await fetch('/get-combined-files');
                const combinedFiles = await combinedFilesResponse.json();
                const hasCombinedResults = combinedFilesResponse.ok && combinedFiles.length > 0;
                
                // Get single files
                const singleFilesResponse = await fetch('/get-single-files');
                const singleFiles = singleFilesResponse.ok ? await singleFilesResponse.json() : [];
                
                // If we have combined results, show both sections
                if (hasCombinedResults) {
                    // Create Combined Results section
                    const combinedGroup = document.createElement('div');
                    combinedGroup.className = 'category-group';
                    
                    const combinedTitle = document.createElement('div');
                    combinedTitle.className = 'category-title';
                    combinedTitle.textContent = 'Combined Results';
                    combinedGroup.appendChild(combinedTitle);
                    
                    // Sort files alphabetically by display name
                    combinedFiles.sort((a, b) => {
                        const displayNameA = a.replace("_GOEA_results.txt", "");
                        const displayNameB = b.replace("_GOEA_results.txt", "");
                        return displayNameA.localeCompare(displayNameB);
                    });
                    
                    // Add each combined file as an option
                    combinedFiles.forEach(file => {
                        const item = document.createElement('div');
                        item.className = 'selection-item';
                        
                        const radio = document.createElement('input');
                        radio.type = 'radio';
                        radio.name = 'category';
                        radio.value = JSON.stringify({
                            type: 'combined_file',
                            filename: file
                        });
                        radio.id = `combined-file-${file}`;
                        
                        const label = document.createElement('label');
                        label.htmlFor = radio.id;
                        const rawName = file.replace("_GOEA_results.txt", "");
                        // Replace underscores with spaces and capitalize first letter of each word
                        const displayName = rawName.split('_')
                            .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                            .join(' ');
                        label.textContent = displayName;
                        
                        radio.addEventListener('change', () => {
                            selectedOption = {
                                type: 'combined_file',
                                filename: file
                            };
                            continueBtn.disabled = false;
                        });
                        
                        item.appendChild(radio);
                        item.appendChild(label);
                        combinedGroup.appendChild(item);
                    });
                    
                    selectionList.appendChild(combinedGroup);
                }
                
                // Create Single Results section
                const singleGroup = document.createElement('div');
                singleGroup.className = 'category-group';
                
                const singleTitle = document.createElement('div');
                singleTitle.className = 'category-title';
                singleTitle.textContent = 'Single Results';
                singleGroup.appendChild(singleTitle);
                
                if (singleFiles.length > 0) {
                    // Sort files alphabetically by display name
                    singleFiles.sort((a, b) => {
                        const displayNameA = a.replace("_GOEA_results.txt", "");
                        const displayNameB = b.replace("_GOEA_results.txt", "");
                        return displayNameA.localeCompare(displayNameB);
                    });
                    
                    // Add each single file as an option
                    singleFiles.forEach(file => {
                        const item = document.createElement('div');
                        item.className = 'selection-item';
                        
                        const radio = document.createElement('input');
                        radio.type = 'radio';
                        radio.name = 'category';
                        radio.value = JSON.stringify({
                            type: 'single_file',
                            filename: file
                        });
                        radio.id = `single-file-${file}`;
                        
                        const label = document.createElement('label');
                        label.htmlFor = radio.id;
                        const rawName = file.replace("_GOEA_results.txt", "");
                        // Replace underscores with spaces and capitalize first letter of each word
                        const displayName = rawName.split('_')
                            .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                            .join(' ');
                        label.textContent = displayName;
                        
                        radio.addEventListener('change', () => {
                            selectedOption = {
                                type: 'single_file',
                                filename: file
                            };
                            continueBtn.disabled = false;
                        });
                        
                        item.appendChild(radio);
                        item.appendChild(label);
                        singleGroup.appendChild(item);
                    });
                } else {
                    // No single files found
                    const noFiles = document.createElement('div');
                    noFiles.className = 'selection-item';
                    noFiles.style.fontStyle = 'italic';
                    noFiles.textContent = 'No single results files found';
                    singleGroup.appendChild(noFiles);
                }
                
                selectionList.appendChild(singleGroup);
                
                // Handle continue button click exactly as in loading.html
                continueBtn.addEventListener('click', async () => {
                    if (selectedOption) {
                        // Show loading container while copying file
                        const loadingDiv = document.createElement('div');
                        loadingDiv.className = 'loading-container';
                        loadingDiv.innerHTML = `
                            <div class="loading-text">Processing your request...</div>
                            <div class="spinner"></div>
                        `;
                        document.body.appendChild(loadingDiv);
                        modal.style.display = 'none';
                        
                        try {
                            // Copy the selected file to results.txt
                            const copyResponse = await fetch('/copy-results-file', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify(selectedOption)
                            });
                            
                            if (!copyResponse.ok) {
                                throw new Error('Failed to copy results file');
                            }
                            
                            // Store the selection
                            localStorage.setItem('selectedBackground', JSON.stringify(selectedOption));
                            
                            // Reload the current page to show the new results
                            window.location.reload();
                        } catch (error) {
                            console.error('Error copying results file:', error);
                            alert('Error copying results file: ' + error.message);
                            document.body.removeChild(loadingDiv);
                            modal.style.display = 'flex';
                        }
                    }
                });
                
                // Add close button functionality
                const closeButton = document.createElement('span');
                closeButton.className = 'close-modal';
                closeButton.innerHTML = '&times;';
                closeButton.style.position = 'absolute';
                closeButton.style.right = '1.5rem';
                closeButton.style.top = '1.5rem';
                closeButton.style.fontSize = '1.5rem';
                closeButton.style.cursor = 'pointer';
                closeButton.style.color = 'var(--text-secondary)';
                modal.querySelector('.modal-content').prepend(closeButton);
                
                closeButton.addEventListener('click', () => {
                    document.body.removeChild(modal);
                    toggleModalState(false);
                });
                
                // Click outside to close
                modal.addEventListener('click', (event) => {
                    if (event.target === modal) {
                        document.body.removeChild(modal);
                        toggleModalState(false);
                    }
                });
            } catch (error) {
                console.error('Error loading selection options:', error);
                selectionList.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: var(--error-color);">
                        Error loading selection options. Please try again.
                    </div>
                `;
            }
        }

        // Add this new function to initialize the ancestor analysis functionality
        function initializeAncestorAnalysis() {
            // Store selected GO terms
            const selectedTerms = new Set();
            const selectedTermsList = document.getElementById('selected-terms-list');
            const runAnalysisButton = document.getElementById('run-ancestor-analysis');
            
            // Toggle manual GO term entry
            document.getElementById('enter-go-term-btn').addEventListener('click', () => {
                const manualEntry = document.getElementById('manual-go-entry');
                manualEntry.style.display = manualEntry.style.display === 'none' ? 'block' : 'none';
            });
            
            // Add GO term from manual entry
            document.getElementById('add-go-term-btn').addEventListener('click', () => {
                const input = document.getElementById('go-term-input');
                const errorMsg = document.getElementById('go-term-error');
                const goTermPattern = /^GO:[0-9]{7}$/;
                
                if (goTermPattern.test(input.value)) {
                    addSelectedTerm(input.value);
                    input.value = '';
                    errorMsg.style.display = 'none';
                } else {
                    errorMsg.style.display = 'block';
                }
            });

            // Also allow pressing Enter to add a GO term
            document.getElementById('go-term-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    document.getElementById('add-go-term-btn').click();
                }
            });
            
            // Clear all terms button handler
            document.getElementById('clear-all-terms-btn').addEventListener('click', () => {
                clearAllSelectedTerms();
            });
            
            // Select all terms button handler
            document.getElementById('select-all-terms-btn').addEventListener('click', () => {
                selectAllTerms();
            });
            
            // Select from results button handler
            document.getElementById('select-from-results-btn').addEventListener('click', () => {
                // Create a temporary modal to select terms from results
                const selectModal = document.createElement('div');
                selectModal.className = 'modal active';
                selectModal.innerHTML = `
                    <div class="modal-content" style="width: 80%; max-width: 1000px;">
                        <span class="close-modal">&times;</span>
                        <div class="title" style="font-size: 1.25rem; margin-bottom: 1rem;">Select GO Terms</div>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                            Select GO terms from your results to include in the ancestor analysis.
                        </p>
                        <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                            <table class="results-table">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;"></th>
                                        <th>GO Term ID</th>
                                        <th>Name</th>
                                        <th>Namespace</th>
                                    </tr>
                                </thead>
                                <tbody id="term-selection-body">
                                    <!-- Will be populated with results -->
                                </tbody>
                            </table>
                        </div>
                        <button class="primary-button" id="confirm-selection" style="margin-top: 1rem;">
                            Confirm Selection
                        </button>
                    </div>
                `;
                
                document.body.appendChild(selectModal);
                
                // Populate the table with results
                const selectionBody = document.getElementById('term-selection-body');
                allResults.forEach(result => {
                    const row = document.createElement('tr');
                    const isSelected = selectedTerms.has(result[0]);
                    
                    row.innerHTML = `
                        <td>
                            <input type="checkbox" class="species-selection-checkbox" value="${result[0]}" 
                                   ${isSelected ? 'checked' : ''}>
                        </td>
                        <td>${result[0]}</td>
                        <td>${result[1]}</td>
                        <td>${result[2]}</td>
                    `;
                    
                    selectionBody.appendChild(row);
                    
                    // Add event listener to checkbox to automatically add/remove terms when checked/unchecked
                    const checkbox = row.querySelector('input[type="checkbox"]');
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            addSelectedTerm(this.value);
                        } else {
                            removeSelectedTerm(this.value);
                        }
                    });
                });
                
                // Handle confirm selection button
                document.getElementById('confirm-selection').addEventListener('click', () => {
                    document.body.removeChild(selectModal);
                });
                
                // Handle close button
                selectModal.querySelector('.close-modal').addEventListener('click', () => {
                    document.body.removeChild(selectModal);
                });
                
                // Handle click outside
                selectModal.addEventListener('click', (e) => {
                    if (e.target === selectModal) {
                        document.body.removeChild(selectModal);
                    }
                });
            });
            
            // Function to add a selected term
            function addSelectedTerm(termId) {
                if (selectedTerms.has(termId)) return;
                
                selectedTerms.add(termId);
                updateSelectedTermsList();
                updateRunButtonState();
            }
            
            // Function to remove a selected term
            function removeSelectedTerm(termId) {
                selectedTerms.delete(termId);
                updateSelectedTermsList();
                updateRunButtonState();
            }
            
            // Function to clear all selected terms
            function clearAllSelectedTerms() {
                selectedTerms.clear();
                updateSelectedTermsList();
                updateRunButtonState();
            }
            
            // Function to select all available terms
            function selectAllTerms() {
                allResults.forEach(result => {
                    selectedTerms.add(result[0]);
                });
                updateSelectedTermsList();
                updateRunButtonState();
            }
            
            // Update the selected terms list display
            function updateSelectedTermsList() {
                if (selectedTerms.size === 0) {
                    selectedTermsList.innerHTML = `<p style="color: var(--text-tertiary); font-style: italic;">No terms selected yet</p>`;
                    return;
                }
                
                selectedTermsList.innerHTML = '';
                selectedTerms.forEach(term => {
                    // Find term details if available in results
                    let termName = '';
                    let termNamespace = '';
                    
                    const termDetails = allResults.find(result => result[0] === term);
                    if (termDetails) {
                        termName = termDetails[1];
                        termNamespace = termDetails[2];
                    }
                    
                    const termElement = document.createElement('div');
                    termElement.className = 'selected-term';
                    termElement.innerHTML = `
                        <div style="display: flex; align-items: center; background: var(--background-color); 
                                    padding: 0.5rem; border-radius: 0.5rem; margin-bottom: 0.5rem;">
                            <div style="flex: 1;">
                                <div style="font-weight: 500;">${term}</div>
                                ${termName ? `<div style="font-size: 0.875rem; color: var(--text-secondary);">${termName}</div>` : ''}
                                ${termNamespace ? `<div style="font-size: 0.75rem; color: var(--text-tertiary);">${termNamespace}</div>` : ''}
                            </div>
                            <button class="remove-term" data-term="${term}" style="background: none; border: none; cursor: pointer; 
                                                                                   color: var(--text-tertiary); font-size: 1.25rem;">
                                &times;
                            </button>
                        </div>
                    `;
                    
                    selectedTermsList.appendChild(termElement);
                    
                    // Add event listener to remove button
                    termElement.querySelector('.remove-term').addEventListener('click', function() {
                        removeSelectedTerm(this.getAttribute('data-term'));
                    });
                });
            }
            
            // Update run button state based on selection
            function updateRunButtonState() {
                runAnalysisButton.disabled = selectedTerms.size < 2;
            }
            
            // Run analysis button handler
            runAnalysisButton.addEventListener('click', async () => {
                // Show loading state
                runAnalysisButton.classList.add('loading');
                
                // Reset the fullscreen container to prevent showing stale data
                const similarityContainer = document.getElementById('similarity-fullscreen-container');
                if (similarityContainer.style.display === 'flex') {
                    // If fullscreen is open, close it
                    similarityContainer.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
                // Clear the fullscreen content
                document.getElementById('fullscreen-similarity-content').innerHTML = '';
                
                try {
                    // Get the selected GO terms
                    const goTerms = Array.from(selectedTerms);
                    
                    // Make an API call to run the taxago command
                    const response = await fetch('/run-ancestor-analysis', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ go_terms: goTerms }),
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to run ancestor analysis');
                    }
                    
                    const result = await response.json();
                    
                    // Show results section
                    document.getElementById('ancestor-analysis-results').style.display = 'block';
                    
                    // Scroll to results
                    document.getElementById('ancestor-analysis-results').scrollIntoView({ behavior: 'smooth' });
                    
                    // Display the results
                    document.getElementById('ancestor-graph-container').innerHTML = `
                        <div style="padding: 1rem; background-color: var(--card-background); border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 1rem;">
                                <div style="display: flex; gap: 0.5rem;">
                                    <div class="info-tooltip">
                                        <button class="info-button">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 16px; height: 16px;">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                            Info
                                        </button>
                                        <span class="tooltip-text">Click on any term box in the graph to open its QuickGO page in a new tab.</span>
                                    </div>
                                    <a href="/ancestor-graph" download="ancestor_graph.pdf" class="fullscreen-button" style="background-color: var(--success-color);">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 16px; height: 16px;">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                        </svg>
                                        Download PDF
                                    </a>
                                    <button class="fullscreen-button" onclick="toggleDiagramFullscreen()">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 16px; height: 16px;">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5" />
                                        </svg>
                                        Fullscreen
                                    </button>
                                </div>
                            </div>
                            <div id="mermaid-diagram" style="width: 100%;  height: auto; overflow: visible;">
                                <div class="loading-indicator" style="display: flex; justify-content: center; align-items: center; height: 300px;">
                                    <div style="display: flex; flex-direction: column; align-items: center;">
                                        <div class="spinner" style="width: 40px; height: 40px; border-width: 4px;"></div>
                                        <p style="margin-top: 1rem; color: var(--text-secondary);">Loading diagram...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Fetch and render the Mermaid diagram
                    fetch('/ancestor-mermaid')
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Failed to fetch Mermaid diagram');
                            }
                            return response.text();
                        })
                        .then(mermaidCode => {
                            const mermaidContainer = document.getElementById('mermaid-diagram');
                            
                            // Check if the response is our special message about no common ancestors
                            if (mermaidCode.trim() === "No common ancestors found between the provided GO terms") {
                                // Hide the download and enlarge options in the container
                                const controlsContainer = document.querySelector('#ancestor-graph-container .fullscreen-button').closest('div');
                                if (controlsContainer) {
                                    controlsContainer.style.display = 'none';
                                }
                                
                                mermaidContainer.innerHTML = `
                                    <div style="padding: 3rem; text-align: center; color: var(--text-secondary); background-color: var(--card-background); border-radius: 0.5rem; min-height: 300px; display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                        <div>
                                            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 1.5rem; color: var(--text-tertiary);">
                                                <path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"></path>
                                                <path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"></path>
                                                <path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"></path>
                                                <line x1="2" y1="2" x2="22" y2="22"></line>
                                            </svg>
                                            <p style="font-size: 1.25rem; font-weight: 500; margin-bottom: 0.75rem;">No Common Ancestors Found</p>
                                            <p style="color: var(--text-tertiary); max-width: 400px; margin: 0 auto; line-height: 1.5;">The selected GO terms do not share any common ancestors in the GO hierarchy. Try selecting terms from the same branch or more closely related biological processes.</p>
                                        </div>
                                    </div>
                                `;
                                return;
                            }
                            
                            mermaidContainer.innerHTML = `<pre class="mermaid" style="overflow: visible; max-width: none; width: auto;">${mermaidCode}</pre>`;
                            
                            // Render the diagram
                            mermaid.run({
                                nodes: document.querySelectorAll('.mermaid')
                            }).then(() => {
                                // After successful rendering, ensure all links open in new tabs
                                setLinksToOpenInNewTab();
                                
                                // Make sure the SVG is fully visible
                                const svgElement = mermaidContainer.querySelector('svg');
                                if (svgElement) {
                                    svgElement.style.maxWidth = 'none';
                                    svgElement.style.width = '100%';
                                    svgElement.style.height = 'auto';
                                    
                                    // Add horizontal scrolling if needed
                                    mermaidContainer.style.overflowX = 'auto';
                                }
                            }).catch(error => {
                                console.error('Error rendering Mermaid diagram:', error);
                                mermaidContainer.innerHTML = `
                                    <div style="padding: 2rem; color: var(--error-color);">
                                        Error rendering diagram. The diagram may be too complex to display in the browser.
                                        <div style="margin-top: 1rem;">
                                            <a href="/ancestor-graph" target="_blank" rel="noopener noreferrer" style="color: var(--primary-color);">View as PDF instead</a>
                                        </div>
                                    </div>
                                `;
                            });
                        })
                        .catch(error => {
                            console.error('Error fetching Mermaid diagram:', error);
                            document.getElementById('mermaid-diagram').innerHTML = `
                                <div style="padding: 2rem; color: var(--error-color);">
                                    Error loading diagram. Please try again.
                                    <div style="margin-top: 1rem;">
                                        <a href="/ancestor-graph" target="_blank" rel="noopener noreferrer" style="color: var(--primary-color);">View as PDF instead</a>
                                    </div>
                                </div>
                            `;
                        });
                } catch (error) {
                    console.error('Error running ancestor analysis:', error);
                    
                    // Show error in results
                    document.getElementById('ancestor-analysis-results').style.display = 'block';
                    document.getElementById('ancestor-graph-container').innerHTML = `
                        <div style="background-color: var(--card-background); padding: 2rem; border-radius: 0.5rem; text-align: center; height: 200px; display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <p style="color: var(--error-color); margin: 0;">Error: Unable to generate graph. Please try again with different GO terms.</p>
                        </div>
                    `;
                } finally {
                    // Hide loading state
                    runAnalysisButton.classList.remove('loading');
                }
            });

            // Reset the form when the modal is closed
            document.getElementById('close-ancestor-modal').addEventListener('click', resetAncestorAnalysisForm);
            document.getElementById('ancestor-analysis-modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('ancestor-analysis-modal')) {
                    resetAncestorAnalysisForm();
                }
            });

            // Function to reset the form
            function resetAncestorAnalysisForm() {
                // Hide the manual GO term entry if it's open
                document.getElementById('manual-go-entry').style.display = 'none';
                
                // Hide the results section if it's visible
                document.getElementById('ancestor-analysis-results').style.display = 'none';
                
                // Clear any error messages
                document.getElementById('go-term-error').style.display = 'none';
                
                // Clear the GO term input
                document.getElementById('go-term-input').value = '';
                
                // Reset the selected terms (optional - comment out if you want to keep the selection)
                // selectedTerms.clear();
                // updateSelectedTermsList();
                // updateRunButtonState();
            }
        }

        // Add this new function to initialize the semantic similarity functionality
        function initializeSemanticSimilarity() {
            // Store selected GO terms
            const selectedTerms = new Set();
            const selectedTermsList = document.getElementById('semantic-selected-terms-list');
            const runAnalysisButton = document.getElementById('run-semantic-similarity');
            
            // Toggle manual GO term entry
            document.getElementById('semantic-enter-go-term-btn').addEventListener('click', () => {
                const manualEntry = document.getElementById('semantic-manual-go-entry');
                manualEntry.style.display = manualEntry.style.display === 'none' ? 'block' : 'none';
            });
            
            // Add GO term from manual entry
            document.getElementById('semantic-add-go-term-btn').addEventListener('click', () => {
                const input = document.getElementById('semantic-go-term-input');
                const errorMsg = document.getElementById('semantic-go-term-error');
                const goTermPattern = /^GO:[0-9]{7}$/;
                
                if (goTermPattern.test(input.value)) {
                    addSelectedTerm(input.value);
                    input.value = '';
                    errorMsg.style.display = 'none';
                } else {
                    errorMsg.style.display = 'block';
                }
            });

            // Also allow pressing Enter to add a GO term
            document.getElementById('semantic-go-term-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    document.getElementById('semantic-add-go-term-btn').click();
                }
            });
            
            // Clear all terms button handler
            document.getElementById('semantic-clear-all-terms-btn').addEventListener('click', () => {
                clearAllSelectedTerms();
            });
            
            // Select all terms button handler
            document.getElementById('semantic-select-all-terms-btn').addEventListener('click', () => {
                selectAllTerms();
            });
            
            // Select from results button handler
            document.getElementById('semantic-select-from-results-btn').addEventListener('click', () => {
                // Create a temporary modal to select terms from results
                const selectModal = document.createElement('div');
                selectModal.className = 'modal active';
                selectModal.innerHTML = `
                    <div class="modal-content" style="width: 80%; max-width: 1000px;">
                        <span class="close-modal">&times;</span>
                        <div class="title" style="font-size: 1.25rem; margin-bottom: 1rem;">Select GO Terms</div>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                            Select GO terms from your results to include in the semantic similarity analysis.
                        </p>
                        <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                            <table class="results-table">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;"></th>
                                        <th>GO Term ID</th>
                                        <th>Name</th>
                                        <th>Namespace</th>
                                    </tr>
                                </thead>
                                <tbody id="term-selection-body">
                                    <!-- Will be populated with results -->
                                </tbody>
                            </table>
                        </div>
                        <button class="primary-button" id="confirm-selection" style="margin-top: 1rem;">
                            Confirm Selection
                        </button>
                    </div>
                `;
                
                document.body.appendChild(selectModal);
                
                // Populate the table with results
                const selectionBody = document.getElementById('term-selection-body');
                allResults.forEach(result => {
                    const row = document.createElement('tr');
                    const isSelected = selectedTerms.has(result[0]);
                    
                    row.innerHTML = `
                        <td>
                            <input type="checkbox" class="species-selection-checkbox" value="${result[0]}" 
                                   ${isSelected ? 'checked' : ''}>
                        </td>
                        <td>${result[0]}</td>
                        <td>${result[1]}</td>
                        <td>${result[2]}</td>
                    `;
                    
                    selectionBody.appendChild(row);
                    
                    // Add event listener to checkbox to automatically add/remove terms when checked/unchecked
                    const checkbox = row.querySelector('input[type="checkbox"]');
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            addSelectedTerm(this.value);
                        } else {
                            removeSelectedTerm(this.value);
                        }
                    });
                });
                
                // Handle confirm selection button
                document.getElementById('confirm-selection').addEventListener('click', () => {
                    document.body.removeChild(selectModal);
                });
                
                // Handle close button
                selectModal.querySelector('.close-modal').addEventListener('click', () => {
                    document.body.removeChild(selectModal);
                });
                
                // Handle click outside
                selectModal.addEventListener('click', (e) => {
                    if (e.target === selectModal) {
                        document.body.removeChild(selectModal);
                    }
                });
            });
            
            // Function to add a selected term
            function addSelectedTerm(termId) {
                if (selectedTerms.has(termId)) return;
                
                selectedTerms.add(termId);
                updateSelectedTermsList();
                updateRunButtonState();
            }
            
            // Function to remove a selected term
            function removeSelectedTerm(termId) {
                selectedTerms.delete(termId);
                updateSelectedTermsList();
                updateRunButtonState();
            }
            
            // Function to clear all selected terms
            function clearAllSelectedTerms() {
                selectedTerms.clear();
                updateSelectedTermsList();
                updateRunButtonState();
            }
            
            // Function to select all available terms
            function selectAllTerms() {
                allResults.forEach(result => {
                    selectedTerms.add(result[0]);
                });
                updateSelectedTermsList();
                updateRunButtonState();
            }
            
            // Update the selected terms list display
            function updateSelectedTermsList() {
                if (selectedTerms.size === 0) {
                    selectedTermsList.innerHTML = `<p style="color: var(--text-tertiary); font-style: italic;">No terms selected yet</p>`;
                    return;
                }
                
                selectedTermsList.innerHTML = '';
                selectedTerms.forEach(term => {
                    // Find term details if available in results
                    let termName = '';
                    let termNamespace = '';
                    
                    const termDetails = allResults.find(result => result[0] === term);
                    if (termDetails) {
                        termName = termDetails[1];
                        termNamespace = termDetails[2];
                    }
                    
                    const termElement = document.createElement('div');
                    termElement.className = 'selected-term';
                    termElement.innerHTML = `
                        <div style="display: flex; align-items: center; background: var(--background-color); 
                                    padding: 0.5rem; border-radius: 0.5rem; margin-bottom: 0.5rem;">
                            <div style="flex: 1;">
                                <div style="font-weight: 500;">${term}</div>
                                ${termName ? `<div style="font-size: 0.875rem; color: var(--text-secondary);">${termName}</div>` : ''}
                                ${termNamespace ? `<div style="font-size: 0.75rem; color: var(--text-tertiary);">${termNamespace}</div>` : ''}
                            </div>
                            <button class="remove-term" data-term="${term}" style="background: none; border: none; cursor: pointer; 
                                                                                   color: var(--text-tertiary); font-size: 1.25rem;">
                                &times;
                            </button>
                        </div>
                    `;
                    
                    selectedTermsList.appendChild(termElement);
                    
                    // Add event listener to remove button
                    termElement.querySelector('.remove-term').addEventListener('click', function() {
                        removeSelectedTerm(this.getAttribute('data-term'));
                    });
                });
            }
            
            // Update run button state based on selection
            function updateRunButtonState() {
                runAnalysisButton.disabled = selectedTerms.size < 2;
            }
            
            // Run analysis button handler
            runAnalysisButton.addEventListener('click', async () => {
                // Show loading state
                runAnalysisButton.classList.add('loading');
                
                // Reset the fullscreen container to prevent showing stale data
                const similarityContainer = document.getElementById('similarity-fullscreen-container');
                if (similarityContainer.style.display === 'flex') {
                    // If fullscreen is open, close it
                    similarityContainer.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
                // Clear the fullscreen content
                document.getElementById('fullscreen-similarity-content').innerHTML = '';
                
                try {
                    // Get the selected GO terms
                    const goTerms = Array.from(selectedTerms);
                    
                    // Get the selected similarity method
                    const similarityMethod = document.querySelector('input[name="similarity-method"]:checked').value;
                    
                    // Make an API call to run the semantic similarity analysis
                    const response = await fetch('/run-semantic-similarity', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            go_terms: goTerms,
                            method: similarityMethod
                        }),
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to run semantic similarity analysis');
                    }
                    
                    const result = await response.json();
                    
                    // Show results section
                    document.getElementById('semantic-similarity-results').style.display = 'block';
                    
                    // Scroll to results
                    document.getElementById('semantic-similarity-results').scrollIntoView({ behavior: 'smooth' });
                    
                    // Display the results
                    const resultsContainer = document.getElementById('similarity-results-container');
                    
                    // Create a heatmap or table to display similarity scores
                    resultsContainer.innerHTML = `
                        <div style="background-color: var(--card-background); padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h4 style="margin: 0;">Similarity Scores (${similarityMethod})</h4>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="fullscreen-button" id="download-small-similarity-csv" style="background-color: var(--success-color);">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 16px; height: 16px;">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                        </svg>
                                        Download CSV
                                    </button>
                                    <button class="fullscreen-button" id="toggle-similarity-fullscreen">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 16px; height: 16px;">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5" />
                                        </svg>
                                        Fullscreen
                                    </button>
                                </div>
                            </div>
                            <div class="similarity-table-container">
                                <table class="similarity-table" style="width: 100%; min-width: 600px; border-collapse: collapse;">
                                    <thead>
                                        <tr>
                                            <th class="corner-header">GO Term</th>
                                            ${goTerms.map(term => `<th style="padding: 0.75rem; text-align: center; border-bottom: 1px solid var(--border-color); min-width: 120px;">${term}</th>`).join('')}
                                        </tr>
                                    </thead>
                                    <tbody id="similarity-table-body">
                                        ${goTerms.map(term1 => `
                                            <tr>
                                                <td style="padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border-color); font-weight: 500; background-color: var(--card-background); min-width: 120px;">${term1}</td>
                                                ${goTerms.map(term2 => {
                                                    const score = result.similarityScores[`${term1}-${term2}`] || 
                                                                 result.similarityScores[`${term2}-${term1}`] || 
                                                                 (term1 === term2 ? 1 : 0);
                                                    
                                                    // Color gradient based on score (0 to 1)
                                                    const intensity = Math.min(Math.max(score, 0), 1);
                                                    const backgroundColor = term1 === term2 ? 
                                                        'var(--primary-color-light)' : 
                                                        `rgba(79, 70, 229, ${intensity * 0.2})`;
                                                    
                                                    return `<td style="padding: 0.75rem; text-align: center; border-bottom: 1px solid var(--border-color); background-color: ${backgroundColor}; min-width: 120px;">
                                                        ${score.toFixed(4)}
                                                    </td>`;
                                                }).join('')}
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                    
                    // Add event listener for the download button in the small table
                    const smallDownloadButton = document.getElementById('download-small-similarity-csv');
                    // Remove any existing event listeners by cloning and replacing the button
                    if (smallDownloadButton) {
                        const newSmallDownloadButton = smallDownloadButton.cloneNode(true);
                        smallDownloadButton.parentNode.replaceChild(newSmallDownloadButton, smallDownloadButton);
                        
                        // Add fresh event listener that gets the current table
                        newSmallDownloadButton.addEventListener('click', function() {
                            // Always get the current table when clicked
                            const currentTable = document.querySelector('.similarity-table');
                            downloadSimilarityCSVFromTable(currentTable);
                        });
                    }
                    
                    // Add event listener for the fullscreen button
                    const fullscreenButton = document.getElementById('toggle-similarity-fullscreen');
                    if (fullscreenButton) {
                        const newFullscreenButton = fullscreenButton.cloneNode(true);
                        fullscreenButton.parentNode.replaceChild(newFullscreenButton, fullscreenButton);
                        
                        // Add fresh event listener
                        newFullscreenButton.addEventListener('click', toggleSimilarityFullscreen);
                    }
                    
                } catch (error) {
                    console.error('Error running semantic similarity analysis:', error);
                    
                    // Show error in results
                    document.getElementById('semantic-similarity-results').style.display = 'block';
                    document.getElementById('similarity-results-container').innerHTML = `
                        <div style="background-color: var(--card-background); padding: 2rem; border-radius: 0.5rem; text-align: center; min-height: 200px; display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <p style="color: var(--error-color); margin: 0;">Error: Unable to calculate semantic similarity. Please try again with different GO terms.</p>
                        </div>
                    `;
                } finally {
                    // Hide loading state
                    runAnalysisButton.classList.remove('loading');
                }
            });

            // Reset the form when the modal is closed
            document.getElementById('close-semantic-modal').addEventListener('click', resetSemanticSimilarityForm);
            document.getElementById('semantic-similarity-modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('semantic-similarity-modal')) {
                    resetSemanticSimilarityForm();
                }
            });

            // Function to reset the form
            function resetSemanticSimilarityForm() {
                // Hide the manual GO term entry if it's open
                document.getElementById('semantic-manual-go-entry').style.display = 'none';
                
                // Hide the results section if it's visible
                document.getElementById('semantic-similarity-results').style.display = 'none';
                
                // Clear any error messages
                document.getElementById('semantic-go-term-error').style.display = 'none';
                
                // Clear the GO term input
                document.getElementById('semantic-go-term-input').value = '';
                
                // Reset the similarity method to default (Resnik)
                document.querySelector('input[name="similarity-method"][value="resnik"]').checked = true;
                
                // Reset the selected terms (optional)
                // selectedTerms.clear();
                // updateSelectedTermsList();
                // updateRunButtonState();
            }
        }
    </script>
</body>
</html>
